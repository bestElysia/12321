<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ— å°½ä¿®ä»™ï¼šé“æ³•è‡ªç„¶</title>
    <style>
        /* =========================================
           CSS æ ·å¼è¡¨
           ========================================= */
        :root {
            --bg-color: #050505;
            --panel-bg: rgba(20, 20, 30, 0.98);
            --primary-gold: #ffc107;
            --primary-green: #4caf50;
            --danger-red: #ff3b30;
            --demon-purple: #9c27b0;
            --text-main: #e0e0e0;
            --text-dim: #757575;
            --border-color: #333;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            overflow: hidden;
            height: 100vh;
            display: flex;
            justify-content: center;
        }

        .bg-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }

        #app {
            position: relative; z-index: 10; width: 100%; max-width: 600px; height: 100%;
            display: flex; flex-direction: column;
            background: radial-gradient(circle at center, rgba(30,30,40,0.3) 0%, rgba(0,0,0,1) 100%);
        }

        /* --- é¡¶éƒ¨ --- */
        header {
            padding: 15px; border-bottom: 1px solid var(--border-color);
            background: rgba(10, 10, 15, 0.9);
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        .spirit-box { text-align: right; }
        .spirit-val { font-family: 'Courier New', monospace; font-size: 1.4rem; color: var(--primary-green); font-weight: bold; }
        .spirit-rate { font-size: 0.7rem; color: #666; }

        /* --- ç‚¹å‡»åŒº --- */
        #click-area {
            flex: 1; position: relative; display: flex; flex-direction: column;
            justify-content: center; align-items: center; cursor: pointer;
        }
        /* å¢åŠ é•¿æŒ‰çš„è§†è§‰åé¦ˆ */
        #click-area:active .avatar-container { transform: scale(0.95); box-shadow: 0 0 30px var(--primary-gold); }

        .avatar-container {
            width: 220px; height: 220px; border-radius: 50%;
            border: 2px solid var(--border-color);
            display: flex; justify-content: center; align-items: center;
            position: relative; transition: all 0.1s;
            background: radial-gradient(circle, #2a2a2a, #000);
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        .meditate-icon { font-size: 5rem; filter: drop-shadow(0 0 5px rgba(255,255,255,0.2)); }
        
        .realm-tag {
            position: absolute; bottom: -15px;
            background: #000; border: 1px solid var(--primary-gold); color: var(--primary-gold);
            padding: 4px 12px; border-radius: 12px; font-size: 0.9rem; font-weight: bold;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        /* --- åº•éƒ¨é¢æ¿ --- */
        #panel-container { height: 50%; background: var(--panel-bg); border-top: 1px solid var(--border-color); display: flex; flex-direction: column; }
        
        .tabs { display: flex; background: rgba(0,0,0,0.5); }
        .tab-btn {
            flex: 1; padding: 15px; background: transparent; border: none; color: var(--text-dim);
            border-bottom: 2px solid transparent; font-size: 1rem; cursor: pointer;
        }
        .tab-btn.active { color: var(--primary-gold); border-bottom-color: var(--primary-gold); background: rgba(255, 215, 0, 0.05); }

        .tab-content { flex: 1; overflow-y: auto; padding: 15px; display: none; }
        .tab-content.show { display: block; }

        /* åˆ—è¡¨é¡¹ */
        .list-item {
            background: rgba(255,255,255,0.03); border: 1px solid var(--border-color);
            padding: 12px; margin-bottom: 8px; border-radius: 6px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .jp-title { color: #e91e63; text-shadow: 0 0 5px #e91e63; }
        .upgrade-btn {
            background: transparent; color: var(--primary-green); border: 1px solid var(--primary-green);
            padding: 6px 12px; border-radius: 4px; font-size: 0.8rem;
        }
        .upgrade-btn:disabled { border-color: #444; color: #444; }
        .upgrade-btn.maxed { border-color: var(--primary-gold); color: var(--primary-gold); }

        /* çªç ´æŒ‰é’® */
        #breakthrough-area { text-align: center; margin-top: 20px; }
        .btn-main {
            width: 100%; padding: 15px; border: none; font-size: 1.1rem; font-weight: bold; border-radius: 8px; margin-top: 15px; cursor: pointer;
        }
        .btn-upgrade { background: var(--primary-green); color: #000; box-shadow: 0 0 15px rgba(76, 175, 80, 0.4); }
        .btn-tribulation { 
            background: linear-gradient(45deg, #d32f2f, #b71c1c); color: #fff; 
            box-shadow: 0 0 20px rgba(211, 47, 47, 0.6); animation: pulse 1.5s infinite;
        }

        /* --- æµ®åŠ¨æ–‡å­— --- */
        .float-text {
            position: absolute; color: #fff; font-weight: bold; pointer-events: none;
            animation: floatUp 0.8s forwards; font-size: 1.2rem; text-shadow: 1px 1px 2px black; z-index: 100;
        }

        /* --- æ¸¡åŠ«ç‰¹æ•ˆå±‚ --- */
        #tribulation-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 2000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        /* å¿ƒé­”æ¨¡å¼ */
        .xinmo-mode {
            background: radial-gradient(circle, #300000, #000);
        }
        .xinmo-text {
            color: var(--danger-red); font-family: "Creepster", cursive, sans-serif;
            text-shadow: 2px 2px 0px #000; animation: shake 0.5s infinite;
        }

        .thunder-bolt {
            position: absolute; top: 0; left: 50%; width: 6px; height: 100%;
            background: #fff; box-shadow: 0 0 20px #fff, 0 0 50px #00bcd4;
            transform: translateX(-50%) scaleY(0); transform-origin: top; opacity: 0;
        }
        .thunder-strike { animation: strike 0.15s; }

        @keyframes floatUp { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-60px); opacity: 0; } }
        @keyframes strike { 0% { transform: translateX(-50%) scaleY(0); opacity: 1; } 50% { transform: translateX(-50%) scaleY(1); opacity: 1; } 100% { transform: translateX(-50%) scaleY(1); opacity: 0; } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
        @keyframes shake { 0% { transform: translate(1px, 1px); } 25% { transform: translate(-1px, -2px); } 50% { transform: translate(-3px, 0px); } 75% { transform: translate(3px, 2px); } 100% { transform: translate(1px, -1px); } }

        .hidden { display: none !important; }
        
        /* æ¨¡æ€æ¡†é€šç”¨ */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85);
            display: flex; justify-content: center; align-items: center; z-index: 3000; backdrop-filter: blur(5px);
        }
        .modal-box {
            background: #1a1a1a; padding: 30px; border-radius: 10px; border: 1px solid var(--primary-gold);
            text-align: center; width: 80%; max-width: 400px;
        }
        input { background: #333; border: 1px solid #555; color: white; padding: 10px; margin: 15px 0; width: 80%; text-align: center; font-size: 1.1rem; }
    </style>
</head>
<body>

    <canvas id="bgCanvas" class="bg-canvas"></canvas>

    <div id="app">
        <header>
            <div class="player-info">
                <div style="font-size: 1.1rem; color: var(--primary-gold);" id="player-name">é“å‹</div>
                <div style="font-size: 0.8rem; color: #aaa;">å·²è½®å› <span id="reincarnate-count">0</span> ä¸–</div>
            </div>
            <div class="spirit-box">
                <div class="spirit-val" id="spirit-disp">0</div>
                <div class="spirit-rate">çµåŠ›å€¼</div>
            </div>
        </header>

        <div id="click-area">
            <div class="avatar-container" id="avatar">
                <div class="meditate-icon">ğŸ§˜â€â™‚ï¸</div>
                <div class="realm-tag" id="realm-disp">ç‚¼æ°”æœŸ ä¸€å±‚</div>
            </div>
            <p style="margin-top: 40px; color: #555; font-size: 0.85rem;">
                <span style="color:var(--primary-green)">ç‚¹å‡»</span> æˆ– <span style="color:var(--primary-green)">é•¿æŒ‰</span> å±å¹•å¸çº³å¤©åœ°çµæ°”
            </p>
        </div>

        <div id="panel-container">
            <div class="tabs">
                <button class="tab-btn active" onclick="ui.switchTab('skills')">åŠŸæ³•é˜</button>
                <button class="tab-btn" onclick="ui.switchTab('realm')">å¢ƒç•Œçªç ´</button>
                <button class="tab-btn" onclick="ui.switchTab('log')">ä»™é€”å¿—</button>
            </div>

            <div id="tab-skills" class="tab-content show">
                <div style="font-size:0.8rem; color:#666; margin-bottom:10px; text-align:center;">
                    ä¿®ä¹ åŠŸæ³•å¯æŒ‡æ•°çº§å¢åŠ çµåŠ›è·å–ã€‚<br>æ¯æœ¬åŠŸæ³• <span style="color:var(--primary-gold)">åœ†æ»¡(Lv.100)</span> å¢åŠ æ¸¡åŠ«æˆåŠŸç‡ã€‚
                </div>
                <div id="skills-list"></div>
            </div>

            <div id="tab-realm" class="tab-content">
                <div id="breakthrough-area">
                    <h2 style="color: var(--primary-gold); margin: 0 0 10px 0;" id="next-realm-name">ä¸‹ä¸€å¢ƒç•Œï¼šç­‘åŸºæœŸ</h2>
                    <p style="color: #888; font-size: 0.9rem;" id="req-text">æ‰€éœ€çµåŠ›: 1,000</p>
                    
                    <button id="btn-upgrade" class="btn-main btn-upgrade" onclick="game.upgradeRealm()">
                        çªç ´ç“¶é¢ˆ
                    </button>

                    <button id="btn-tribulation" class="btn-main btn-tribulation hidden" onclick="game.startTribulation()">
                        å¼•åŠ¨å¤©åŠ« (é€†å¤©æ”¹å‘½)
                    </button>
                    
                    <p id="tribulation-hint" class="hidden" style="margin-top: 15px; font-size: 0.8rem; color: #ff5252;">
                        æ³¨æ„ï¼šå¤©åŠ«ä¹æ­»ä¸€ç”Ÿï¼ŒåŒ…å«ä¹é“å¤©é›·ä¸ä¸€é“å¿ƒé­”ã€‚<br>
                        è‹¥æ— ä¸‡å…¨å‡†å¤‡ï¼Œèº«æ­»é“æ¶ˆï¼<br>
                        (æç¤ºï¼šä¿®æ»¡åŠŸæ³•å¯æå‡æˆåŠŸç‡ï¼Œå…¨éƒ¨åœ†æ»¡å¿…æˆ)
                    </p>
                </div>
            </div>

            <div id="tab-log" class="tab-content">
                <div id="gamelog" style="font-size: 0.8rem; line-height: 1.6; color: #aaa;"></div>
            </div>
        </div>
    </div>

    <div id="modal-start" class="modal">
        <div class="modal-box">
            <h2 style="color: var(--primary-gold)">è¸å…¥ä»™é€”</h2>
            <p style="color: #888">å‡¡äººä¸€ç”Ÿï¼Œä¸è¿‡ç™¾å¹´ã€‚<br>ä»Šæ—¥å…¥æˆ‘ä»™é—¨ï¼Œå½“æ±‚é•¿ç”Ÿã€‚</p>
            <input type="text" id="inp-name" placeholder="è¯·è¾“å…¥é“å·" maxlength="6">
            <button class="btn-main btn-upgrade" onclick="game.startGame()">å¼€å§‹ä¿®ç‚¼</button>
        </div>
    </div>

    <div id="tribulation-overlay" class="hidden">
        <div class="thunder-bolt" id="thunder-vfx"></div>
        <div style="z-index: 2002; text-align: center; width: 80%;">
            <h1 id="trib-title" style="color: #ffeb3b; text-shadow: 0 0 20px red; font-size: 2.5rem;">å¤©åŠ«é™ä¸´</h1>
            <h3 id="trib-step" style="color: white;">å‡†å¤‡æŠ—å‡»å¤©é›·...</h3>
            <div id="trib-console" style="height: 150px; overflow-y: scroll; background: rgba(0,0,0,0.6); border: 1px solid #444; padding: 10px; font-size: 0.8rem; text-align: left; margin-top: 20px;"></div>
        </div>
    </div>

    <div id="modal-end" class="modal hidden">
        <div class="modal-box">
            <h1 id="end-title" style="color: #ff3b30">é™¨è½</h1>
            <p id="end-desc">ä½ åœ¨å¿ƒé­”åŠ«ä¸­è¿·å¤±äº†è‡ªæˆ‘...</p>
            <button class="btn-main btn-upgrade" onclick="game.reincarnate()">è½®å›è½¬ä¸–</button>
        </div>
    </div>

<script>
/**
 * ==========================================================
 * æ¸¸æˆé…ç½®ä¸æ ¸å¿ƒæ•°æ®
 * ==========================================================
 */
const CONFIG = {
    // å¢ƒç•Œåˆ’åˆ†ï¼šæ ‡å‡†ä¿®ä»™ä½“ç³»
    // req: å‡çº§æ‰€éœ€çµåŠ›, mult: è¯¥å¢ƒç•Œçš„åŸºç¡€çµåŠ›å€ç‡
    REALMS: [
        { name: "ç‚¼æ°”æœŸ", req: 1000, mult: 1 },                 // Index 0
        { name: "ç­‘åŸºæœŸ", req: 50000, mult: 10 },               // Index 1
        { name: "é‡‘ä¸¹æœŸ", req: 500000, mult: 50 },              // Index 2
        { name: "å…ƒå©´æœŸ", req: 5000000, mult: 200 },            // Index 3
        { name: "åŒ–ç¥æœŸ", req: 100000000, mult: 1000 },         // Index 4
        { name: "ç‚¼è™šæœŸ", req: 5000000000, mult: 5000 },        // Index 5
        { name: "åˆä½“æœŸ", req: 200000000000, mult: 20000 },     // Index 6
        { name: "å¤§ä¹˜æœŸ", req: 1000000000000, mult: 100000 },   // Index 7
        { name: "æ¸¡åŠ«æœŸ", req: 10000000000000, mult: 500000 },  // Index 8 (åˆ°è¾¾è¿™é‡Œåï¼Œä¸‹ä¸€æ­¥æ˜¯æ¸¡åŠ«)
        { name: "çœŸä»™ (é£å‡)", req: 0, mult: 9999999 }            // Index 9 (ç»ˆç‚¹)
    ],
    // åŠŸæ³•ï¼šæŒ‡æ•°çº§å¢é•¿çš„æ ¸å¿ƒ
    // cost: åŸºç¡€ä»·æ ¼, costFactor: ä»·æ ¼å¢é•¿ç³»æ•°, powerFactor: æ•ˆæœå¢é•¿ç³»æ•°(å¤åˆ©)
    SKILLS: [
        { id: 0, name: "é•¿æ˜¥åŠŸ", cost: 100, costMult: 1.5, power: 1.1, desc: "åˆçº§å…»æ°”ï¼Œå°‘é‡æå‡æ•ˆç‡" },
        { id: 1, name: "åå¿˜ç»", cost: 5000, costMult: 1.6, power: 1.15, desc: "å¿ƒå¦‚æ­¢æ°´ï¼Œä¿®ç‚¼é€Ÿåº¦åŠ å¿«" },
        { id: 2, name: "çº¯é˜³æ— æåŠŸ", cost: 100000, costMult: 1.7, power: 1.2, desc: "çº¯é˜³ä¹‹æ°”ï¼ŒçµåŠ›æˆå€å¢é•¿" },
        { id: 3, name: "å¤ªä¸Šæ„Ÿåº”ç¯‡", cost: 5000000, costMult: 1.8, power: 1.25, desc: "æ„Ÿåº”å¤©é“ï¼Œå¤ºå¤©åœ°é€ åŒ–" },
        { id: 4, name: "ä¹è½¬é‡‘èº«è¯€", cost: 200000000, costMult: 1.9, power: 1.3, desc: "è‚‰èº«æˆåœ£ï¼ŒçµåŠ›æºæºä¸ç»" },
        { id: 5, name: "æ··æ²Œè¡ä¸–å½•", cost: 10000000000, costMult: 2.0, power: 1.4, desc: "é‡æ¼”æ··æ²Œï¼Œæ•°å€¼çˆ†ç‚¸å¢é•¿" }
    ]
};

const game = {
    data: {
        name: "æ— å",
        spirit: 0,
        realmIdx: 0,
        skills: [], // {id:0, level:0}
        reincarnationCount: 0,
        isTribulating: false
    },
    timers: {
        autoClick: null
    },

    init() {
        // åˆå§‹åŒ–åŠŸæ³•æ•°æ®
        this.data.skills = CONFIG.SKILLS.map(s => ({ id: s.id, level: 0 }));
        ui.init();
        this.startLoop();
    },

    startGame() {
        const name = document.getElementById('inp-name').value.trim();
        if(name) this.data.name = name;
        document.getElementById('modal-start').classList.add('hidden');
        ui.log(`æ¬¢è¿é“å‹ <b>${this.data.name}</b> è¸å…¥ä»™é€”ï¼`);
        ui.render();
    },

    // --- æ ¸å¿ƒæ•°å€¼é€»è¾‘ ---

    // è®¡ç®—ç‚¹å‡»ä¸€æ¬¡è·å¾—çš„çµåŠ› (æŒ‡æ•°çº§)
    // å…¬å¼: åŸºç¡€(1) * å¢ƒç•Œå€ç‡ * (åŠŸæ³•1å€ç‡^ç­‰çº§ * åŠŸæ³•2å€ç‡^ç­‰çº§ ...)
    getClickPower() {
        let skillMult = 1;
        this.data.skills.forEach((s, idx) => {
            if(s.level > 0) {
                const config = CONFIG.SKILLS[idx];
                skillMult *= Math.pow(config.power, s.level);
            }
        });
        
        const realmMult = CONFIG.REALMS[this.data.realmIdx].mult;
        return 1 * realmMult * skillMult;
    },

    // ç‚¹å‡»/é•¿æŒ‰å¤„ç†
    clickAction(e) {
        if (this.data.isTribulating) return;

        const gain = this.getClickPower();
        this.data.spirit += gain;
        
        // è§†è§‰
        if(e && e.isTrusted) { // é˜²æ­¢è„šæœ¬è¿‡å¿«è§¦å‘ç‰¹æ•ˆ
            ui.showFloatText(e.clientX, e.clientY, gain);
            ui.bgParticle(e.clientX, e.clientY);
        }
        
        ui.updateSpiritDisplay();
        ui.checkButtons(); // æ£€æŸ¥æŒ‰é’®æ˜¯å¦å¯ç”¨
    },

    // å‡çº§åŠŸæ³•
    upgradeSkill(idx) {
        const skill = this.data.skills[idx];
        const config = CONFIG.SKILLS[idx];
        
        // ä»·æ ¼å…¬å¼: Base * CostMult ^ Level
        const cost = config.cost * Math.pow(config.costMult, skill.level);
        
        if (this.data.spirit >= cost && skill.level < 100) {
            this.data.spirit -= cost;
            skill.level++;
            ui.renderSkills();
            ui.render();
            
            if(skill.level === 100) ui.log(`æ­å–œï¼ã€Š${config.name}ã€‹å·²ä¿®ç‚¼è‡³å¤§åœ†æ»¡ï¼æ¸¡åŠ«æ¦‚ç‡æå‡ã€‚`, 'gold');
        }
    },

    // å¢ƒç•Œæå‡é€»è¾‘
    upgradeRealm() {
        const currentRealm = CONFIG.REALMS[this.data.realmIdx];
        
        // å¦‚æœä¸æ˜¯æ¸¡åŠ«æœŸï¼Œç›´æ¥å‡çº§
        if (this.data.realmIdx < 8) {
            if (this.data.spirit >= currentRealm.req) {
                this.data.spirit -= currentRealm.req;
                this.data.realmIdx++;
                ui.log(`ç“¶é¢ˆçªç ´ï¼æ™‹å‡è‡³ [${CONFIG.REALMS[this.data.realmIdx].name}]`, 'green');
                ui.render();
            }
        }
    },

    // --- æ¸¡åŠ«ç³»ç»Ÿ (é‡ç‚¹) ---
    startTribulation() {
        const currentRealm = CONFIG.REALMS[this.data.realmIdx];
        if (this.data.spirit < currentRealm.req) return;

        // é”å®šçŠ¶æ€
        this.data.isTribulating = true;
        
        // UI åˆ‡æ¢
        const overlay = document.getElementById('tribulation-overlay');
        overlay.classList.remove('hidden');
        overlay.classList.remove('xinmo-mode');
        document.getElementById('trib-console').innerHTML = '';
        
        this.runTribulationSequence();
    },

    async runTribulationSequence() {
        const logBox = document.getElementById('trib-console');
        const title = document.getElementById('trib-title');
        const sub = document.getElementById('trib-step');
        const thunder = document.getElementById('thunder-vfx');

        const addTribLog = (msg, color='white') => {
            const p = document.createElement('div');
            p.innerHTML = msg;
            p.style.color = color;
            logBox.appendChild(p);
            logBox.scrollTop = logBox.scrollHeight;
        };

        // è®¡ç®—æˆåŠŸç‡
        // åŸºç¡€å¤±è´¥ç‡ 30% -> æˆåŠŸç‡ 70%
        // æ¯ä¸ªæ»¡çº§åŠŸæ³• +1%
        let successBase = 0.70;
        const maxedCount = this.data.skills.filter(s => s.level >= 100).length;
        const totalSkills = this.data.skills.length;
        
        let finalSuccessRate = successBase + (maxedCount * 0.01);
        
        // ç‰¹æ®Šè§„åˆ™ï¼šå…¨éƒ¨åŠŸæ³•åœ†æ»¡ï¼Œå¿…å®šæˆåŠŸ
        if (maxedCount === totalSkills) {
            finalSuccessRate = 1.1; // > 100%
            addTribLog("æ£€æµ‹åˆ°é“å‹åŠŸå¾·åœ†æ»¡ï¼Œä¸‡æ³•å½’ä¸€ï¼Œå¤©é“æŠ¤ä½‘ï¼", "#ffd700");
        }

        // 1. ä¹é“å¤©é›·
        for(let i=1; i<=9; i++) {
            sub.innerText = `æ­£åœ¨æŠµå¾¡ç¬¬ ${i}/9 é“å¤©é›·`;
            await this.sleep(800);
            
            // è§†è§‰ï¼šé›·åŠˆ
            thunder.classList.add('thunder-strike');
            setTimeout(()=>thunder.classList.remove('thunder-strike'), 150);
            
            // ç®€å•åˆ¤å®šï¼šå¤©é›·é˜¶æ®µåªçœ‹è¡¨æ¼”ï¼Œä¸åˆ¤å®šå¤±è´¥ï¼Œå¤±è´¥åœ¨æœ€ååˆ¤å®š
            addTribLog(`ç¬¬ ${i} é“å¤©é›·è½ä¸‹ï¼ä½ è¿åŠŸç¡¬æŠ—...`, '#00bcd4');
        }

        await this.sleep(1000);

        // 2. å¿ƒé­”åŠ«
        document.getElementById('tribulation-overlay').classList.add('xinmo-mode');
        title.innerText = "å¿ƒé­”é™ä¸´";
        title.classList.add('xinmo-text');
        sub.innerText = "é“å¿ƒæ˜¯å¦åšå®šï¼Ÿ";
        
        addTribLog("å¤©åœ°å˜è‰²ï¼Œå¿ƒé­”æ»‹ç”Ÿ...", "#ff3b30");
        addTribLog("è¿‡å¾€æ‰§å¿µåŒ–ä½œå‰é¬¼ç´¢å‘½...", "#ff3b30");
        
        await this.sleep(2000);

        // 3. æœ€ç»ˆåˆ¤å®š
        const roll = Math.random();
        console.log(`Roll: ${roll}, Rate: ${finalSuccessRate}`);

        if (roll < finalSuccessRate) {
            // æˆåŠŸ
            addTribLog("ä¸€é“é‡‘å…‰ç ´å¼€äº‘é›¾ï¼Œå¿ƒé­”æ¶ˆæ•£ï¼", "#4caf50");
            await this.sleep(1000);
            this.handleSuccess();
        } else {
            // å¤±è´¥
            addTribLog("é“å¿ƒå¤±å®ˆï¼Œä¸‡åŠ«ä¸å¤ï¼", "#ff0000");
            await this.sleep(1000);
            this.handleDeath();
        }
    },

    handleSuccess() {
        this.data.isTribulating = false;
        document.getElementById('tribulation-overlay').classList.add('hidden');
        
        // æ™‹å‡
        this.data.spirit -= CONFIG.REALMS[8].req; // æ‰£é™¤æ¸¡åŠ«æœŸçµåŠ›
        this.data.realmIdx++; // å˜ä¸ºçœŸä»™
        
        const modal = document.getElementById('modal-end');
        modal.classList.remove('hidden');
        document.getElementById('end-title').innerText = "é£å‡è¯é“";
        document.getElementById('end-title').style.color = "#ffd700";
        document.getElementById('end-desc').innerHTML = `æ­å–œ <b>${this.data.name}</b> å†ç»ç£¨éš¾ï¼Œç»ˆæˆæ­£æœï¼<br>ä½åˆ—ä»™ç­ï¼Œä»æ­¤ä¸å¤©åœ°åŒå¯¿ã€‚`;
    },

    handleDeath() {
        this.data.isTribulating = false;
        document.getElementById('tribulation-overlay').classList.add('hidden');

        const modal = document.getElementById('modal-end');
        modal.classList.remove('hidden');
        document.getElementById('end-title').innerText = "é“æ¶ˆèº«æ­»";
        document.getElementById('end-title').style.color = "#ff3b30";
        document.getElementById('end-desc').innerText = "å¤©é“æ— æƒ…ï¼Œé‡å¤´æ¥è¿‡å§ã€‚";
    },

    reincarnate() {
        // è½®å›ï¼šé‡ç½®å¢ƒç•Œã€çµåŠ›ï¼Œä¿ç•™20%åŠŸæ³•ç­‰çº§ï¼ˆå‘ä¸‹å–æ•´ï¼‰
        this.data.reincarnationCount++;
        this.data.spirit = 0;
        this.data.realmIdx = 0;
        
        this.data.skills.forEach(s => {
            s.level = Math.floor(s.level * 0.2);
        });

        document.getElementById('modal-end').classList.add('hidden');
        ui.log(`è½®å›ç¬¬ ${this.data.reincarnationCount} ä¸–ï¼Œä¿ç•™äº†éƒ¨åˆ†åŠŸæ³•æ„Ÿæ‚Ÿã€‚`, 'purple');
        ui.render();
    },

    sleep(ms) { return new Promise(r => setTimeout(r, ms)); },
    startLoop() { requestAnimationFrame(() => this.startLoop()); /* é¢„ç•™ç»™åŠ¨ç”»å¾ªç¯ */ }
};

const ui = {
    els: {},
    init() {
        // ç»‘å®šé•¿æŒ‰äº‹ä»¶
        const area = document.getElementById('click-area');
        let interval;
        
        const startHold = (e) => {
            e.preventDefault(); // é˜²æ­¢æ‰‹æœºç«¯é€‰ä¸­æ–‡å­—
            game.clickAction(e); // ç«‹å³è§¦å‘ä¸€æ¬¡
            interval = setInterval(() => game.clickAction(null), 80); // 12.5æ¬¡/ç§’
        };
        const endHold = () => clearInterval(interval);

        area.addEventListener('mousedown', startHold);
        area.addEventListener('touchstart', startHold, {passive: false});
        
        document.addEventListener('mouseup', endHold);
        document.addEventListener('touchend', endHold);
        
        this.render();
    },

    // æ ¼å¼åŒ–å¤§æ•°å­—ï¼šä¸‡ã€äº¿ã€å…†ã€äº¬
    fmt(num) {
        if(num < 10000) return Math.floor(num);
        if(num < 100000000) return (num/10000).toFixed(2) + 'ä¸‡';
        if(num < 1000000000000) return (num/100000000).toFixed(2) + 'äº¿';
        if(num < 10000000000000000) return (num/1000000000000).toFixed(2) + 'å…†';
        return (num/10000000000000000).toFixed(2) + 'äº¬';
    },

    switchTab(t) {
        document.querySelectorAll('.tab-content').forEach(d=>d.classList.remove('show'));
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        document.getElementById('tab-'+t).classList.add('show');
        event.target.classList.add('active');
    },

    log(msg, color='#aaa') {
        const d = document.getElementById('gamelog');
        d.innerHTML = `<div style="color:${color}; margin-bottom:4px;">[${new Date().toLocaleTimeString()}] ${msg}</div>` + d.innerHTML;
    },

    showFloatText(x, y, num) {
        const el = document.createElement('div');
        el.className = 'float-text';
        el.style.left = (x - 20) + 'px';
        el.style.top = (y - 50) + 'px';
        el.innerText = '+' + this.fmt(num);
        document.body.appendChild(el);
        setTimeout(()=>el.remove(), 800);
    },

    // ç²’å­èƒŒæ™¯ç‰¹æ•ˆ (ç®€åŒ–ç‰ˆ)
    bgParticle(x, y) {
        const canvas = document.getElementById('bgCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        ctx.fillStyle = 'rgba(255, 215, 0, 0.5)';
        ctx.beginPath();
        ctx.arc(x, y, 5, 0, Math.PI*2);
        ctx.fill();
        // ç®€å•é—ªä¸€ä¸‹å°±æ¶ˆå¤±ï¼Œä¸åšå¤æ‚ç³»ç»Ÿä»¥å…å¡é¡¿
        setTimeout(()=> ctx.clearRect(0,0,canvas.width,canvas.height), 100);
    },

    render() {
        document.getElementById('player-name').innerText = game.data.name;
        document.getElementById('reincarnate-count').innerText = game.data.reincarnationCount;
        document.getElementById('realm-disp').innerText = CONFIG.REALMS[game.data.realmIdx].name;
        this.updateSpiritDisplay();
        this.renderSkills();
        this.renderRealmTab();
    },

    updateSpiritDisplay() {
        document.getElementById('spirit-disp').innerText = this.fmt(game.data.spirit);
    },

    renderSkills() {
        const list = document.getElementById('skills-list');
        list.innerHTML = '';
        game.data.skills.forEach((s, i) => {
            const cfg = CONFIG.SKILLS[i];
            const cost = cfg.cost * Math.pow(cfg.costMult, s.level);
            const isMax = s.level >= 100;
            const canBuy = game.data.spirit >= cost && !isMax;
            
            list.innerHTML += `
                <div class="list-item">
                    <div>
                        <div style="font-weight:bold; color:${isMax?'var(--primary-gold)':'#eee'}">
                            ${cfg.name} <span style="font-size:0.8rem; color:#888">Lv.${s.level}</span>
                            ${isMax ? '<span style="background:#e91e63; font-size:0.6rem; padding:1px 3px; border-radius:3px;">åœ†æ»¡</span>' : ''}
                        </div>
                        <div style="font-size:0.75rem; color:#666">${cfg.desc}</div>
                    </div>
                    <button class="upgrade-btn ${isMax?'maxed':''}" ${canBuy?'':'disabled'} onclick="game.upgradeSkill(${i})">
                        ${isMax ? 'å·²å¤§æˆ' : 'ä¿®ä¹  ' + this.fmt(cost)}
                    </button>
                </div>
            `;
        });
    },

    renderRealmTab() {
        const idx = game.data.realmIdx;
        const nextRealm = CONFIG.REALMS[idx + 1];
        
        const btnNormal = document.getElementById('btn-upgrade');
        const btnTrib = document.getElementById('btn-tribulation');
        const hint = document.getElementById('tribulation-hint');
        const reqText = document.getElementById('req-text');
        const title = document.getElementById('next-realm-name');

        if (!nextRealm) {
            // å·²é€šå…³
            title.innerText = "å·²è¯å¤§é“";
            reqText.innerText = "å¤©åœ°åŒå¯¿ï¼Œæ—¥æœˆåŒè¾‰";
            btnNormal.classList.add('hidden');
            btnTrib.classList.add('hidden');
            return;
        }

        title.innerText = `ä¸‹ä¸€å¢ƒç•Œï¼š${nextRealm.name}`;
        reqText.innerText = `æ‰€éœ€çµåŠ›ï¼š${this.fmt(nextRealm.req)}`;

        // åˆ¤æ–­æ˜¯å¦æ˜¯æ¸¡åŠ«æœŸ (index 8 -> index 9)
        if (idx === 8) {
            // æ¸¡åŠ«é€»è¾‘
            btnNormal.classList.add('hidden');
            btnTrib.classList.remove('hidden');
            hint.classList.remove('hidden');
            
            // æ£€æŸ¥çµåŠ›æ˜¯å¦è¶³å¤Ÿå¼€å¯æ¸¡åŠ«
            if (game.data.spirit >= nextRealm.req) {
                btnTrib.disabled = false;
                btnTrib.innerText = "å¼•åŠ¨å¤©åŠ« (é€†å¤©æ”¹å‘½)";
                btnTrib.style.opacity = 1;
            } else {
                btnTrib.disabled = true;
                btnTrib.innerText = "çµåŠ›ä¸è¶³ä»¥å¼•åŠ¨å¤©åŠ«";
                btnTrib.style.opacity = 0.5;
            }
        } else {
            // æ™®é€šå‡çº§é€»è¾‘
            btnNormal.classList.remove('hidden');
            btnTrib.classList.add('hidden');
            hint.classList.add('hidden');
            
            if (game.data.spirit >= nextRealm.req) {
                btnNormal.disabled = false;
                btnNormal.innerText = "çªç ´ç“¶é¢ˆ";
            } else {
                btnNormal.disabled = true;
                btnNormal.innerText = "ç§¯æ”’çµåŠ›ä¸­...";
            }
        }
    },
    
    checkButtons() {
        // ç®€å•çš„è½®è¯¢æ£€æŸ¥æŒ‰é’®çŠ¶æ€ (ä¼˜åŒ–æ€§èƒ½å¯åªåœ¨ spirit å˜åŒ–å¤§æ—¶è°ƒç”¨)
        this.renderSkills();
        this.renderRealmTab();
    }
};

window.onload = game.init.bind(game);

</script>
</body>
</html>
