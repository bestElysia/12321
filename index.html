<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ— å°½ä¿®ä»™ï¼šè½®å›è½¬ä¸–</title>
    <style>
        /* =========================================
           CSS æ ·å¼è¡¨ - è§†è§‰æ ¸å¿ƒ
           ========================================= */
        :root {
            --bg-color: #0b0f19;
            --panel-bg: rgba(18, 25, 40, 0.95);
            --primary-gold: #ffd700;
            --primary-green: #00ff9d;
            --danger-red: #ff4757;
            --rare-purple: #bd00ff;
            --text-main: #e2e8f0;
            --text-dim: #94a3b8;
            --border-color: #2d3748;
            --shadow-glow: 0 0 15px rgba(0, 255, 157, 0.2);
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            overflow: hidden;
            height: 100vh;
            display: flex;
            justify-content: center;
        }

        /* èƒŒæ™¯åŠ¨æ€æ˜Ÿç©º */
        .bg-canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 0;
            pointer-events: none;
        }

        /* ä¸»å®¹å™¨ */
        #app {
            position: relative;
            z-index: 10;
            width: 100%;
            max-width: 600px;
            height: 100%;
            display: flex;
            flex-direction: column;
            background: radial-gradient(circle at center, rgba(30,41,59,0.5) 0%, rgba(15,23,42,1) 100%);
        }

        /* --- æ¨¡æ€æ¡† (èµ·å/æ­»äº¡) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.95);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            backdrop-filter: blur(5px);
            transition: opacity 0.5s;
        }
        .hidden { display: none !important; opacity: 0; pointer-events: none; }

        .modal-content {
            background: var(--panel-bg);
            border: 1px solid var(--primary-gold);
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            width: 80%;
            max-width: 400px;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.2);
            animation: slideIn 0.5s ease-out;
        }

        .input-group input {
            background: rgba(0,0,0,0.5);
            border: 1px solid var(--border-color);
            color: var(--primary-gold);
            padding: 15px;
            width: 100%;
            font-size: 1.2rem;
            border-radius: 6px;
            margin: 20px 0;
            text-align: center;
        }

        .btn-start {
            background: linear-gradient(45deg, #d4af37, #f7dc6f);
            color: #000;
            border: none;
            padding: 12px 40px;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: 30px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .btn-start:active { transform: scale(0.95); }

        /* --- é¡¶éƒ¨ä¿¡æ¯æ  --- */
        header {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            background: rgba(11, 15, 25, 0.9);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .player-info h1 { margin: 0; font-size: 1.2rem; color: var(--primary-gold); }
        .player-info p { margin: 5px 0 0; font-size: 0.8rem; color: var(--text-dim); }
        
        .resource-box {
            text-align: right;
        }
        .spirit-point {
            font-family: 'Courier New', monospace;
            font-size: 1.4rem;
            color: var(--primary-green);
            text-shadow: 0 0 10px rgba(0,255,157,0.5);
        }
        .cps-text { font-size: 0.7rem; color: #64748b; }

        /* --- æ¸¸æˆä¸»è§†çª— (ç‚¹å‡»åŒº) --- */
        #click-area {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            overflow: hidden;
        }

        .avatar-container {
            width: 200px; height: 200px;
            border-radius: 50%;
            border: 4px solid var(--border-color);
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            transition: all 0.3s;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="%231e293b" opacity="0.5"/></svg>');
        }

        .avatar-container.meditating {
            box-shadow: 0 0 50px var(--primary-green);
            border-color: var(--primary-green);
            transform: scale(1.05);
        }

        .realm-label {
            position: absolute;
            bottom: -20px;
            background: #000;
            border: 1px solid var(--primary-gold);
            color: var(--primary-gold);
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: bold;
            z-index: 5;
        }

        /* ç‚¹å‡»äº§ç”Ÿçš„æµ®åŠ¨æ–‡å­— */
        .float-text {
            position: absolute;
            color: #fff;
            font-weight: bold;
            pointer-events: none;
            animation: floatUp 1s forwards;
            font-size: 1.2rem;
            text-shadow: 1px 1px 2px black;
        }

        /* --- åŠŸèƒ½é¢æ¿åŒº --- */
        #panel-container {
            height: 45%;
            background: var(--panel-bg);
            border-top: 2px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .tabs {
            display: flex;
            background: rgba(0,0,0,0.3);
        }
        .tab-btn {
            flex: 1;
            padding: 15px;
            background: transparent;
            border: none;
            color: var(--text-dim);
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-size: 1rem;
        }
        .tab-btn.active {
            color: var(--primary-gold);
            border-bottom-color: var(--primary-gold);
            background: rgba(255, 215, 0, 0.05);
        }

        .tab-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: none;
        }
        .tab-content.show { display: block; }

        /* åˆ—è¡¨é¡¹æ ·å¼ */
        .list-item {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border-color);
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .item-info h4 { margin: 0 0 5px 0; font-size: 1rem; color: #e2e8f0; }
        .item-info .max-tag {
            background: var(--rare-purple);
            color: white;
            padding: 1px 5px;
            border-radius: 4px;
            font-size: 0.7rem;
            margin-right: 5px;
            display: none;
        }
        .item-desc { font-size: 0.75rem; color: #64748b; }
        
        .upgrade-btn {
            background: #1e293b;
            color: var(--primary-green);
            border: 1px solid var(--primary-green);
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
        }
        .upgrade-btn:disabled {
            border-color: #475569;
            color: #475569;
            cursor: not-allowed;
        }
        .upgrade-btn.maxed {
            border-color: var(--primary-gold);
            color: var(--primary-gold);
            background: transparent;
        }

        /* æ¸¡åŠ«æŒ‰é’® */
        #tribulation-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(to right, #b91c1c, #ef4444);
            color: white;
            border: none;
            font-weight: bold;
            font-size: 1.1rem;
            border-radius: 8px;
            margin-bottom: 15px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(239, 68, 68, 0.4);
            display: none; /* é»˜è®¤éšè—ï¼Œæ»¡è¶³æ¡ä»¶æ˜¾ç¤º */
            animation: pulse 2s infinite;
        }

        /* --- æ¸¡åŠ«è¦†ç›–å±‚ (å…¨å±ç‰¹æ•ˆ) --- */
        #tribulation-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .thunder-bolt {
            position: absolute;
            top: 0; left: 50%;
            width: 10px; height: 100%;
            background: #fff;
            box-shadow: 0 0 50px #fff, 0 0 100px violet;
            transform: translateX(-50%) scaleY(0);
            transform-origin: top;
            opacity: 0;
        }

        .tribulation-status {
            z-index: 2001;
            text-align: center;
            color: #fff;
        }
        .tribulation-log {
            height: 150px;
            width: 80%;
            overflow-y: scroll;
            background: rgba(0,0,0,0.5);
            border: 1px solid #555;
            padding: 10px;
            margin-top: 20px;
            font-family: monospace;
            text-align: left;
            font-size: 0.9rem;
        }
        .log-line { margin-bottom: 5px; opacity: 0; animation: fadeIn 0.2s forwards; }
        .log-danger { color: #ff4757; }
        .log-success { color: #2ed573; }
        .log-info { color: #70a1ff; }

        /* --- åŠ¨ç”»å…³é”®å¸§ --- */
        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-50px) scale(1.2); opacity: 0; }
        }
        @keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { opacity: 1; } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        .shaking { animation: shake 0.5s; }
        
        .thunder-anim { animation: strike 0.2s; }
        @keyframes strike {
            0% { transform: translateX(-50%) scaleY(0); opacity: 1; }
            50% { transform: translateX(-50%) scaleY(1); opacity: 1; }
            100% { transform: translateX(-50%) scaleY(1); opacity: 0; }
        }

        /* æå“å­—ä½“æ ·å¼ */
        .jp-title {
            background: linear-gradient(to right, #bd00ff, #ff0055);
            -webkit-background-clip: text;
            color: transparent;
            font-weight: bold;
        }

    </style>
</head>
<body>

    <canvas id="particleCanvas" class="bg-canvas"></canvas>

    <div id="app">
        <header>
            <div class="player-info">
                <h1 id="player-name-display">é“å‹</h1>
                <p id="player-title">å‡¡äºº</p>
            </div>
            <div class="resource-box">
                <div class="spirit-point" id="spirit-display">0</div>
                <div class="cps-text">çµåŠ›å€¼ (ä¿®ä¸º)</div>
            </div>
        </header>

        <div id="click-area" onclick="game.clickMeditate(event)">
            <div class="avatar-container" id="avatar">
                <div style="font-size: 4rem;">ğŸ§˜</div>
                <div class="realm-label" id="realm-display">ç‚¼æ°”æœŸ ä¸€å±‚</div>
            </div>
            <p style="margin-top: 30px; color: #64748b; font-size: 0.9rem;">ç‚¹å‡»å±å¹• å¸æ”¶å¤©åœ°çµæ°”</p>
        </div>

        <div id="panel-container">
            <div class="tabs">
                <button class="tab-btn active" onclick="ui.switchTab('skills')">åŠŸæ³•ç§˜ç±</button>
                <button class="tab-btn" onclick="ui.switchTab('realm')">å¢ƒç•Œçªç ´</button>
                <button class="tab-btn" onclick="ui.switchTab('log')">ä¿®ä»™æ—¥å¿—</button>
            </div>

            <div id="tab-skills" class="tab-content show">
                <div id="skills-list"></div>
            </div>

            <div id="tab-realm" class="tab-content" style="text-align: center;">
                <h3 style="color: var(--primary-gold)">å½“å‰ç“¶é¢ˆ</h3>
                <p id="next-realm-req" style="margin-bottom: 20px;">éœ€è¦ä¿®ä¸º: 100</p>
                <button id="tribulation-btn" onclick="game.attemptBreakthrough()">
                    é€†å¤©æ”¹å‘½ (å¼€å§‹æ¸¡åŠ«)
                </button>
                <p id="tribulation-warn" style="font-size: 0.8rem; color: #64748b; margin-top: 10px;">
                    æ¸¡åŠ«é¡»çŸ¥ï¼šå…±10é“å¤©é›·ï¼Œå¤±è´¥ç‡30%ã€‚<br>
                    <span style="color:var(--danger-red)">æ¸¡åŠ«å¤±è´¥å°†èº«æ­»é“æ¶ˆï¼ˆé‡ç½®è¿›åº¦ï¼‰</span>
                </p>
            </div>

            <div id="tab-log" class="tab-content">
                <div id="game-log" style="font-size: 0.8rem; color: #94a3b8; line-height: 1.6;"></div>
            </div>
        </div>
    </div>

    <div id="start-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 style="color: var(--primary-gold); margin-bottom: 0;">è¸å…¥ä»™é€”</h2>
            <p style="font-size: 0.9rem; color: #94a3b8;">å‰å°˜å¾€äº‹å¦‚äº‘çƒŸï¼Œä»Šç”Ÿé‡ä¿®è§…é•¿ç”Ÿ</p>
            
            <div class="input-group">
                <input type="text" id="input-name" placeholder="è¯·è¾“å…¥é“å· (å¦‚: éŸ©ç«‹)" maxlength="8">
            </div>
            
            <button class="btn-start" onclick="game.startGame()">å¼€å§‹ä¿®ä»™</button>
        </div>
    </div>

    <div id="tribulation-overlay" class="hidden">
        <div class="thunder-bolt" id="thunder-effect"></div>
        <div class="tribulation-status">
            <h1 style="font-size: 3rem; color: #ffeb3b; text-shadow: 0 0 20px red;">æ­£åœ¨æ¸¡åŠ«</h1>
            <h2 id="tribulation-progress">ç¬¬ 0 / 10 é“å¤©é›·</h2>
            <div class="tribulation-log" id="tribulation-log-box"></div>
        </div>
    </div>

    <div id="death-modal" class="modal-overlay hidden">
        <div class="modal-content" style="border-color: #444;">
            <h1 style="color: #ff4757; font-size: 3rem;">é™¨ è½</h1>
            <p id="death-reason">ä½ åœ¨å¤©é›·ä¹‹ä¸‹ç°é£çƒŸç­...</p>
            <p style="color: #aaa; font-size: 0.9rem;">è½®å›ç™¾ä¸–ï¼Œç»ˆæœ‰ä¸€æ—¥å¯è¯å¤§é“ã€‚</p>
            <button class="btn-start" style="margin-top: 20px; background: #fff; color: #000;" onclick="game.reincarnate()">è½¬ä¸–é‡ä¿®</button>
        </div>
    </div>

<script>
/**
 * ==========================================================
 * æ¸¸æˆæ ¸å¿ƒé€»è¾‘å¼•æ“
 * ==========================================================
 */

// æ¸¸æˆé…ç½®æ•°æ®
const CONFIG = {
    // å¢ƒç•Œåˆ—è¡¨ (åç§°, å‡çº§æ‰€éœ€çµåŠ›, æ¯æ¬¡ç‚¹å‡»åŸºç¡€å¢ç›Š)
    REALMS: [
        { name: "ç‚¼æ°”æœŸ ä¸€å±‚", req: 100, mult: 1 },
        { name: "ç‚¼æ°”æœŸ äº”å±‚", req: 500, mult: 2 },
        { name: "ç‚¼æ°”æœŸ å·…å³°", req: 2000, mult: 5 },
        { name: "ç­‘åŸºæœŸ åˆæœŸ", req: 10000, mult: 20 }, // ç¬¬ä¸€æ¬¡å°æ¸¡åŠ«
        { name: "ç­‘åŸºæœŸ ä¸­æœŸ", req: 50000, mult: 50 },
        { name: "ç­‘åŸºæœŸ åæœŸ", req: 150000, mult: 100 },
        { name: "é‡‘ä¸¹æœŸ (çœŸäºº)", req: 500000, mult: 300 },
        { name: "å…ƒå©´æœŸ (è€ç¥–)", req: 2000000, mult: 1000 },
        { name: "åŒ–ç¥æœŸ (å¤§èƒ½)", req: 10000000, mult: 5000 },
        { name: "æ¸¡åŠ«æœŸ (åŠä»™)", req: 100000000, mult: 20000 },
        { name: "å¤§ä¹˜æœŸ (çœŸä»™)", req: 999999999, mult: 100000 }
    ],
    // åˆå§‹åŠŸæ³•åº“ (åç§°, åŸºç¡€æ¶ˆè€—, æè¿°, åŸºç¡€åŠ æˆ)
    SKILLS_DB: [
        { id: 1, name: "åŸºç¡€åçº³æ³•", cost: 10, desc: "æœ€åŸºç¡€çš„å‘¼å¸æ³•é—¨ï¼Œå¢åŠ å°‘é‡çµåŠ›è·å–ã€‚", bonus: 1 },
        { id: 2, name: "ç¢§æ°´æµäº‘å‰‘", cost: 100, desc: "æ°´ç³»å‰‘æ³•ï¼Œè¿ç»µä¸ç»ï¼ŒçµåŠ›è¿è½¬åŠ é€Ÿã€‚", bonus: 5 },
        { id: 3, name: "çƒˆç«ç‡åŸè¯€", cost: 500, desc: "ç«ç³»éœ¸é“åŠŸæ³•ï¼Œçˆ†å‘åŠ›æå¼ºã€‚", bonus: 15 },
        { id: 4, name: "å¤§è¡é¾Ÿæ¯åŠŸ", cost: 2000, desc: "æ¨¡æ‹Ÿç¥é¾Ÿå‘¼å¸ï¼Œæå¤§æå‡æ ¹åŸºã€‚", bonus: 40 },
        { id: 5, name: "é‡‘åˆšä¸åèº«", cost: 8000, desc: "ä½›é—¨ç‚¼ä½“ç¥åŠŸï¼Œä¸ä»…åŠ çµåŠ›è¿˜èƒ½æŠ—é›·åŠ«ã€‚", bonus: 100 },
        { id: 6, name: "è¸é›ªæ— ç—•æ­¥", cost: 20000, desc: "èº«æ³•è½»çµï¼Œé‡‡é›†çµæ°”é€Ÿåº¦å€å¢ã€‚", bonus: 250 },
        { id: 7, name: "ä¹¾å¤å¤§æŒªç§»", cost: 50000, desc: "å€ŸåŠ›æ‰“åŠ›ï¼Œè½¬æ¢å¤©åœ°çµæ°”ã€‚", bonus: 600 },
        { id: 8, name: "åå¤©é­”åŠŸ", cost: 150000, desc: "éœ¸é“æ— æ¯”ï¼Œå¼ºè¡Œæ å¤ºå¤©åœ°é€ åŒ–ã€‚", bonus: 1500 },
        { id: 9, name: "ä¹è½¬è¿˜é­‚ä¸¹æœ¯", cost: 500000, desc: "ä¸¹é“å¤§æˆï¼ŒçµåŠ›ç”Ÿç”Ÿä¸æ¯ã€‚", bonus: 4000 },
        { id: 10, name: "æ··æ²Œè™šç©ºæ–©", cost: 2000000, desc: "ä¸€å‰‘ç ´è™šç©ºï¼Œæ¥è§¦å¤§é“æœ¬æºã€‚", bonus: 10000 },
        { id: 11, name: "çœŸÂ·åƒåƒåƒ", cost: 5000000, desc: "ä¼ è¯´ä¸­çš„ç§˜æœ¯ï¼Œåƒå°±èƒ½å˜å¼ºï¼", bonus: 25000 },
        { id: 12, name: "ä¸‡å‰‘å½’å®—", cost: 10000000, desc: "æ— ä¸Šå‰‘é“ï¼Œä¸‡å‰‘é½å‘ã€‚", bonus: 50000 }
    ]
};

// æ¸¸æˆçŠ¶æ€ç®¡ç†
class GameState {
    constructor() {
        this.reset();
    }

    reset() {
        this.playerName = "æ— åæ°";
        this.spirit = 0; // çµåŠ›ç‚¹æ•°
        this.realmIndex = 0; // å½“å‰å¢ƒç•Œä¸‹æ ‡
        this.clickCount = 0;
        this.skills = JSON.parse(JSON.stringify(CONFIG.SKILLS_DB)).map(s => ({...s, level: 0})); // æ·±æ‹·è´å¹¶åˆå§‹åŒ–ç­‰çº§
        this.logs = [];
        this.isProcessing = false; // é”ï¼Œé˜²æ­¢é‡å¤æ“ä½œ
    }

    // è®¡ç®—æ¯æ¬¡ç‚¹å‡»è·å¾—çš„çµåŠ›
    getClickPower() {
        let base = 1;
        // å¢ƒç•ŒåŠ æˆ
        base *= CONFIG.REALMS[this.realmIndex].mult;
        // åŠŸæ³•åŠ æˆ
        let skillBonus = 0;
        this.skills.forEach(s => {
            skillBonus += s.level * s.bonus;
            // æå“åŠŸæ³•é¢å¤–åŠ æˆ (æ»¡çº§ç¿»å€)
            if(s.level >= 100) skillBonus += s.bonus * 50; 
        });
        
        return base + skillBonus;
    }

    // è·å–å½“å‰å¢ƒç•Œä¿¡æ¯
    getRealm() {
        return CONFIG.REALMS[this.realmIndex];
    }

    // è·å–ä¸‹ä¸€ä¸ªå¢ƒç•Œ
    getNextRealm() {
        return CONFIG.REALMS[this.realmIndex + 1];
    }
}

// ç•Œé¢ç®¡ç†å™¨
const ui = {
    // åˆå§‹åŒ– DOM å¼•ç”¨
    init() {
        this.els = {
            spirit: document.getElementById('spirit-display'),
            realm: document.getElementById('realm-display'),
            name: document.getElementById('player-name-display'),
            skillsList: document.getElementById('skills-list'),
            logs: document.getElementById('game-log'),
            btnTrib: document.getElementById('tribulation-btn'),
            tribReq: document.getElementById('next-realm-req'),
            avatar: document.getElementById('avatar'),
            startModal: document.getElementById('start-modal'),
            inputName: document.getElementById('input-name'),
            clickArea: document.getElementById('click-area')
        };
        this.currentTab = 'skills';
    },

    updateAll() {
        // æ›´æ–°æ•°å­—æ˜¾ç¤º
        this.els.spirit.innerText = this.formatNumber(game.state.spirit);
        this.els.realm.innerText = game.state.getRealm().name;
        this.els.name.innerText = game.state.playerName;

        // æ›´æ–°æ¸¡åŠ«æŒ‰é’®çŠ¶æ€
        const nextRealm = game.state.getNextRealm();
        if (nextRealm) {
            this.els.tribReq.innerText = `ä¸‹å¢ƒç•Œæ‰€éœ€: ${this.formatNumber(nextRealm.req)}`;
            if (game.state.spirit >= nextRealm.req) {
                this.els.btnTrib.style.display = 'block';
                this.els.tribReq.style.color = '#2ed573';
                this.els.tribReq.innerText = "çµåŠ›å……ç›ˆï¼Œå¯å°è¯•çªç ´ï¼";
            } else {
                this.els.btnTrib.style.display = 'none';
                this.els.tribReq.style.color = '#e2e8f0';
            }
        } else {
            this.els.tribReq.innerText = "å·²è‡³åŒ–å¢ƒï¼Œä¸¾ä¸–æ— æ•Œ";
            this.els.btnTrib.style.display = 'none';
        }

        // å¦‚æœåŠŸæ³•åˆ—è¡¨æ‰“å¼€ï¼Œæ›´æ–°å®ƒ
        if (this.currentTab === 'skills') {
            this.renderSkills();
        }
    },

    renderSkills() {
        let html = '';
        game.state.skills.forEach(skill => {
            const cost = Math.floor(skill.cost * Math.pow(1.15, skill.level));
            const isMax = skill.level >= 100;
            const canAfford = game.state.spirit >= cost;
            
            // æå“å‰ç¼€é€»è¾‘
            let displayName = skill.name;
            let nameClass = "";
            let maxBadge = "";
            
            if (isMax) {
                displayName = "æå“Â·" + skill.name;
                nameClass = "jp-title";
                maxBadge = `<span class="max-tag" style="display:inline-block">MAX</span>`;
            }

            html += `
            <div class="list-item">
                <div class="item-info">
                    <h4>
                        ${maxBadge}
                        <span class="${nameClass}">${displayName}</span> 
                        <span style="color:#64748b; font-size:0.8rem">Lv.${skill.level}</span>
                    </h4>
                    <div class="item-desc">${skill.desc} (+${skill.bonus}/çº§)</div>
                </div>
                <div>
                    <button class="upgrade-btn ${isMax ? 'maxed' : ''}" 
                        onclick="game.upgradeSkill(${skill.id})" 
                        ${(!canAfford || isMax) ? 'disabled' : ''}>
                        ${isMax ? 'å·²åœ†æ»¡' : 'å‡çº§ ' + this.formatNumber(cost)}
                    </button>
                </div>
            </div>
            `;
        });
        this.els.skillsList.innerHTML = html;
    },

    addLog(msg, type = 'normal') {
        const time = new Date().toLocaleTimeString();
        let color = '#94a3b8';
        if(type === 'gain') color = '#2ed573';
        if(type === 'danger') color = '#ff4757';
        if(type === 'gold') color = '#ffd700';

        const p = document.createElement('div');
        p.style.color = color;
        p.style.marginBottom = '5px';
        p.innerHTML = `[${time}] ${msg}`;
        
        this.els.logs.prepend(p);
        if (this.els.logs.children.length > 50) this.els.logs.lastChild.remove();
        game.state.logs.push(msg); // å­˜å…¥æ•°æ®
    },

    switchTab(tabName) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('show'));
        
        event.target.classList.add('active');
        document.getElementById('tab-' + tabName).classList.add('show');
        this.currentTab = tabName;
        if(tabName === 'skills') this.renderSkills();
    },

    // æ ¼å¼åŒ–å¤§æ•°å­— (10k, 100w ç­‰)
    formatNumber(num) {
        if (num >= 100000000) return (num / 100000000).toFixed(2) + 'äº¿';
        if (num >= 10000) return (num / 10000).toFixed(1) + 'ä¸‡';
        return Math.floor(num);
    },

    // æ’­æ”¾ç‚¹å‡»æµ®åŠ¨æ–‡å­—åŠ¨ç”»
    showFloatText(x, y, text) {
        const el = document.createElement('div');
        el.className = 'float-text';
        el.style.left = x + 'px';
        el.style.top = y + 'px';
        el.innerText = '+' + this.formatNumber(text);
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 1000);
    }
};

// æ¸¸æˆä¸»æ§åˆ¶å™¨
const game = {
    state: new GameState(),

    init() {
        ui.init();
        // å¦‚æœæœ‰å­˜æ¡£å¯ä»¥è¯»å– (è¿™é‡Œä¸ºäº†æ¼”ç¤ºç®€å•åŒ–ï¼Œåªåšå†…å­˜å­˜å‚¨)
        this.loop();
    },

    startGame() {
        const name = ui.els.inputName.value.trim();
        if (!name) return alert("é“å‹è¯·ç•™åï¼");
        this.state.playerName = name;
        ui.els.startModal.classList.add('hidden');
        ui.addLog(`æ¬¢è¿ <b>${name}</b> è¸å…¥ä¿®ä»™ç•Œï¼`, 'gold');
        ui.updateAll();
    },

    clickMeditate(e) {
        if (this.state.isProcessing) return; // æ¸¡åŠ«æ—¶ä¸èƒ½ç‚¹

        const gain = this.state.getClickPower();
        this.state.spirit += gain;
        this.state.clickCount++;

        // è§†è§‰åé¦ˆ
        ui.els.avatar.classList.add('meditating');
        setTimeout(() => ui.els.avatar.classList.remove('meditating'), 100);
        
        // æµ®åŠ¨æ–‡å­—ä½ç½®éšæœºåç§»
        const x = e.clientX + (Math.random() * 40 - 20);
        const y = e.clientY - 20;
        ui.showFloatText(x, y, gain);

        // ç²’å­ç‰¹æ•ˆ
        particleSystem.explode(e.clientX, e.clientY);

        ui.updateAll();
    },

    upgradeSkill(id) {
        const skill = this.state.skills.find(s => s.id === id);
        if (!skill || skill.level >= 100) return;

        const cost = Math.floor(skill.cost * Math.pow(1.15, skill.level));
        if (this.state.spirit >= cost) {
            this.state.spirit -= cost;
            skill.level++;
            ui.addLog(`ä¿®ä¹ äº† [${skill.name}]ï¼ŒåŠŸåŠ›å¤§å¢ï¼`, 'gain');
            
            if (skill.level === 100) {
                ui.addLog(`[${skill.name}] å·²è‡»è‡³åŒ–å¢ƒï¼Œèœ•å˜ä¸ºæå“åŠŸæ³•ï¼`, 'gold');
            }
            ui.updateAll();
        }
    },

    // æ¸¡åŠ«é€»è¾‘
    async attemptBreakthrough() {
        const nextRealm = this.state.getNextRealm();
        if (!nextRealm || this.state.spirit < nextRealm.req) return;

        // æ‰£é™¤çµåŠ›ï¼ˆæˆ–è€…è®¾å®šä¸ºé—¨æ§›ä¸éœ€è¦æ‰£é™¤ï¼Ÿè¿™é‡Œè®¾å®šä¸ºé—¨æ§›ï¼ŒçµåŠ›ä¿ç•™ï¼Œä½†å¤±è´¥ä¼šæ¸…ç©ºï¼Ÿï¼‰
        // æŒ‰ç…§å¸¸è§„ä¿®ä»™ï¼Œçªç ´éœ€è¦æ¶ˆè€—å¤§é‡çµåŠ›
        this.state.spirit -= nextRealm.req;
        this.state.isProcessing = true;
        
        // å¯åŠ¨æ¸¡åŠ« UI
        const overlay = document.getElementById('tribulation-overlay');
        const thunder = document.getElementById('thunder-effect');
        const logBox = document.getElementById('tribulation-log-box');
        const progressTitle = document.getElementById('tribulation-progress');
        
        overlay.classList.remove('hidden');
        logBox.innerHTML = '';
        
        // æ¸¡åŠ«è¿‡ç¨‹ï¼š10é“é›·
        let survive = true;
        const totalStrikes = 10;
        
        // æˆåŠŸç‡è®¡ç®—ï¼šåŸºç¡€ 70%ï¼Œæ¯æœ‰ä¸€ä¸ªæ»¡çº§åŠŸæ³• +2%
        let maxedSkills = this.state.skills.filter(s => s.level >= 100).length;
        let successRate = 0.7 + (maxedSkills * 0.02);
        if (successRate > 0.95) successRate = 0.95; // ä¸Šé™ 95%

        for (let i = 1; i <= totalStrikes; i++) {
            progressTitle.innerText = `ç¬¬ ${i} / ${totalStrikes} é“å¤©é›·`;
            
            // ç­‰å¾…åŠ¨ç”»
            await this.sleep(800);
            
            // é›·åŠˆåŠ¨ç”»
            thunder.classList.add('thunder-anim');
            document.body.classList.add('shaking'); // å±å¹•éœ‡åŠ¨
            
            await this.sleep(200);
            thunder.classList.remove('thunder-anim');
            document.body.classList.remove('shaking');

            // åˆ¤å®šé€»è¾‘
            const roll = Math.random();
            const logLine = document.createElement('div');
            logLine.className = 'log-line';

            if (roll > successRate) {
                // è¿™ä¸€é“é›·æ²¡æŠ—ä½
                logLine.innerHTML = `<span class="log-danger">ç¬¬ ${i} é“å¤©é›·å‡»ç¢äº†ä½ çš„æŠ¤ä½“çœŸæ°”ï¼</span>`;
                logBox.appendChild(logLine);
                survive = false;
                break; 
            } else {
                logLine.innerHTML = `<span class="log-success">ä½ æˆåŠŸæŠ—ä¸‹äº†ç¬¬ ${i} é“å¤©é›·ï¼</span>`;
                logBox.appendChild(logLine);
                logBox.scrollTop = logBox.scrollHeight;
            }
        }

        await this.sleep(1000);
        overlay.classList.add('hidden');
        this.state.isProcessing = false;

        if (survive) {
            this.state.realmIndex++;
            ui.addLog(`=============`, 'gold');
            ui.addLog(`æ¸¡åŠ«æˆåŠŸï¼æ™‹å‡ä¸º [${this.state.getRealm().name}]`, 'gold');
            ui.addLog(`=============`, 'gold');
            alert("æ¸¡åŠ«æˆåŠŸï¼å¤©åœ°åŒåº†ï¼");
        } else {
            this.die();
        }
        
        ui.updateAll();
    },

    die() {
        document.getElementById('death-modal').classList.remove('hidden');
        document.getElementById('death-reason').innerText = `ä¿®ä¸ºæ­¢æ­¥äº ${this.state.getRealm().name}`;
    },

    reincarnate() {
        // è½¬ä¸–é€»è¾‘ï¼šä¿ç•™ 20% çš„çµåŠ›ï¼Œå¢ƒç•Œé‡ç½®ï¼ŒåŠŸæ³•ç­‰çº§å‡åŠä½†ä¿ç•™
        const heritage = Math.floor(this.state.spirit * 0.2);
        
        // é‡ç½®çŠ¶æ€
        this.state.realmIndex = 0;
        this.state.spirit = heritage;
        this.state.skills.forEach(s => {
            s.level = Math.floor(s.level / 2); // åŠŸæ³•ä¿ç•™ä¸€åŠç­‰çº§
        });

        document.getElementById('death-modal').classList.add('hidden');
        ui.addLog(`è½®å›è½¬ä¸–æˆåŠŸï¼ä¿ç•™äº†å‰ä¸– 20% çš„çµåŠ›ã€‚`, 'purple');
        ui.updateAll();
    },

    sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    },

    // è‡ªåŠ¨ä¿å­˜å¾ªç¯ (å¯é€‰ï¼Œè¿™é‡Œä»…åš UI åˆ·æ–°)
    loop() {
        requestAnimationFrame(() => this.loop());
        // å¦‚æœæœ‰è‡ªåŠ¨ä¿®ç‚¼åŠŸèƒ½å¯ä»¥åœ¨è¿™é‡Œå†™
    }
};

/**
 * ==========================================================
 * Canvas ç²’å­ç³»ç»Ÿ (å¢å¼ºè§†è§‰)
 * ==========================================================
 */
const particleSystem = {
    canvas: document.getElementById('particleCanvas'),
    ctx: null,
    particles: [],

    init() {
        this.ctx = this.canvas.getContext('2d');
        this.resize();
        window.addEventListener('resize', () => this.resize());
        this.animate();
    },

    resize() {
        this.canvas.width = window.innerWidth;
        this.canvas.height = window.innerHeight;
    },

    explode(x, y) {
        for (let i = 0; i < 8; i++) {
            this.particles.push({
                x: x,
                y: y,
                vx: (Math.random() - 0.5) * 5,
                vy: (Math.random() - 0.5) * 5,
                life: 1,
                color: `hsl(${Math.random()*60 + 120}, 100%, 50%)` // ç»¿è‰²ç³»
            });
        }
    },

    animate() {
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        
        // ç»˜åˆ¶èƒŒæ™¯æ˜Ÿå°˜
        this.ctx.fillStyle = '#ffffff';
        if (Math.random() > 0.9) {
            this.ctx.fillRect(Math.random()*this.canvas.width, Math.random()*this.canvas.height, 1, 1);
        }

        // ç»˜åˆ¶ç‚¹å‡»ç²’å­
        for (let i = this.particles.length - 1; i >= 0; i--) {
            let p = this.particles[i];
            p.x += p.vx;
            p.y += p.vy;
            p.life -= 0.02;
            
            this.ctx.fillStyle = p.color;
            this.ctx.globalAlpha = p.life;
            this.ctx.beginPath();
            this.ctx.arc(p.x, p.y, 3, 0, Math.PI * 2);
            this.ctx.fill();

            if (p.life <= 0) this.particles.splice(i, 1);
        }
        this.ctx.globalAlpha = 1;

        requestAnimationFrame(() => this.animate());
    }
};

// å¯åŠ¨æ¸¸æˆ
window.onload = function() {
    particleSystem.init();
    game.init();
};

</script>
</body>
</html>
