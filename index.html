<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç‰ç’ƒä»™é€”ï¼šæ¶²æ€ä¿®ä»™</title>
    <style>
        /* =========================================
           CSS æ ·å¼è¡¨ - æ¶²æ€ç»ç’ƒé£æ ¼
           ========================================= */
        :root {
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            --text-main: #ffffff;
            --text-dim: #e2e8f0;
            --primary-accent: #00d2ff;
            --danger: #ff416c;
            --gold: #f6d365;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            background: var(--bg-gradient);
            color: var(--text-main);
            font-family: 'PingFang SC', 'Heiti SC', sans-serif;
            overflow: hidden;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* åŠ¨æ€æµåŠ¨èƒŒæ™¯çƒ */
        .blobs {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            overflow: hidden;
            z-index: 0;
            pointer-events: none;
        }
        .blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.6;
            animation: float 10s infinite ease-in-out alternate;
        }
        .blob:nth-child(1) { width: 300px; height: 300px; background: #ff416c; top: -50px; left: -50px; }
        .blob:nth-child(2) { width: 400px; height: 400px; background: #00d2ff; bottom: -100px; right: -50px; animation-duration: 15s; }
        .blob:nth-child(3) { width: 200px; height: 200px; background: #f6d365; top: 40%; left: 40%; animation-duration: 12s; }

        @keyframes float {
            0% { transform: translate(0, 0) scale(1); }
            100% { transform: translate(30px, 50px) scale(1.1); }
        }

        /* ä¸»å®¹å™¨ - ç£¨ç ‚ç»ç’ƒ */
        #app {
            position: relative;
            z-index: 10;
            width: 100%;
            max-width: 500px;
            height: 95vh;
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* é¡¶éƒ¨æ  */
        header {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .player-card h1 { margin: 0; font-size: 1.2rem; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .player-card p { margin: 5px 0 0; font-size: 0.8rem; color: var(--text-dim); opacity: 0.8; }
        .spirit-box { text-align: right; }
        .spirit-val { font-size: 1.5rem; font-weight: bold; font-family: monospace; color: var(--primary-accent); }

        /* ä¸­é—´ç‚¹å‡»/é•¿æŒ‰åŒº */
        #meditate-area {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }
        
        /* æ¶²æ€çƒ (å¤´åƒ) */
        .liquid-avatar {
            width: 180px; height: 180px;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.8), rgba(255,255,255,0.1));
            box-shadow: inset 0 0 20px rgba(255,255,255,0.5), 0 10px 20px rgba(0,0,0,0.2);
            border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 4rem;
            position: relative;
            animation: morph 6s linear infinite;
            border: 2px solid rgba(255,255,255,0.3);
            transition: transform 0.1s;
        }
        
        .liquid-avatar.holding {
            transform: scale(1.1);
            box-shadow: 0 0 50px var(--primary-accent);
            background: radial-gradient(circle at 30% 30%, #fff, #00d2ff);
            animation-duration: 1s; /* åŠ é€Ÿè •åŠ¨ */
        }

        @keyframes morph {
            0%, 100% { border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%; }
            34% { border-radius: 70% 30% 50% 50% / 30% 30% 70% 70%; }
            67% { border-radius: 100% 60% 60% 100% / 100% 100% 60% 60%; }
        }

        .realm-badge {
            margin-top: 20px;
            padding: 8px 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.2);
            font-size: 0.9rem;
            letter-spacing: 1px;
        }

        .tip-text {
            margin-top: 10px;
            font-size: 0.8rem;
            opacity: 0.6;
            animation: fadeInOut 2s infinite;
        }
        @keyframes fadeInOut { 0%,100% {opacity: 0.4} 50% {opacity: 0.8} }

        /* åº•éƒ¨é¢æ¿ */
        #control-panel {
            height: 45%;
            background: rgba(0,0,0,0.2);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
        }

        .tabs { display: flex; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .tab {
            flex: 1; padding: 15px; text-align: center;
            color: rgba(255,255,255,0.5);
            cursor: pointer; transition: 0.3s;
        }
        .tab.active { color: #fff; background: rgba(255,255,255,0.05); font-weight: bold; border-bottom: 2px solid var(--primary-accent); }

        .content-area { flex: 1; overflow-y: auto; padding: 15px; display: none; }
        .content-area.show { display: block; animation: slideUp 0.3s; }
        @keyframes slideUp { from {opacity:0; transform:translateY(10px)} to {opacity:1; transform:translateY(0)} }

        /* åˆ—è¡¨é¡¹ */
        .skill-item {
            background: rgba(255,255,255,0.05);
            margin-bottom: 10px;
            padding: 12px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid transparent;
            transition: 0.2s;
        }
        .skill-item.maxed {
            border-color: var(--gold);
            background: linear-gradient(90deg, rgba(246, 211, 101, 0.1), rgba(253, 160, 133, 0.1));
        }

        .btn-glass {
            padding: 8px 16px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 20px;
            color: #fff;
            cursor: pointer;
            backdrop-filter: blur(4px);
        }
        .btn-glass:active { background: rgba(255,255,255,0.3); }
        .btn-glass:disabled { opacity: 0.3; cursor: not-allowed; }

        /* æ¸¡åŠ«æŒ‰é’® */
        #breakthrough-btn {
            width: 100%; padding: 15px;
            margin-top: 10px;
            background: linear-gradient(90deg, #ff416c, #ff4b2b);
            border: none; border-radius: 12px;
            color: white; font-weight: bold; font-size: 1.1rem;
            box-shadow: 0 4px 15px rgba(255, 65, 108, 0.4);
            display: none;
            animation: pulse 2s infinite;
        }

        /* æ¨¡æ€æ¡†é€šç”¨ */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 999;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
        }
        .modal-box {
            background: rgba(30, 30, 40, 0.9);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
            width: 80%;
            max-width: 400px;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }
        .hidden { display: none !important; }

        /* æ¸¡åŠ«åœºæ™¯ */
        #tribulation-overlay {
            flex-direction: column;
            background: radial-gradient(circle, #20002c 0%, #cbb4d4 100%);
        }
        .thunder {
            position: absolute; top:0; left:50%; width: 4px; height: 0;
            background: #fff;
            box-shadow: 0 0 20px #fff, 0 0 40px purple;
            transform: translateX(-50%);
            transition: height 0.1s;
        }
        .log-box {
            width: 90%; height: 200px;
            background: rgba(0,0,0,0.6);
            border-radius: 10px;
            padding: 10px;
            overflow-y: auto;
            text-align: left;
            font-family: monospace;
            font-size: 0.9rem;
            margin-top: 20px;
            border: 1px solid #444;
        }
        .log-line { margin-bottom: 5px; opacity: 0; animation: fadeToRight 0.3s forwards; }
        @keyframes fadeToRight { from {opacity:0; transform:translateX(-10px)} to {opacity:1; transform:translateX(0)} }

        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-2px, 0, 0); } 20%, 80% { transform: translate3d(4px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-8px, 0, 0); } 40%, 60% { transform: translate3d(8px, 0, 0); } }

        /* æµ®åŠ¨æ•°å­— */
        .float-text {
            position: absolute; pointer-events: none;
            color: #fff; font-weight: bold;
            animation: floatUp 0.8s forwards;
            text-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        @keyframes floatUp { to { transform: translateY(-80px) scale(1.5); opacity: 0; } }

    </style>
</head>
<body>

    <div class="blobs">
        <div class="blob"></div>
        <div class="blob"></div>
        <div class="blob"></div>
    </div>

    <div id="app">
        <header>
            <div class="player-card">
                <h1 id="ui-name">é“å‹</h1>
                <p id="ui-title">å‡¡äºº</p>
            </div>
            <div class="spirit-box">
                <div class="spirit-val" id="ui-spirit">0</div>
                <div style="font-size:0.7rem; opacity:0.7">çµæ°”å€¼</div>
            </div>
        </header>

        <div id="meditate-area">
            <div class="liquid-avatar" id="avatar">ğŸ§˜</div>
            <div class="realm-badge" id="ui-realm">ç‚¼æ°”æœŸ ä¸€å±‚</div>
            <div class="tip-text">è½»è§¦èšæ°” Â· é•¿æŒ‰é²¸å</div>
        </div>

        <div id="control-panel">
            <div class="tabs">
                <div class="tab active" onclick="ui.switchTab('skills')">åŠŸæ³•</div>
                <div class="tab" onclick="ui.switchTab('realm')">å¢ƒç•Œ</div>
                <div class="tab" onclick="ui.switchTab('logs')">æ—¥å¿—</div>
            </div>

            <div id="tab-skills" class="content-area show">
                <div id="skills-list"></div>
            </div>

            <div id="tab-realm" class="content-area" style="text-align: center;">
                <h2 style="margin: 0 0 10px 0; color: var(--gold)">å¢ƒç•Œç“¶é¢ˆ</h2>
                <p id="realm-req" style="margin-bottom: 20px; font-size: 0.9rem; color: #aaa;">éœ€è¦ä¿®ç‚¼è‡³å½“å‰å¢ƒç•Œåœ†æ»¡</p>
                <button id="breakthrough-btn" onclick="game.startTribulation()">
                    é€†å¤©æ”¹å‘½ (å¼€å§‹æ¸¡åŠ«)
                </button>
                <div id="trib-info" style="font-size:0.8rem; margin-top:15px; text-align:left; color:#ccc; display:none;">
                    <p>âš¡ <b>å¤©åŠ«è¯´æ˜ï¼š</b></p>
                    <p>1. éœ€æ‰¿å—ä¹é“å¤©é›·è½°é¡¶ã€‚</p>
                    <p>2. éœ€åº¦è¿‡æœ€åä¸€é“å¿ƒé­”å¤§åŠ«ã€‚</p>
                    <p>3. åŠŸæ³•è¶Šå¼ºï¼ŒæˆåŠŸç‡è¶Šé«˜ (æ»¡çº§åŠŸæ³•å¯æŠ¤ä½“)ã€‚</p>
                    <p>4. <span style="color:var(--danger)">å¤±è´¥åˆ™èº«æ­»é“æ¶ˆï¼Œé‡å…¥è½®å›ã€‚</span></p>
                </div>
            </div>

            <div id="tab-logs" class="content-area">
                <div id="game-logs" style="font-size:0.8rem; line-height:1.6; color:#ccc;"></div>
            </div>
        </div>
    </div>

    <div id="modal-start" class="modal">
        <div class="modal-box">
            <h2 style="color: var(--primary-accent)">è¸å…¥ä»™é€”</h2>
            <input type="text" id="input-name" placeholder="è¯·è¾“å…¥é“å·" style="padding:10px; border-radius:5px; border:none; width:80%; margin:20px 0; text-align:center;">
            <button class="btn-glass" style="background:var(--primary-accent); width:100%;" onclick="game.initPlayer()">å¼€å§‹ä¿®ä»™</button>
        </div>
    </div>

    <div id="modal-tribulation" class="modal hidden" style="background: rgba(0,0,0,0.95);">
        <div class="thunder" id="thunder-beam"></div>
        <h1 style="color: #fff; text-shadow: 0 0 20px purple;" id="trib-title">å¤©åŠ«é™ä¸´</h1>
        <div class="log-box" id="trib-logs"></div>
    </div>

    <div id="modal-death" class="modal hidden">
        <div class="modal-box" style="border-color: var(--danger);">
            <h1 style="color: var(--danger)">é™¨ è½</h1>
            <p id="death-msg">ä½ åœ¨å¤©åŠ«ä¸‹ç°é£çƒŸç­...</p>
            <button class="btn-glass" style="margin-top:20px; width:100%; background:var(--danger);" onclick="game.reincarnate()">è½¬ä¸–é‡ä¿®</button>
        </div>
    </div>

<script>
/**
 * ================= é…ç½®æ•°æ® =================
 */
const CONFIG = {
    // å¢ƒç•Œåˆ’åˆ†ï¼šæ¯å±‚10çº§ï¼Œç¬¬10çº§ä¸ºå¤§åœ†æ»¡ï¼Œå¯æ¸¡åŠ«
    REALMS: [
        { name: "ç‚¼æ°”æœŸ", baseReq: 100, isMajor: false },       // 0
        { name: "ç­‘åŸºæœŸ", baseReq: 5000, isMajor: true },      // 1 (éœ€æ¸¡åŠ«)
        { name: "é‡‘ä¸¹æœŸ", baseReq: 50000, isMajor: true },     // 2
        { name: "å…ƒå©´æœŸ", baseReq: 500000, isMajor: true },    // 3
        { name: "åŒ–ç¥æœŸ", baseReq: 5000000, isMajor: true },   // 4
        { name: "ç‚¼è™šæœŸ", baseReq: 50000000, isMajor: true },  // 5
        { name: "åˆä½“æœŸ", baseReq: 200000000, isMajor: true }, // 6
        { name: "å¤§ä¹˜æœŸ", baseReq: 1000000000, isMajor: true },// 7
        { name: "æ¸¡åŠ«æœŸ", baseReq: 5000000000, isMajor: true } // 8 (æœ€ç»ˆé£å‡)
    ],
    SKILLS: [
        { id: 1, name: "åŸºç¡€åçº³", cost: 10, bonus: 1, desc: "å‘¼å¸æ³•é—¨" },
        { id: 2, name: "å¼•æ°”è¯€", cost: 100, bonus: 5, desc: "ç‰µå¼•çµæ°”" },
        { id: 3, name: "åšåœŸèº«", cost: 500, bonus: 15, desc: "å¢å¼ºè‚‰èº«" },
        { id: 4, name: "å¾¡é£æœ¯", cost: 2000, bonus: 40, desc: "é‡‡é›†åŠ é€Ÿ" },
        { id: 5, name: "äº”è¡Œéæ³•", cost: 8000, bonus: 100, desc: "æ„Ÿæ‚Ÿå¤©åœ°" },
        { id: 6, name: "ç´«éœ„ç¥é›·", cost: 30000, bonus: 250, desc: "é›·ç”µæ·¬ä½“" },
        { id: 7, name: "å¤ªä¸Šå¿˜æƒ…", cost: 100000, bonus: 600, desc: "å¿ƒå¦‚æ­¢æ°´" },
        { id: 8, name: "æ³•å¤©è±¡åœ°", cost: 500000, bonus: 1500, desc: "åå™¬å¤©åœ°" },
        { id: 9, name: "ä¸€æ°”åŒ–ä¸‰æ¸…", cost: 2000000, bonus: 5000, desc: "åˆ†èº«ä¿®ç‚¼" },
        { id: 10, name: "è¢–é‡Œä¹¾å¤", cost: 10000000, bonus: 12000, desc: "è‡ªæˆä¸–ç•Œ" },
        { id: 11, name: "è¨€å‡ºæ³•éš", cost: 50000000, bonus: 30000, desc: "ä¿®æ”¹æ³•åˆ™" },
        { id: 12, name: "ä¸‡æ³•å½’ä¸€", cost: 100000000, bonus: 80000, desc: "å¤§é“æœ¬æº" }
    ]
};

/**
 * ================= æ¸¸æˆé€»è¾‘ =================
 */
const game = {
    data: {
        name: "",
        spirit: 0,
        realmIdx: 0,    // å¤§å¢ƒç•Œç´¢å¼•
        subRealm: 1,    // å°å¢ƒç•Œ (1-9å±‚, 10ä¸ºåœ†æ»¡)
        skills: []
    },
    
    // é•¿æŒ‰é€»è¾‘å˜é‡
    holdTimer: null,
    holdStartTime: 0,
    isHolding: false,

    init() {
        // åˆå§‹åŒ–åŠŸæ³•æ•°æ®
        this.data.skills = CONFIG.SKILLS.map(s => ({...s, level: 0}));
        
        // ç»‘å®šäº‹ä»¶
        const area = document.getElementById('meditate-area');
        
        // é¼ æ ‡/è§¦æ‘¸æŒ‰ä¸‹
        const startHold = (e) => {
            e.preventDefault();
            if(this.isTribulation) return;
            this.isHolding = true;
            this.holdStartTime = Date.now();
            document.getElementById('avatar').classList.add('holding');
            this.gameLoop(); // å¼€å§‹å¾ªç¯
            this.spawnClickEffect(e);
        };

        // é¼ æ ‡/è§¦æ‘¸æ¾å¼€
        const endHold = () => {
            this.isHolding = false;
            document.getElementById('avatar').classList.remove('holding');
        };

        area.addEventListener('mousedown', startHold);
        area.addEventListener('touchstart', startHold);
        
        document.addEventListener('mouseup', endHold);
        document.addEventListener('touchend', endHold);
        
        ui.update();
    },

    initPlayer() {
        const name = document.getElementById('input-name').value.trim();
        if(!name) return alert("è¯·è¾“å…¥åå­—");
        this.data.name = name;
        document.getElementById('modal-start').classList.add('hidden');
        ui.log(`<b>${name}</b> è¸å…¥ä¿®ä»™ç•Œï¼Œå¤§é“äº‰é”‹ï¼Œå§‹äºè¶³ä¸‹ã€‚`, 'gold');
        ui.update();
    },

    // æ ¸å¿ƒå¾ªç¯ (å¤„ç†é•¿æŒ‰æŒ‡æ•°å¢é•¿)
    gameLoop() {
        if (!this.isHolding) return;

        const duration = (Date.now() - this.holdStartTime) / 1000; // æŒ‰ä½ç§’æ•°
        const base = this.calculateClickPower();
        
        // æŒ‡æ•°å¢é•¿ç®—æ³•ï¼šæ¯æŒ‰ä½1ç§’ï¼Œå€ç‡å¢åŠ  (æ—¶é—´è¶Šä¹…è¶Šå¿«)
        // é™åˆ¶æœ€å¤§å€ç‡é˜²æ­¢æ•°å€¼æº¢å‡ºå¤ªå¿«
        let multiplier = 1 + Math.pow(duration, 2); 
        if(multiplier > 100) multiplier = 100; // å°é¡¶100å€é€Ÿ

        const gain = base * (0.1 * multiplier); // æ¯å¸§è·å¾—çš„çµåŠ› (å‡è®¾60fpsè°ƒç”¨ä¸å¤ªå‡†ï¼Œç®€åŒ–ä¸ºæŒ‰é¢‘ç‡)

        this.data.spirit += gain;
        ui.updateSpirit();

        // å¾ªç¯è°ƒç”¨
        requestAnimationFrame(() => this.gameLoop());
    },

    // å•æ¬¡ç‚¹å‡»/è®¡ç®—åŸºç¡€äº§å‡º
    calculateClickPower() {
        let base = 1;
        // å¢ƒç•ŒåŠ æˆ (æŒ‡æ•°çº§)
        base = base * Math.pow(2, this.data.realmIdx + (this.data.subRealm/10));
        
        // åŠŸæ³•åŠ æˆ
        this.data.skills.forEach(s => {
            let sBonus = s.level * s.bonus;
            if(s.level >= 100) sBonus *= 2; // æ»¡çº§ç¿»å€
            base += sBonus;
        });
        return base;
    },

    spawnClickEffect(e) {
        let x, y;
        if(e.type === 'touchstart') {
            x = e.touches[0].clientX;
            y = e.touches[0].clientY;
        } else {
            x = e.clientX;
            y = e.clientY;
        }
        
        // æµ®åŠ¨æ–‡å­—
        const el = document.createElement('div');
        el.className = 'float-text';
        el.style.left = x + 'px';
        el.style.top = y - 50 + 'px';
        el.innerText = '+' + ui.formatNum(this.calculateClickPower());
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 800);
    },

    upgradeSkill(id) {
        const skill = this.data.skills.find(s => s.id === id);
        if(!skill || skill.level >= 100) return;
        
        // ä»·æ ¼å…¬å¼
        const cost = Math.floor(skill.cost * Math.pow(1.15, skill.level));
        
        if(this.data.spirit >= cost) {
            this.data.spirit -= cost;
            skill.level++;
            ui.update();
            if(skill.level === 100) {
                ui.log(`åŠŸæ³• [${skill.name}] å·²è‡³åœ†æ»¡ï¼è·å¾—å¤©é“åº‡æŠ¤ï¼`, 'gold');
            }
        }
    },

    // å‡çº§å°å¢ƒç•Œ (è‡ªåŠ¨/æ‰‹åŠ¨)
    // è¿™é‡Œç®€åŒ–ï¼šçµæ°”è¶³å¤Ÿè‡ªåŠ¨å‡å°å¢ƒç•Œï¼Œç›´åˆ°å¤§å¢ƒç•Œç“¶é¢ˆ
    checkUpgrade() {
        const realmCfg = CONFIG.REALMS[this.data.realmIdx];
        const nextReq = realmCfg.baseReq * Math.pow(2, this.data.subRealm);
        
        return {
            canUpgrade: this.data.spirit >= nextReq,
            req: nextReq,
            isBottleneck: this.data.subRealm >= 10
        };
    },

    // æ¸¡åŠ«ç³»ç»Ÿ
    isTribulation: false,
    async startTribulation() {
        const status = this.checkUpgrade();
        if(!status.canUpgrade || !status.isBottleneck) return;

        // æ¶ˆè€—çµåŠ›
        this.data.spirit -= status.req;
        this.isTribulation = true;

        // UI åˆ‡æ¢
        const modal = document.getElementById('modal-tribulation');
        const logBox = document.getElementById('trib-logs');
        const thunder = document.getElementById('thunder-beam');
        modal.classList.remove('hidden');
        logBox.innerHTML = '';

        // è®¡ç®—æˆåŠŸç‡ (éšè—é€»è¾‘)
        // åŸºç¡€ 70% + (æ»¡çº§åŠŸæ³•æ•° / æ€»åŠŸæ³•æ•° * 30%)
        const maxedCount = this.data.skills.filter(s => s.level >= 100).length;
        const totalSkills = this.data.skills.length;
        let successRate = 0.7 + (maxedCount / totalSkills) * 0.35; // ç¨å¾®ç»™ç‚¹æº¢å‡ºå®¹é”™
        if(successRate > 1) successRate = 1;

        // è¿‡ç¨‹ï¼š9é“é›· + 1å¿ƒé­” = 10è½®
        let survive = true;

        for(let i=1; i<=10; i++) {
            await this.wait(1000);
            
            let isHeartDemon = (i === 10);
            let msg = "";
            let color = "";

            if(!isHeartDemon) {
                // å¤©é›·ç‰¹æ•ˆ
                thunder.style.height = "100%";
                thunder.style.opacity = "1";
                document.body.classList.add('shake');
                setTimeout(() => {
                    thunder.style.height = "0";
                    document.body.classList.remove('shake');
                }, 150);

                // åˆ¤å®š
                if(Math.random() > successRate) {
                    survive = false;
                    msg = `ç¬¬ ${i} é“å¤©é›·å‡»ç¢äº†ä½ çš„æŠ¤ä½“çµå…‰ï¼`;
                    color = "#ff416c";
                } else {
                    msg = `ç¬¬ ${i} é“å¤©é›·è½ä¸‹ï¼Œä½ å’¬ç‰™æŠ—ä½ï¼`;
                    color = "#00d2ff";
                }
            } else {
                // å¿ƒé­”åŠ«
                msg = "å¿ƒé­”å¹»å¢ƒè¢­æ¥...";
                this.appendTribLog(msg, "yellow");
                await this.wait(1500);
                
                if(survive && Math.random() <= successRate) {
                    msg = "ä½ é“å¿ƒç¨³å›ºï¼Œæ–©ç­å¿ƒé­”ï¼";
                    color = "#f6d365";
                } else {
                    survive = false;
                    msg = "ä½ è¿·å¤±åœ¨å¹»å¢ƒä¸­ï¼Œèµ°ç«å…¥é­”...";
                    color = "#ff416c";
                }
            }

            this.appendTribLog(msg, color);
            
            if(!survive) break;
        }

        await this.wait(1500);
        modal.classList.add('hidden');
        this.isTribulation = false;

        if(survive) {
            this.successBreakthrough();
        } else {
            this.failBreakthrough();
        }
    },

    appendTribLog(text, color) {
        const div = document.createElement('div');
        div.className = 'log-line';
        div.style.color = color;
        div.innerText = text;
        document.getElementById('trib-logs').appendChild(div);
        document.getElementById('trib-logs').scrollTop = 9999;
    },

    successBreakthrough() {
        this.data.realmIdx++;
        this.data.subRealm = 1;
        const newRealmName = CONFIG.REALMS[this.data.realmIdx].name;
        alert(`æ¸¡åŠ«æˆåŠŸï¼æ™‹å‡ ${newRealmName}ï¼`);
        ui.log(`=================`, 'gold');
        ui.log(`é€†å¤©æ”¹å‘½æˆåŠŸï¼æ™‹å‡ [${newRealmName}]`, 'gold');
        ui.update();
    },

    failBreakthrough() {
        document.getElementById('modal-death').classList.remove('hidden');
        document.getElementById('death-msg').innerText = `å€’åœ¨äº† ${CONFIG.REALMS[this.data.realmIdx].name} åœ†æ»¡å¢ƒç•Œ`;
    },

    reincarnate() {
        // è½¬ä¸–ï¼šä¿ç•™ 10% çµæ°”ï¼ŒåŠŸæ³•ç­‰çº§ä¿ç•™ä¸€åŠ
        this.data.spirit = Math.floor(this.data.spirit * 0.1);
        this.data.realmIdx = 0;
        this.data.subRealm = 1;
        this.data.skills.forEach(s => s.level = Math.floor(s.level / 2));
        
        document.getElementById('modal-death').classList.add('hidden');
        ui.log("è½®å›è½¬ä¸–ï¼Œå†è¸ä»™é€”...", "purple");
        ui.update();
    },

    wait(ms) { return new Promise(r => setTimeout(r, ms)); }
};

/**
 * ================= ç•Œé¢æ§åˆ¶ =================
 */
const ui = {
    update() {
        this.updateSpirit();
        document.getElementById('ui-name').innerText = game.data.name || "é“å‹";
        
        // å¢ƒç•Œæ˜¾ç¤º
        const rCfg = CONFIG.REALMS[game.data.realmIdx];
        const rName = `${rCfg.name} ${game.data.subRealm}å±‚${game.data.subRealm>=10 ? '(åœ†æ»¡)' : ''}`;
        document.getElementById('ui-realm').innerText = rName;
        document.getElementById('ui-title').innerText = rCfg.name + "ä¿®å£«";

        // å¢ƒç•Œçªç ´é¡µé¢é€»è¾‘
        const status = game.checkUpgrade();
        const btn = document.getElementById('breakthrough-btn');
        const reqText = document.getElementById('realm-req');
        const info = document.getElementById('trib-info');

        if (status.isBottleneck) {
            // åˆ°è¾¾ç“¶é¢ˆ
            reqText.innerText = `éœ€æ¶ˆè€—çµæ°”: ${this.formatNum(status.req)}`;
            if (status.canUpgrade) {
                btn.style.display = 'block';
                reqText.style.color = '#00d2ff';
                info.style.display = 'block';
            } else {
                btn.style.display = 'none';
                reqText.style.color = '#ff416c';
                info.style.display = 'none';
            }
        } else {
            // è‡ªåŠ¨å‡çº§å°å¢ƒç•Œé€»è¾‘ (å¦‚æœæœ‰çµæ°”)
            if (status.canUpgrade) {
                game.data.spirit -= status.req;
                game.data.subRealm++;
                this.log(`çªç ´è‡³ ${rCfg.name} ${game.data.subRealm}å±‚`, '#00d2ff');
                this.update(); // é€’å½’æ›´æ–°ç›´åˆ°ä¸å¤Ÿ
                return;
            }
            btn.style.display = 'none';
            reqText.innerText = `è·ç¦»ä¸‹ä¸€å±‚è¿˜éœ€: ${this.formatNum(status.req - game.data.spirit)}`;
            reqText.style.color = '#aaa';
            info.style.display = 'none';
        }

        // æ¸²æŸ“åŠŸæ³•
        this.renderSkills();
    },

    updateSpirit() {
        document.getElementById('ui-spirit').innerText = this.formatNum(game.data.spirit);
    },

    renderSkills() {
        const list = document.getElementById('skills-list');
        list.innerHTML = "";
        
        game.data.skills.forEach(s => {
            const cost = Math.floor(s.cost * Math.pow(1.15, s.level));
            const isMax = s.level >= 100;
            const canBuy = game.data.spirit >= cost && !isMax;
            
            let nameHtml = s.name;
            if(isMax) nameHtml = `<span class="jp-title">æå“Â·${s.name}</span> <span style="font-size:0.6rem; background:gold; color:black; padding:1px 3px; border-radius:4px;">MAX</span>`;

            const div = document.createElement('div');
            div.className = `skill-item ${isMax ? 'maxed' : ''}`;
            div.innerHTML = `
                <div>
                    <div style="font-weight:bold; color:${isMax?'#ffd700':'#fff'}">${nameHtml}</div>
                    <div style="font-size:0.7rem; color:#aaa;">Lv.${s.level} | ${s.desc}</div>
                </div>
                <button class="btn-glass" ${canBuy ? '' : 'disabled'} onclick="game.upgradeSkill(${s.id})">
                    ${isMax ? 'å·²åœ†æ»¡' : 'å‡ ' + this.formatNum(cost)}
                </button>
            `;
            list.appendChild(div);
        });
    },

    log(msg, color) {
        const box = document.getElementById('game-logs');
        const p = document.createElement('div');
        p.style.color = color || '#ccc';
        p.style.borderBottom = '1px solid rgba(255,255,255,0.05)';
        p.style.padding = '5px 0';
        p.innerHTML = msg;
        box.prepend(p);
        if(box.children.length > 50) box.lastChild.remove();
    },

    switchTab(t) {
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.content-area').forEach(el => el.classList.remove('show'));
        event.currentTarget.classList.add('active');
        document.getElementById('tab-'+t).classList.add('show');
    },

    formatNum(n) {
        if(n < 10000) return Math.floor(n);
        if(n < 100000000) return (n/10000).toFixed(2) + 'ä¸‡';
        return (n/100000000).toFixed(2) + 'äº¿';
    }
};

// å¯åŠ¨
window.onload = () => game.init();

</script>
</body>
</html>
