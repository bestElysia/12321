<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ— å°½ä¿®ä»™ï¼šç»ä¸–æ— åŒ</title>
    <style>
        /* =========================================
           CSS æ ·å¼è¡¨
           ========================================= */
        :root {
            --bg-color: #050505;
            --panel-bg: rgba(20, 20, 30, 0.98);
            --primary-gold: #ffc107;
            --primary-green: #4caf50;
            --danger-red: #ff3b30;
            --neon-blue: #00f2ff;
            --rare-purple: #e040fb;
            --god-tier: #ff0055; /* ç»ä¸–æ— åŒè‰² */
            --text-main: #e0e0e0;
            --text-dim: #757575;
            --border-color: #333;
        }

        * { box-sizing: border-box; user-select: none; -webkit-touch-callout: none; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            overflow: hidden;
            height: 100vh; width: 100vw;
            display: flex; justify-content: center;
            background: #000;
            touch-action: none;
        }

        .bg-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }

        #app {
            position: relative; z-index: 10; width: 100%; max-width: 600px; height: 100%;
            display: flex; flex-direction: column;
            background: radial-gradient(circle at center, rgba(30,30,40,0.3) 0%, rgba(0,0,0,1) 100%);
        }

        /* --- é¡¶éƒ¨ä¿¡æ¯æ  (æ‰©å±•ç‰ˆ) --- */
        header {
            padding-top: max(10px, env(safe-area-inset-top));
            padding-bottom: 10px; padding-left: 15px; padding-right: 15px;
            border-bottom: 1px solid var(--border-color);
            background: rgba(10, 10, 15, 0.95);
            display: flex; flex-direction: column; justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            min-height: 100px; /* åŠ é«˜ä»¥å®¹çº³æ›´å¤šä¿¡æ¯ */
            font-size: 0.8rem;
        }
        .header-top { display: flex; justify-content: space-between; width: 100%; align-items: center; margin-bottom: 5px; }
        .header-row { display: flex; justify-content: space-between; width: 100%; color: #aaa; margin-top: 2px; }
        
        .spirit-val { font-family: 'Courier New', monospace; font-size: 1.4rem; color: var(--primary-green); font-weight: bold; }
        .tag-box { padding: 1px 6px; border-radius: 4px; border: 1px solid #444; font-size: 0.7rem; }
        .tag-god { border-color: var(--god-tier); color: var(--god-tier); text-shadow: 0 0 5px var(--god-tier); }

        /* --- æ ¸å¿ƒç‚¹å‡»åŒº --- */
        #click-area {
            flex: 1; position: relative; display: flex; flex-direction: column;
            justify-content: center; align-items: center; cursor: pointer;
            transition: background 0.2s; touch-action: manipulation;
        }
        #click-area:active { background: rgba(255, 255, 255, 0.02); }

        .avatar-container {
            width: 180px; height: 180px; border-radius: 50%;
            border: 3px solid #333;
            display: flex; justify-content: center; align-items: center;
            position: relative; transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            background: radial-gradient(circle, #2a2a2a, #000);
            box-shadow: 0 0 20px rgba(0,0,0,0.5); z-index: 20;
        }
        .avatar-container.channeling {
            border-color: var(--neon-blue); box-shadow: 0 0 50px var(--neon-blue); transform: scale(1.05);
        }
        .meditate-icon { font-size: 4.5rem; transition: transform 0.1s; }

        .realm-tag {
            position: absolute; bottom: -15px;
            background: #000; border: 1px solid var(--primary-gold); color: var(--primary-gold);
            padding: 4px 15px; border-radius: 15px; font-size: 0.8rem; font-weight: bold;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3); white-space: nowrap;
        }

        /* è¿›åº¦æ¡ */
        .channel-bar { margin-top: 30px; width: 70%; height: 6px; background: #222; border-radius: 3px; position: relative; opacity: 0; }
        .channel-bar.active { opacity: 1; }
        .channel-fill { height: 100%; background: var(--neon-blue); width: 0%; border-radius: 3px; box-shadow: 0 0 10px var(--neon-blue); }
        .channel-text { text-align: center; margin-top: 8px; font-size: 0.9rem; color: var(--neon-blue); height: 20px; text-shadow: 0 0 5px var(--neon-blue); }

        /* --- åº•éƒ¨é¢æ¿ --- */
        #panel-container { 
            height: 55%; background: var(--panel-bg); border-top: 1px solid var(--border-color); display: flex; flex-direction: column;
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .tabs { display: flex; background: rgba(0,0,0,0.5); }
        .tab-btn {
            flex: 1; padding: 12px; background: transparent; border: none; color: var(--text-dim);
            border-bottom: 2px solid transparent; font-size: 0.9rem; cursor: pointer; touch-action: manipulation;
        }
        .tab-btn.active { color: var(--primary-gold); border-bottom-color: var(--primary-gold); background: rgba(255, 215, 0, 0.05); }

        .tab-content { flex: 1; overflow-y: auto; padding: 10px; display: none; -webkit-overflow-scrolling: touch; }
        .tab-content.show { display: block; }

        .list-item {
            background: rgba(255,255,255,0.03); border: 1px solid var(--border-color);
            padding: 10px; margin-bottom: 6px; border-radius: 6px;
            display: flex; justify-content: space-between; align-items: center;
        }
        
        /* æŒ‰é’®é€šç”¨ */
        .btn-mini {
            background: transparent; border: 1px solid var(--primary-green); color: var(--primary-green);
            padding: 6px 12px; border-radius: 4px; font-size: 0.75rem; cursor: pointer; touch-action: manipulation;
        }
        .btn-mini:disabled { border-color: #444; color: #444; }
        .btn-mini.maxed { border-color: var(--primary-gold); color: var(--primary-gold); background: rgba(255,215,0,0.05); }

        /* ä¿®ç‚¼é¡µé¢å¸ƒå±€ */
        .cultivate-section { margin-bottom: 20px; border-bottom: 1px dashed #333; padding-bottom: 15px; }
        .cultivate-header { color: #fff; font-size: 1rem; margin-bottom: 10px; display: flex; justify-content: space-between; }
        .cultivate-btn-lg {
            width: 100%; padding: 12px; border: none; font-size: 1rem; font-weight: bold; border-radius: 6px; 
            margin-top: 5px; cursor: pointer; touch-action: manipulation;
            background: #222; color: #888;
        }
        .cultivate-btn-lg.active { background: var(--primary-green); color: #000; }
        .cultivate-btn-lg.trib { 
            background: linear-gradient(45deg, #d32f2f, #b71c1c); color: #fff; animation: pulse 1.5s infinite; 
        }

        .float-text {
            position: absolute; color: #fff; font-weight: bold; pointer-events: none;
            animation: floatUp 0.8s forwards; font-size: 1.2rem; text-shadow: 1px 1px 2px black; z-index: 100;
        }

        /* æ¸¡åŠ«å±‚ */
        #tribulation-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 2000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .xinmo-mode { background: radial-gradient(circle, #300000, #000); }
        .thunder-bolt {
            position: absolute; top: 0; left: 50%; width: 10px; height: 100%;
            background: #fff; box-shadow: 0 0 30px #fff, 0 0 80px #9c27b0;
            transform: translateX(-50%) scaleY(0); transform-origin: top; opacity: 0;
        }
        .thunder-strike { animation: strike 0.08s; }

        @keyframes floatUp { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-60px); opacity: 0; } }
        @keyframes strike { 0% { transform: translateX(-50%) scaleY(0); opacity: 1; } 50% { transform: translateX(-50%) scaleY(1); opacity: 1; } 100% { transform: translateX(-50%) scaleY(1); opacity: 0; } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        .hidden { display: none !important; }
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85);
            display: flex; justify-content: center; align-items: center; z-index: 3000; backdrop-filter: blur(5px);
        }
        .modal-box {
            background: #1a1a1a; padding: 25px; border-radius: 10px; border: 1px solid var(--primary-gold);
            text-align: center; width: 85%; max-width: 400px;
        }
        input { background: #333; border: 1px solid #555; color: white; padding: 10px; margin: 15px 0; width: 90%; text-align: center; }
    </style>
</head>
<body>

    <canvas id="bgCanvas" class="bg-canvas"></canvas>

    <div id="app">
        <header>
            <div class="header-top">
                <div style="font-size: 1.1rem; color: var(--primary-gold); font-weight: bold;" id="player-name">é“å‹</div>
                <div class="spirit-val" id="spirit-disp">0</div>
            </div>
            
            <div class="header-row">
                <span>å¤©èµ‹: <span id="talent-disp" class="tag-box">å‡¡å“çµæ ¹</span></span>
                <span>æ³•å®: <span id="weapon-disp" class="tag-box">é”ˆé“å‰‘</span></span>
            </div>
            <div class="header-row" style="margin-top:5px; font-size:0.7rem;">
                <span>è½®å›: <span id="reincarnate-count">0</span> ä¸–</span>
                <span>çµæ°”åŠ æˆ: <span id="mult-disp" style="color:var(--primary-green)">x1.0</span></span>
            </div>
        </header>

        <div id="click-area">
            <div class="avatar-container" id="avatar">
                <div class="meditate-icon">ğŸ§˜â€â™‚ï¸</div>
                <div class="realm-tag" id="realm-disp">ç‚¼æ°”æœŸ ä¸€å±‚</div>
            </div>
            
            <div id="channel-container" class="channel-bar">
                <div class="channel-fill" id="channel-fill"></div>
            </div>
            <div class="channel-text" id="channel-text"></div>
            
            <p style="margin-top: 15px; color: #666; font-size: 0.8rem;">
                é•¿æŒ‰å±å¹• <span style="color:var(--neon-blue)">æ±‡èšçµæ°”</span> (æ¯5ç§’å€ç‡+10)
            </p>
        </div>

        <div id="panel-container">
            <div class="tabs">
                <button class="tab-btn active" onclick="ui.switchTab('skills')">åŠŸæ³•ç§˜ç±</button>
                <button class="tab-btn" onclick="ui.switchTab('cultivate')">æ´åºœä¿®ç‚¼</button>
                <button class="tab-btn" onclick="ui.switchTab('log')">ä»™é€”æ—¥å¿—</button>
            </div>

            <div id="tab-skills" class="tab-content show">
                <div style="font-size:0.75rem;color:#666;text-align:center;margin-bottom:10px;">
                    é•¿æŒ‰å‡çº§ Â· æ»¡çº§è§£é”<span style="color:#e91e63">è‡³è‡»</span>ç§°å· Â· å…¨è‡³è‡»å¿…è¿‡å¤©åŠ«
                </div>
                <div id="skills-list"></div>
            </div>

            <div id="tab-cultivate" class="tab-content">
                <div class="cultivate-section">
                    <div class="cultivate-header">
                        <span>å¢ƒç•Œçªç ´</span>
                        <span id="next-realm-name" style="color:var(--primary-gold)">ç‚¼æ°”æœŸ äºŒå±‚</span>
                    </div>
                    <div style="font-size:0.8rem; color:#666; margin-bottom:5px;">æ‰€éœ€çµåŠ›: <span id="req-realm" style="color:#fff">100</span></div>
                    
                    <button id="btn-realm" class="cultivate-btn-lg" onclick="game.upgradeRealm()">çªç ´ç“¶é¢ˆ</button>
                    <button id="btn-trib" class="cultivate-btn-lg trib hidden" onclick="game.startTribulation()">é€†å¤©æ”¹å‘½ (ç™¾é›·å¤©åŠ«)</button>
                    <div id="trib-warn" class="hidden" style="color:#ff3b30; font-size:0.7rem; margin-top:5px;">å…¨åŠŸæ³•è‡³è‡»åœ†æ»¡å¯100%æˆåŠŸï¼Œå¦åˆ™50%å‡ ç‡é™¨è½ã€‚</div>
                </div>

                <div class="cultivate-section">
                    <div class="cultivate-header">
                        <span>æ·¬ç‚¼çµæ ¹</span>
                        <span id="next-root-name" style="color:var(--neon-blue)">ä¸‹å“çµæ ¹</span>
                    </div>
                    <div style="font-size:0.8rem; color:#666; margin-bottom:5px;">æ•ˆæœ: å…¨å±€çµæ°” <span id="root-bonus" style="color:var(--primary-green)">+50%</span></div>
                    <div style="font-size:0.8rem; color:#666;">æ¶ˆè€—: <span id="req-root" style="color:#fff">500</span></div>
                    <button id="btn-root" class="cultivate-btn-lg" onclick="game.upgradeRoot()">æ´—é«“ä¼éª¨</button>
                </div>

                <div class="cultivate-section" style="border:none;">
                    <div class="cultivate-header">
                        <span>ç¥­ç‚¼æœ¬å‘½æ³•å®</span>
                        <span id="next-weapon-name" style="color:var(--rare-purple)">æœ¨å‰‘</span>
                    </div>
                    <div style="font-size:0.8rem; color:#666; margin-bottom:5px;">æ•ˆæœ: é¢å¤–å€ç‡ <span id="weapon-bonus" style="color:var(--primary-green)">x2.0</span></div>
                    <div style="font-size:0.8rem; color:#666;">æ¶ˆè€—: <span id="req-weapon" style="color:#fff">1,000</span></div>
                    <button id="btn-weapon" class="cultivate-btn-lg" onclick="game.upgradeWeapon()">ç¥­ç‚¼æ³•å®</button>
                </div>
            </div>

            <div id="tab-log" class="tab-content">
                <div id="gamelog" style="font-size: 0.8rem; line-height: 1.6; color: #aaa;"></div>
            </div>
        </div>
    </div>

    <div id="modal-start" class="modal">
        <div class="modal-box">
            <h2 style="color: var(--primary-gold)">è¸å…¥ä»™é€”</h2>
            <p style="color:#888;font-size:0.9rem;">æ£€æµ‹åˆ°é“å‹å¤©èµ„ç»ä¸–</p>
            <input type="text" id="inp-name" placeholder="è¯·è¾“å…¥é“å·" maxlength="6">
            <button class="cultivate-btn-lg active" onclick="game.startGame()">å¼€å§‹ä¿®ä»™</button>
        </div>
    </div>

    <div id="tribulation-overlay" class="hidden">
        <div class="thunder-bolt" id="thunder-vfx"></div>
        <div style="z-index: 2002; text-align: center; width: 85%;">
            <h1 style="color: #ffeb3b; text-shadow: 0 0 20px red;">å¤©åŠ«é™ä¸´</h1>
            <h2 id="trib-step" style="color: white; font-family: monospace; font-size:2rem;">0 / 100</h2>
            <div id="trib-console" style="height: 120px; overflow-y: scroll; background: rgba(0,0,0,0.6); border: 1px solid #444; padding: 10px; font-size: 0.8rem; text-align: left; margin-top: 20px;"></div>
        </div>
    </div>

    <div id="modal-end" class="modal hidden">
        <div class="modal-box">
            <h1 id="end-title" style="color: #ff3b30">é™¨è½</h1>
            <p id="end-desc">ä½ åœ¨å¤©åŠ«ä¸‹ç°é£çƒŸç­...</p>
            <button class="cultivate-btn-lg active" onclick="game.reincarnate()">è½¬ä¸–é‡ä¿®</button>
        </div>
    </div>

<script>
/**
 * ==========================================================
 * æ¸¸æˆæ ¸å¿ƒé…ç½® (æµ·é‡å†…å®¹ç‰ˆ)
 * ==========================================================
 */
const CONFIG = {
    // å¢ƒç•Œ (10ä¸ªå¤§å¢ƒç•Œ)
    MAJOR_REALMS: [
        { name: "ç‚¼æ°”æœŸ", baseReq: 100, exp: 1.5 },     
        { name: "ç­‘åŸºæœŸ", baseReq: 10000, exp: 1.6 },    
        { name: "é‡‘ä¸¹æœŸ", baseReq: 500000, exp: 1.7 },   
        { name: "å…ƒå©´æœŸ", baseReq: 10000000, exp: 1.8 },  
        { name: "åŒ–ç¥æœŸ", baseReq: 500000000, exp: 1.9 },
        { name: "ç‚¼è™šæœŸ", baseReq: 20000000000, exp: 2.0 }, 
        { name: "åˆä½“æœŸ", baseReq: 500000000000, exp: 2.1 }, 
        { name: "å¤§ä¹˜æœŸ", baseReq: 10000000000000, exp: 2.2 }, 
        { name: "æ¸¡åŠ«æœŸ", baseReq: 500000000000000, exp: 2.3 }, 
        { name: "é™†åœ°çœŸä»™", baseReq: 0, exp: 1 }
    ],
    // çµæ ¹ (10çº§ï¼Œå…¨å±€ä¹˜æ³•)
    ROOTS: [
        { name: "å‡¡å“åºŸçµæ ¹", mult: 1, cost: 0 },
        { name: "ä¸‹å“çµæ ¹", mult: 1.5, cost: 1000 },
        { name: "ä¸­å“çµæ ¹", mult: 2, cost: 50000 },
        { name: "ä¸Šå“çµæ ¹", mult: 3, cost: 1000000 },
        { name: "åœ°çµæ ¹", mult: 5, cost: 20000000 },
        { name: "å¤©çµæ ¹", mult: 8, cost: 500000000 },
        { name: "æå“å¤©çµæ ¹", mult: 12, cost: 10000000000 },
        { name: "å˜å¼‚é›·çµæ ¹", mult: 20, cost: 500000000000 },
        { name: "ä»™çµæ ¹", mult: 50, cost: 10000000000000 },
        { name: "ç»ä¸–æ— åŒ", mult: 100, cost: 999999999999999 } // é¡¶æ ¼
    ],
    // æ­¦å™¨ (10çº§ï¼Œç‹¬ç«‹ä¹˜æ³•)
    WEAPONS: [
        { name: "ç ´æ ‘æ", mult: 1, cost: 0 },
        { name: "ç”Ÿé”ˆé“å‰‘", mult: 1.2, cost: 5000 },
        { name: "ç²¾é’¢å‰‘", mult: 1.5, cost: 100000 },
        { name: "å¯’é“å‰‘", mult: 2, cost: 2000000 },
        { name: "é’é”‹å‰‘", mult: 3, cost: 50000000 },
        { name: "ç¢§æ°´å‰‘", mult: 5, cost: 1000000000 },
        { name: "çœŸÂ·ç¢§æ°´å‰‘", mult: 10, cost: 50000000000 },
        { name: "çœŸÂ·ç¢§æ°´å‰‘ (æ)", mult: 20, cost: 2000000000000 },
        { name: "çœŸÂ·ç¢§æ°´å‰‘ (è‡³è‡»)", mult: 50, cost: 100000000000000 },
        { name: "è½©è¾•å‰‘", mult: 100, cost: 9999999999999999 }
    ],
    // åŠŸæ³• (20ä¸ªï¼ŒæŒ‡æ•°å¢é•¿)
    SKILLS: [
        { name: "åŸºç¡€åçº³", cost: 100, power: 1.1, desc: "ä¿®ä»™å…¥é—¨ï¼Œå‘¼å¸åçº³" },
        { name: "è¶…çº§æ¸…å°˜æœ¯", cost: 5000, power: 1.15, desc: "è¢«åŠ¨ï¼šæ—¶åˆ»ä¿æŒèº«ä½“æ¸…æ´ï¼Œå¿ƒæƒ…å¥½ä¿®ç‚¼å¿«" },
        { name: "è¶…çº§æ°´çƒæœ¯", cost: 50000, power: 1.2, desc: "å‡èšå·¨å¤§çš„æ°´çƒï¼Œå¨åŠ›æƒŠäºº" },
        { name: "è¶…çº§å¤§æ°´çƒæœ¯", cost: 500000, power: 1.25, desc: "æ¯”è¶…çº§æ°´çƒæœ¯è¿˜è¦å¤§çš„æ°´çƒ" },
        { name: "çœŸÂ·ç¢§æ°´æµäº‘å¿ƒæ³•", cost: 5000000, power: 1.3, desc: "ä¸Šå–„è‹¥æ°´ï¼Œç”Ÿç”Ÿä¸æ¯" },
        { name: "çœŸÂ·ç¢§æ°´æµäº‘å‰‘æ³•", cost: 50000000, power: 1.35, desc: "å‰‘æ°”å¦‚æ°´ï¼Œè¿ç»µä¸ç»" },
        { name: "å¤§è¡é¾Ÿæ¯å†³", cost: 200000000, power: 1.4, desc: "æ¨¡æ‹Ÿç¥é¾Ÿå‘¼å¸ï¼Œå¯¿å‘½æé•¿" },
        { name: "çƒˆç«ç‡åŸè¯€", cost: 1000000000, power: 1.45, desc: "ç«ç³»éœ¸é“åŠŸæ³•" },
        { name: "åšåœŸé‡‘é’Ÿç½©", cost: 5000000000, power: 1.5, desc: "é˜²å¾¡æ— åŒï¼Œä¸åŠ¨å¦‚å±±" },
        { name: "é’æœ¨é•¿ç”ŸåŠŸ", cost: 20000000000, power: 1.55, desc: "æ±²å–è‰æœ¨ç²¾æ°”" },
        { name: "åºšé‡‘ç™½è™æ€", cost: 100000000000, power: 1.6, desc: "ä¸»æ€ä¼ï¼Œæ”»å‡»åŠ›æå¼º" },
        { name: "ç´«æ°”ä¸œæ¥", cost: 500000000000, power: 1.65, desc: "æ¯æ—¥æ¸…æ™¨å¸æ”¶ç¬¬ä¸€ç¼•ç´«æ°”" },
        { name: "å¤ªä¸Šæ„Ÿåº”ç¯‡", cost: 2000000000000, power: 1.7, desc: "æ„Ÿåº”å¤©åœ°ï¼Œå¤ºé€ åŒ–" },
        { name: "åŒ—å†¥ç¥åŠŸ", cost: 10000000000000, power: 1.75, desc: "åå™¬ä¸‡ç‰©çµæ°”" },
        { name: "å…«ä¹ç„åŠŸ", cost: 50000000000000, power: 1.8, desc: "è‚‰èº«æˆåœ£ï¼Œä¸‡åŠ«ä¸ç£¨" },
        { name: "è¢–é‡Œä¹¾å¤", cost: 200000000000000, power: 1.85, desc: "ä¸€è¢–è£…å°½å¤©ä¸‹" },
        { name: "çœŸÂ·åƒåƒåƒ", cost: 1000000000000000, power: 1.9, desc: "é€šè¿‡åƒå¤©æåœ°å®ç›´æ¥å˜å¼º" },
        { name: "åå¤©é­”åŠŸ", cost: 5000000000000000, power: 1.95, desc: "ä»¥å‡¡ä½“åå™¬è¯¸ç‹" },
        { name: "ä¸€å¿µèŠ±å¼€", cost: 20000000000000000, power: 2.0, desc: "å›ä¸´å¤©ä¸‹" },
        { name: "ä¸‡å‰‘å½’å®—", cost: 100000000000000000, power: 2.1, desc: "å‰‘é“è‡³é«˜å¢ƒç•Œ" }
    ]
};

const game = {
    data: {
        name: "æ— å",
        spirit: 0,
        realmIdx: 0, layer: 1, // å¢ƒç•Œ
        rootIdx: 0, // çµæ ¹ç­‰çº§
        weaponIdx: 0, // æ­¦å™¨ç­‰çº§
        skills: CONFIG.SKILLS.map(s => ({...s, level: 0})),
        reincarnationCount: 0,
        isTribulating: false
    },
    
    hold: { active: false, startTime: 0, timer: null, currentMult: 1 },

    init() { ui.init(); this.loop(); },

    startGame() {
        const n = document.getElementById('inp-name').value.trim();
        if(n) this.data.name = n;
        document.getElementById('modal-start').classList.add('hidden');
        ui.log(`é“å‹ <b>${this.data.name}</b> è¸å…¥ä»™é€”ï¼Œæ£€æµ‹ä¸ºå‡¡å“çµæ ¹ã€‚`);
        ui.render();
    },

    // --- æ ¸å¿ƒæ•°å€¼è®¡ç®— ---
    getClickPower() {
        // 1. å¢ƒç•ŒåŸºç¡€: (idx+1)^3 * layer
        const base = Math.pow(this.data.realmIdx + 1, 3) * this.data.layer;
        
        // 2. åŠŸæ³•åŠ æˆ: æŒ‡æ•°è¿ä¹˜
        let skillMult = 1;
        this.data.skills.forEach(s => {
            if(s.level > 0) skillMult *= Math.pow(s.power, s.level);
        });

        // 3. çµæ ¹åŠ æˆ (å…¨å±€ä¹˜æ³•)
        const rootMult = CONFIG.ROOTS[this.data.rootIdx].mult;

        // 4. æ­¦å™¨åŠ æˆ (å…¨å±€ä¹˜æ³•)
        const weaponMult = CONFIG.WEAPONS[this.data.weaponIdx].mult;

        // 5. é•¿æŒ‰çˆ†å‘
        const holdMult = this.hold.currentMult;

        return base * skillMult * rootMult * weaponMult * holdMult;
    },

    processClick(e) {
        if(this.data.isTribulating) return;

        const gain = this.getClickPower();
        this.data.spirit += gain;
        
        const isAuto = !e; 
        if(!isAuto && e.isTrusted) {
            ui.showFloatText(e.clientX, e.clientY, gain);
            ui.bgParticle(e.clientX, e.clientY);
        } else if (isAuto) {
            const x = window.innerWidth / 2 + (Math.random()*60 - 30);
            const y = window.innerHeight / 2 - 50 + (Math.random()*40 - 20);
            ui.showFloatText(x, y, gain);
        }

        ui.updateSpirit();
    },

    // --- å‡çº§é€»è¾‘ ---
    
    // å‡çº§åŠŸæ³•
    upgradeSkill(idx) {
        const s = this.data.skills[idx];
        // æˆæœ¬å…¬å¼ï¼šbase * 1.6^level
        const cost = s.cost * Math.pow(1.6, s.level);
        if(this.data.spirit >= cost) {
            this.data.spirit -= cost;
            s.level++;
            return true;
        }
        return false;
    },

    // å‡çº§çµæ ¹
    upgradeRoot() {
        if(this.data.rootIdx >= CONFIG.ROOTS.length - 1) return;
        const next = CONFIG.ROOTS[this.data.rootIdx + 1];
        if(this.data.spirit >= next.cost) {
            this.data.spirit -= next.cost;
            this.data.rootIdx++;
            ui.log(`çµæ ¹èœ•å˜ä¸º [${next.name}]ï¼Œä¿®ç‚¼é€Ÿåº¦å¤§å¢ï¼`, 'neon-blue');
            ui.render();
        }
    },

    // å‡çº§æ­¦å™¨
    upgradeWeapon() {
        if(this.data.weaponIdx >= CONFIG.WEAPONS.length - 1) return;
        const next = CONFIG.WEAPONS[this.data.weaponIdx + 1];
        if(this.data.spirit >= next.cost) {
            this.data.spirit -= next.cost;
            this.data.weaponIdx++;
            ui.log(`æœ¬å‘½æ³•å®ç¥­ç‚¼ä¸º [${next.name}]ï¼Œå¨åŠ›å€å¢ï¼`, 'rare-purple');
            ui.render();
        }
    },

    // å‡çº§å¢ƒç•Œ
    upgradeRealm() {
        const nextReq = this.getNextRealmReq();
        if(this.data.spirit >= nextReq) {
            this.data.spirit -= nextReq;
            if(this.data.layer < 9) {
                this.data.layer++;
                ui.log(`çªç ´è‡³ [${CONFIG.MAJOR_REALMS[this.data.realmIdx].name} ${this.data.layer}å±‚]`, 'green');
            } else {
                // æ¸¡åŠ«æœŸæ»¡ (idx 8, layer 9) å¿…é¡»æ¸¡åŠ«
                if(this.data.realmIdx === 8 && this.data.layer === 9) return; 
                this.data.realmIdx++;
                this.data.layer = 1;
                ui.log(`=== æ™‹å‡ [${CONFIG.MAJOR_REALMS[this.data.realmIdx].name}] ===`, 'gold');
            }
            ui.render();
        }
    },

    getNextRealmReq() {
        const major = CONFIG.MAJOR_REALMS[this.data.realmIdx];
        if(!major) return 0;
        return major.baseReq * Math.pow(this.data.layer, major.exp);
    },

    // --- æ¸¡åŠ« ---
    startTribulation() {
        this.data.isTribulating = true;
        document.getElementById('tribulation-overlay').classList.remove('hidden');
        document.getElementById('tribulation-overlay').classList.remove('xinmo-mode');
        document.getElementById('trib-console').innerHTML = '';
        this.runTribulation();
    },

    async runTribulation() {
        const log = (m, c='#fff') => {
            const d = document.getElementById('trib-console');
            d.innerHTML += `<div style="color:${c}">${m}</div>`;
            d.scrollTop = d.scrollHeight;
        };

        const thunder = document.getElementById('thunder-vfx');
        const countDisp = document.getElementById('trib-step');
        
        const totalSkills = this.data.skills.length;
        const maxedSkills = this.data.skills.filter(s => s.level >= 100).length;
        let rate = 0.5;
        
        if (maxedSkills === totalSkills) {
            rate = 1.1; 
            log("ä¸‡æ³•å½’ä¸€ï¼Œå…¨åŠŸæ³•è‡³è‡»åœ†æ»¡ï¼Œå¤©é“æŠ¤ä½‘ï¼", "#ffd700");
        } else {
            log(`åŠŸæ³•æœªåœ†æ»¡ (${maxedSkills}/${totalSkills})ï¼Œä»…50%å­˜æ´»ç‡...`, "#ff9800");
        }

        for(let i=1; i<=100; i++) {
            countDisp.innerText = `${i} / 100 é“`;
            await this.sleep(40);
            thunder.classList.add('thunder-strike');
            setTimeout(()=>thunder.classList.remove('thunder-strike'), 20);
        }

        await this.sleep(500);
        document.getElementById('tribulation-overlay').classList.add('xinmo-mode');
        log("å¿ƒé­”åŠ«é™ä¸´...", "#ff3b30");
        await this.sleep(1500);

        if(Math.random() < rate) {
            log("æ¸¡åŠ«æˆåŠŸï¼Œé£å‡ä»™ç•Œï¼", "#4caf50");
            await this.sleep(1000);
            this.handleWin();
        } else {
            log("æ¸¡åŠ«å¤±è´¥ï¼Œèº«æ­»é“æ¶ˆï¼", "#ff0000");
            await this.sleep(1000);
            this.handleDeath();
        }
    },

    handleWin() {
        this.data.isTribulating = false;
        document.getElementById('tribulation-overlay').classList.add('hidden');
        this.data.realmIdx++; 
        this.data.layer = 1;
        document.getElementById('modal-end').classList.remove('hidden');
        document.getElementById('end-title').innerText = "ç»ä¸–æ— åŒ";
        document.getElementById('end-title').style.color = "#ffd700";
        document.getElementById('end-desc').innerText = `æ­å–œé“å‹ ${this.data.name} è¯é“çœŸä»™ï¼Œç»ä¸–æ— åŒï¼`;
    },

    handleDeath() {
        this.data.isTribulating = false;
        document.getElementById('tribulation-overlay').classList.add('hidden');
        document.getElementById('modal-end').classList.remove('hidden');
        document.getElementById('end-title').innerText = "é“æ¶ˆèº«æ­»";
        document.getElementById('end-title').style.color = "#ff3b30";
        document.getElementById('end-desc').innerText = "ä¿®ä»™è·¯æ¼«æ¼«ï¼Œè¯·é‡æ–°æ¥è¿‡ã€‚";
    },

    reincarnate() {
        this.data.reincarnationCount++;
        this.data.spirit = 0;
        this.data.realmIdx = 0;
        this.data.layer = 1;
        // è½®å›ä¸é‡ç½®çµæ ¹å’Œæ­¦å™¨ (è®©å®ƒä½œä¸ºæ°¸ä¹…ç§¯ç´¯?) ä¸ï¼Œé‡ç½®å§ï¼Œä¸ç„¶å¤ªå¿«äº†ã€‚
        // æˆ–è€…ä¿ç•™çµæ ¹ç­‰çº§çš„ä¸€åŠï¼Ÿè¿™é‡Œé€‰æ‹©é‡ç½®ä¸ºå‡¡äººï¼Œä½†ä¿ç•™åŠŸæ³•ç­‰çº§ä¸€åŠ
        this.data.rootIdx = 0;
        this.data.weaponIdx = 0;
        this.data.skills.forEach(s => s.level = Math.floor(s.level * 0.5)); 
        
        document.getElementById('modal-end').classList.add('hidden');
        ui.log(`è½®å›ç¬¬ ${this.data.reincarnationCount} ä¸–ï¼Œé‡æ–°è¸ä¸Šå¾ç¨‹ã€‚`, 'rare-purple');
        ui.render();
    },

    sleep(ms) { return new Promise(r=>setTimeout(r,ms)); },
    loop() { requestAnimationFrame(()=>this.loop()); }
};

const ui = {
    skillHoldTimer: null,

    init() {
        const area = document.getElementById('click-area');
        
        const start = (e) => {
            if(e.cancelable) e.preventDefault();
            if(game.hold.active) return;
            game.hold.active = true;
            game.hold.startTime = Date.now();
            document.getElementById('avatar').classList.add('channeling');
            document.getElementById('channel-container').classList.add('active');
            game.hold.timer = setInterval(() => { this.updateHoldStatus(); game.processClick(null); }, 100);
        };
        const end = () => {
            if(!game.hold.active) return;
            game.hold.active = false;
            clearInterval(game.hold.timer);
            game.hold.currentMult = 1; 
            document.getElementById('avatar').classList.remove('channeling');
            document.getElementById('channel-container').classList.remove('active');
            document.getElementById('channel-text').innerText = '';
        };

        area.addEventListener('mousedown', start);
        area.addEventListener('touchstart', start, {passive:false});
        document.addEventListener('mouseup', end);
        document.addEventListener('touchend', end);
        
        this.render();
    },

    updateHoldStatus() {
        const now = Date.now();
        const diff = (now - game.hold.startTime) / 1000; 
        const index = Math.floor(diff / 5);
        game.hold.currentMult = (index + 1) * 10;
        const percent = ((diff % 5) / 5) * 100;
        document.getElementById('channel-fill').style.width = percent + '%';
        document.getElementById('channel-text').innerHTML = `åŸå”± ${diff.toFixed(1)}s | <span style="color:#ffeb3b; font-weight:bold;">x${game.hold.currentMult}å€</span>`;
        
        if(index >= 1) {
            const shake = Math.random() * (index * 1.5);
            document.getElementById('avatar').style.transform = `scale(1.05) translate(${shake}px, ${shake}px)`;
        } else {
             document.getElementById('avatar').style.transform = `scale(1.05)`;
        }
    },

    startSkillHold(idx) {
        if(this.skillHoldTimer) clearInterval(this.skillHoldTimer);
        game.upgradeSkill(idx);
        this.renderSkills(); 
        this.renderCultivate(); // åˆ·æ–°é’±
        this.updateSpirit();
        this.skillHoldTimer = setInterval(() => {
            const success = game.upgradeSkill(idx);
            if(success) {
                this.renderSkills(); 
                this.updateSpirit();
            } else {
                clearInterval(this.skillHoldTimer);
            }
        }, 80);
    },
    endSkillHold() {
        if(this.skillHoldTimer) { clearInterval(this.skillHoldTimer); this.skillHoldTimer = null; }
    },

    fmt(num) {
        if(num < 10000) return Math.floor(num);
        if(num < 100000000) return (num/10000).toFixed(2) + 'ä¸‡';
        if(num < 1000000000000) return (num/100000000).toFixed(2) + 'äº¿';
        if(num < 10000000000000000) return (num/1000000000000).toFixed(2) + 'å…†';
        if(num < 100000000000000000000) return (num/10000000000000000).toFixed(2) + 'äº¬';
        return "âˆ";
    },

    switchTab(t) {
        document.querySelectorAll('.tab-content').forEach(d=>d.classList.remove('show'));
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        document.getElementById('tab-'+t).classList.add('show');
        event.target.classList.add('active');
    },

    log(msg, c='#aaa') {
        const d = document.getElementById('gamelog');
        d.innerHTML = `<div style="color:${c}; margin-bottom:4px;">[${new Date().toLocaleTimeString()}] ${msg}</div>` + d.innerHTML;
    },

    showFloatText(x, y, num) {
        const el = document.createElement('div');
        el.className = 'float-text';
        el.style.left = (x - 20) + 'px';
        el.style.top = (y - 50) + 'px';
        el.innerText = '+' + this.fmt(num);
        document.body.appendChild(el);
        setTimeout(()=>el.remove(), 800);
    },
    
    bgParticle(x, y) {
        const canvas = document.getElementById('bgCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        ctx.fillStyle = 'rgba(0, 242, 255, 0.4)';
        ctx.beginPath();
        ctx.arc(x, y, 4, 0, Math.PI*2);
        ctx.fill();
        setTimeout(()=> ctx.clearRect(0,0,canvas.width,canvas.height), 150);
    },

    render() {
        document.getElementById('player-name').innerText = game.data.name;
        document.getElementById('reincarnate-count').innerText = game.data.reincarnationCount;
        
        // æ¸²æŸ“çµæ ¹å’Œæ³•å®
        const root = CONFIG.ROOTS[game.data.rootIdx];
        const weapon = CONFIG.WEAPONS[game.data.weaponIdx];
        const tDisp = document.getElementById('talent-disp');
        tDisp.innerText = root.name;
        tDisp.className = 'tag-box ' + (game.data.rootIdx >= 6 ? 'tag-god' : '');
        
        const wDisp = document.getElementById('weapon-disp');
        wDisp.innerText = weapon.name;
        wDisp.className = 'tag-box ' + (game.data.weaponIdx >= 6 ? 'tag-god' : '');

        // æ¸²æŸ“å¢ƒç•Œ
        const rName = CONFIG.MAJOR_REALMS[game.data.realmIdx].name;
        const lName = game.data.realmIdx < 9 ? ` ${game.data.layer}å±‚` : "";
        document.getElementById('realm-disp').innerText = rName + lName;
        
        // æ˜¾ç¤ºå½“å‰å€ç‡
        const totalMult = CONFIG.ROOTS[game.data.rootIdx].mult * CONFIG.WEAPONS[game.data.weaponIdx].mult;
        document.getElementById('mult-disp').innerText = `x${totalMult.toFixed(1)}`;

        this.updateSpirit();
        this.renderSkills();
        this.renderCultivate();
    },

    updateSpirit() {
        document.getElementById('spirit-disp').innerText = this.fmt(game.data.spirit);
    },

    renderSkills() {
        const div = document.getElementById('skills-list');
        div.innerHTML = '';
        game.data.skills.forEach((s,i) => {
            const cost = s.cost * Math.pow(1.6, s.level);
            const canBuy = game.data.spirit >= cost;
            const isMax = s.level >= 100;
            
            let displayName = s.name;
            if(isMax) {
                displayName = `<span style="color:var(--rare-purple);font-weight:bold;text-shadow:0 0 5px var(--rare-purple)">è‡³è‡»Â·${s.name}</span>`;
            }

            div.innerHTML += `
                <div class="list-item">
                    <div style="width:65%">
                        <div style="font-weight:bold; color:${isMax?'var(--primary-gold)':'#eee'}; font-size:0.9rem;">
                            ${displayName} <span style="font-size:0.75rem; color:#666">Lv.${s.level}</span>
                        </div>
                        <div style="font-size:0.7rem; color:#666; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${s.desc}</div>
                    </div>
                    <button class="btn-mini ${isMax?'maxed':''}" 
                        ${canBuy?'':'disabled'} 
                        onmousedown="ui.startSkillHold(${i})" onmouseup="ui.endSkillHold()" onmouseleave="ui.endSkillHold()"
                        ontouchstart="ui.startSkillHold(${i})" ontouchend="ui.endSkillHold()"
                    >
                        ${isMax ? 'çªç ´' : 'å‡çº§'} <br><span style="font-size:0.6rem">${this.fmt(cost)}</span>
                    </button>
                </div>
            `;
        });
    },

    renderCultivate() {
        // 1. å¢ƒç•Œ
        const idx = game.data.realmIdx;
        const layer = game.data.layer;
        const nextReq = game.getNextRealmReq();
        const btnU = document.getElementById('btn-realm');
        const btnT = document.getElementById('btn-trib');
        
        if(idx >= 9) {
            document.getElementById('next-realm-name').innerText = "å·²è‡»åŒ–å¢ƒ";
            document.getElementById('req-realm').innerText = "-";
            btnU.classList.add('hidden');
            btnT.classList.add('hidden');
        } else {
            let nextNameStr = layer < 9 ? `${CONFIG.MAJOR_REALMS[idx].name} ${layer+1}å±‚` : `${CONFIG.MAJOR_REALMS[idx+1].name} ä¸€å±‚`;
            document.getElementById('next-realm-name').innerText = nextNameStr;
            document.getElementById('req-realm').innerText = this.fmt(nextReq);

            if(idx === 8 && layer === 9) {
                btnU.classList.add('hidden');
                btnT.classList.remove('hidden');
                document.getElementById('trib-warn').classList.remove('hidden');
                btnT.disabled = game.data.spirit < nextReq;
                if(game.data.spirit < nextReq) { btnT.style.opacity = 0.5; btnT.innerText = "çµåŠ›ä¸è¶³"; }
                else { btnT.style.opacity = 1; btnT.innerText = "é€†å¤©æ”¹å‘½ (ç™¾é›·å¤©åŠ«)"; }
            } else {
                btnU.classList.remove('hidden');
                btnT.classList.add('hidden');
                document.getElementById('trib-warn').classList.add('hidden');
                if(game.data.spirit >= nextReq) {
                    btnU.classList.add('active');
                    btnU.innerText = "çªç ´ç“¶é¢ˆ";
                } else {
                    btnU.classList.remove('active');
                    btnU.innerText = "ç§¯æ”’çµåŠ›ä¸­...";
                }
            }
        }

        // 2. çµæ ¹
        const rIdx = game.data.rootIdx;
        const btnRoot = document.getElementById('btn-root');
        if(rIdx >= CONFIG.ROOTS.length - 1) {
            document.getElementById('next-root-name').innerText = "å·²è¾¾æé™";
            document.getElementById('root-bonus').innerText = "MAX";
            document.getElementById('req-root').innerText = "-";
            btnRoot.disabled = true;
            btnRoot.innerText = "åœ†æ»¡";
            btnRoot.classList.remove('active');
        } else {
            const nextR = CONFIG.ROOTS[rIdx + 1];
            document.getElementById('next-root-name').innerText = nextR.name;
            document.getElementById('root-bonus').innerText = `+${((nextR.mult-1)*100).toFixed(0)}%`;
            document.getElementById('req-root').innerText = this.fmt(nextR.cost);
            if(game.data.spirit >= nextR.cost) {
                btnRoot.classList.add('active');
                btnRoot.innerText = "æ´—é«“ä¼éª¨";
            } else {
                btnRoot.classList.remove('active');
                btnRoot.innerText = "çµåŠ›ä¸è¶³";
            }
        }

        // 3. æ­¦å™¨
        const wIdx = game.data.weaponIdx;
        const btnW = document.getElementById('btn-weapon');
        if(wIdx >= CONFIG.WEAPONS.length - 1) {
            document.getElementById('next-weapon-name').innerText = "ç¥å™¨å·²æˆ";
            document.getElementById('weapon-bonus').innerText = "MAX";
            document.getElementById('req-weapon').innerText = "-";
            btnW.disabled = true;
            btnW.innerText = "åœ†æ»¡";
            btnW.classList.remove('active');
        } else {
            const nextW = CONFIG.WEAPONS[wIdx + 1];
            document.getElementById('next-weapon-name').innerText = nextW.name;
            document.getElementById('weapon-bonus').innerText = `x${nextW.mult.toFixed(1)}`;
            document.getElementById('req-weapon').innerText = this.fmt(nextW.cost);
            if(game.data.spirit >= nextW.cost) {
                btnW.classList.add('active');
                btnW.innerText = "ç¥­ç‚¼æ³•å®";
            } else {
                btnW.classList.remove('active');
                btnW.innerText = "çµåŠ›ä¸è¶³";
            }
        }
    }
};

window.onload = game.init.bind(game);
</script>
</body>
</html>
