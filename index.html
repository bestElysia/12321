<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>无尽修仙：逆天改命</title>
    <style>
        /* =========================================
           CSS 样式表
           ========================================= */
        :root {
            --bg-color: #050505;
            --panel-bg: #111;
            --primary-gold: #ffd700;
            --primary-green: #00e676;
            --neon-blue: #00f2ff;
            --rare-purple: #d500f9;
            --god-tier: #ff0055;
            --text-main: #f0f0f0;
            --border-color: #333;
        }

        * { box-sizing: border-box; user-select: none; -webkit-touch-callout: none; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            overflow: hidden;
            height: 100vh; width: 100vw;
            display: flex; justify-content: center;
            background: #000;
            touch-action: none;
        }

        .bg-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }
        
        #vfx-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 9000; pointer-events: none; overflow: hidden;
        }

        #app {
            position: relative; z-index: 10; width: 100%; max-width: 600px; height: 100%;
            display: flex; flex-direction: column;
            background: radial-gradient(circle at center, rgba(20,20,30,0.5) 0%, rgba(0,0,0,1) 100%);
        }

        /* --- 悬浮灵力球 --- */
        #float-spirit {
            position: fixed; top: 15%; right: 0; z-index: 9999;
            background: rgba(20, 20, 20, 0.9);
            border: 1px solid var(--primary-green);
            border-radius: 20px 0 0 20px; border-right: none;
            padding: 8px 12px 8px 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.6);
            backdrop-filter: blur(8px);
            display: flex; flex-direction: column; align-items: flex-end;
            cursor: move; touch-action: none; transition: transform 0.1s;
        }
        #float-spirit.dock-left {
            border-radius: 0 20px 20px 0; border-left: none; border-right: 1px solid var(--primary-green);
            align-items: flex-start; padding: 8px 16px 8px 12px;
        }
        .spirit-label-float { font-size: 0.65rem; color: #aaa; margin-bottom: 2px; letter-spacing: 1px;}
        .spirit-val-float { 
            font-family: 'Courier New', monospace; 
            font-size: 1.1rem; color: var(--primary-green); font-weight: 800; 
            text-shadow: 0 0 10px rgba(0, 230, 118, 0.3); white-space: nowrap;
        }

        /* --- 核心点击区 --- */
        #click-area {
            height: 40%; position: relative; display: flex; flex-direction: column;
            justify-content: flex-end; align-items: center; cursor: pointer;
            transition: background 0.2s; touch-action: manipulation; padding-bottom: 30px; 
        }

        /* --- Avatar 容器 --- */
        .avatar-container {
            width: 200px; height: 200px; 
            display: flex; justify-content: center; align-items: center;
            position: relative; margin-bottom: 15px;
            z-index: 20;
        }

        /* 散发光晕 (Aura) - 默认隐藏 */
        .core-aura {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 50px; height: 50px; border-radius: 50%;
            background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, rgba(0,242,255,0.2) 60%, transparent 80%);
            opacity: 0; pointer-events: none; z-index: 4;
            transition: opacity 0.5s;
        }

        /* 灵能核心 */
        .energy-core {
            width: 46px; height: 46px; background: #fff; border-radius: 50%;
            box-shadow: 0 0 30px var(--primary-gold), 0 0 60px var(--primary-gold);
            animation: corePulse 3s infinite ease-in-out;
            z-index: 5; position: relative;
            /* 关键：增加过渡效果 */
            transition: transform 0.1s linear, box-shadow 0.1s linear, background 0.2s;
            will-change: transform, box-shadow;
        }
        
        .avatar-container:not(.channeling) .energy-core::after {
            content: ''; position: absolute; top: 50%; left: 50%; width: 100%; height: 100%;
            border-radius: 50%; border: 2px solid rgba(255, 215, 0, 0.6);
            transform: translate(-50%, -50%) scale(0.8);
            animation: rippleAnim 2s infinite linear; opacity: 0;
        }
        @keyframes rippleAnim {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0.8; border-width: 4px;}
            100% { transform: translate(-50%, -50%) scale(2.5); opacity: 0; border-width: 1px;}
        }
        
        /* 旋转光环 */
        .energy-ring {
            position: absolute; border-radius: 50%;
            border: 1px solid rgba(255, 215, 0, 0.3);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.1);
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .ring-1 { width: 100px; height: 100px; border-top-color: var(--primary-gold); animation: spin 8s linear infinite; }
        .ring-2 { width: 140px; height: 140px; border-bottom-color: var(--primary-gold); animation: spin 12s linear infinite reverse; }
        .ring-3 { width: 190px; height: 190px; border: 1px dashed rgba(255, 255, 255, 0.1); animation: spin 20s linear infinite; }

        /* === 汇聚状态 (长按) 核心样式修改 === */
        
        /* 1. 核心: 变大、超级亮 */
        .avatar-container.channeling .energy-core { 
            animation: none; 
            background: #fff; /* 纯白核心 */
        }
        .avatar-container.channeling .energy-core::after { display: none; }
        
        /* 2. 开启光晕扩散动画 */
        .avatar-container.channeling .core-aura {
            opacity: 1;
            animation: auraPulse 1s infinite ease-out;
        }
        @keyframes auraPulse {
            0% { width: 50px; height: 50px; opacity: 0.8; }
            100% { width: 250px; height: 250px; opacity: 0; }
        }

        /* 3. 光环: 亮蓝，加速 */
        .avatar-container.channeling .energy-ring { 
            border-color: rgba(0, 242, 255, 0.9); 
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.5);
            border-width: 2px; 
        }
        .avatar-container.channeling .ring-1 { animation: spin 1s linear infinite; border-top-color: #fff; }
        .avatar-container.channeling .ring-2 { animation: spin 1.5s linear infinite reverse; border-bottom-color: var(--neon-blue); }
        .avatar-container.channeling .ring-3 { 
            border-style: solid; border-color: rgba(0, 242, 255, 0.3); 
            width: 180px; height: 180px;
            animation: spin 3s linear infinite; 
        }

        .realm-badge {
            position: absolute; bottom: -10px;
            background: linear-gradient(90deg, #000, #222, #000);
            border: 1px solid var(--primary-gold); color: var(--primary-gold);
            padding: 4px 16px; border-radius: 20px; font-size: 0.85rem; font-weight: bold;
            box-shadow: 0 0 15px rgba(255, 193, 7, 0.3); white-space: nowrap; z-index: 10;
        }

        @keyframes corePulse { 0%, 100% { transform: scale(0.9); opacity: 0.8; } 50% { transform: scale(1.15); opacity: 1; } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* 进度条 */
        .channel-container-wrapper { width: 70%; display: flex; flex-direction: column; align-items: center; height: 40px; justify-content: center; }
        .channel-bar { width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; position: relative; opacity: 0; margin-bottom: 8px;}
        .channel-bar.active { opacity: 1; }
        .channel-fill { height: 100%; background: var(--neon-blue); width: 0%; border-radius: 3px; box-shadow: 0 0 10px var(--neon-blue); }
        .hint-text { color: #555; font-size: 0.8rem; transition: color 0.2s; }
        .hint-text.active { color: var(--neon-blue); font-weight: bold; text-shadow: 0 0 5px var(--neon-blue); }

        /* 面板样式 */
        #panel-container { 
            flex: 1; background: var(--panel-bg); 
            border-top: 1px solid #222; border-radius: 20px 20px 0 0;
            display: flex; flex-direction: column;
            box-shadow: 0 -5px 30px rgba(0,0,0,0.8); overflow: hidden;
        }
        .tabs { display: flex; background: rgba(0,0,0,0.3); border-bottom: 1px solid #222; padding: 0 10px; }
        .tab-btn {
            flex: 1; padding: 15px 0; background: transparent; border: none; color: #666;
            font-size: 0.95rem; font-weight: bold; cursor: pointer; position: relative;
        }
        .tab-btn.active { color: var(--primary-gold); }
        .tab-btn.active::after {
            content: ''; position: absolute; bottom: 0; left: 25%; width: 50%; height: 3px; 
            background: var(--primary-gold); border-radius: 3px 3px 0 0; box-shadow: 0 -2px 10px rgba(255, 193, 7, 0.5);
        }
        .tab-content { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 80px; display: none; -webkit-overflow-scrolling: touch; }
        .tab-content.show { display: block; animation: fadeIn 0.3s; }

        /* Dashboard */
        .dashboard-card {
            background: linear-gradient(135deg, #222, #1a1a1a);
            border: 1px solid #333; border-radius: 12px; padding: 15px; margin-bottom: 20px;
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }
        .dash-row { grid-column: span 2; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 8px; margin-bottom: 8px; }
        .dash-item { display: flex; flex-direction: column; }
        .dash-label { font-size: 0.7rem; color: #666; margin-bottom: 4px; }
        .tag-badge { 
            display: inline-block; font-size: 0.75rem; padding: 2px 8px; border-radius: 4px; 
            background: rgba(255,255,255,0.05); border: 1px solid #444; color: #aaa;
        }
        .tag-badge.god { border-color: var(--god-tier); color: var(--god-tier); background: rgba(255,0,85,0.1); }
        .tag-badge.rare { border-color: var(--rare-purple); color: var(--rare-purple); background: rgba(213,0,249,0.1); }

        .quick-actions { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .btn-onekey {
            background: linear-gradient(90deg, #2196f3, #00e5ff); color: #000; border: none;
            padding: 8px 20px; border-radius: 20px; font-size: 0.85rem; font-weight: 800;
            box-shadow: 0 0 15px rgba(33, 150, 243, 0.4); cursor: pointer; transition: transform 0.1s;
        }
        .btn-onekey:active { transform: scale(0.95); }

        .list-item {
            background: #181818; border: 1px solid #2a2a2a; padding: 12px; margin-bottom: 8px; border-radius: 8px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .btn-upgrade {
            min-width: 80px; text-align: center; background: transparent; border: 1px solid var(--primary-green); color: var(--primary-green);
            padding: 6px 0; border-radius: 6px; font-size: 0.8rem; cursor: pointer;
        }
        .btn-upgrade:disabled { border-color: #333; color: #444; }
        .btn-upgrade.maxed { border-color: var(--primary-gold); color: var(--primary-gold); background: rgba(255,215,0,0.05); }

        .cultivate-section { margin-bottom: 15px; border-bottom: 1px dashed #333; padding-bottom: 15px; }
        .cultivate-header { color: #fff; font-size: 0.95rem; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;}

        .cultivate-btn-lg {
            width: 100%; padding: 14px; border: none; font-size: 1rem; font-weight: bold; border-radius: 8px; 
            margin-top: 8px; cursor: pointer; touch-action: manipulation; background: #222; color: #888; transition: all 0.1s;
        }
        .cultivate-btn-lg:active { transform: scale(0.97); }
        .cultivate-btn-lg.active { background: var(--primary-green); color: #000; box-shadow: 0 4px 0 #00b359; }
        .cultivate-btn-lg.active:active { box-shadow: 0 0 0; transform: translateY(4px); }
        .cultivate-btn-lg.active.risk { background: linear-gradient(135deg, #ff9800, #ff5722); color: white; box-shadow: 0 4px 0 #bf360c; }
        .cultivate-btn-lg.active.risk:active { box-shadow: 0 0 0; transform: translateY(4px); }
        .cultivate-btn-lg.trib { 
            background: linear-gradient(45deg, #d32f2f, #b71c1c); color: #fff; animation: pulse 1.5s infinite; 
            box-shadow: 0 0 20px rgba(211, 47, 47, 0.4);
        }

        .float-text {
            position: absolute; color: #fff; font-weight: bold; pointer-events: none;
            animation: floatUp 0.8s forwards; font-size: 1.4rem; text-shadow: 2px 2px 0 #000; z-index: 100;
        }

        .crit-text {
            position: absolute; color: #ffd700; font-weight: 900; pointer-events: none;
            animation: critPop 1s forwards; font-size: 2rem; 
            text-shadow: 0 0 10px #ff0000, 0 0 20px #ffd700; z-index: 110;
        }
        @keyframes critPop { 0% { transform: scale(0.5); opacity: 0; } 20% { transform: scale(1.5); opacity: 1; } 100% { transform: scale(1) translateY(-100px); opacity: 0; } }

        .particle {
            position: absolute; width: 6px; height: 6px; border-radius: 50%; pointer-events: none; opacity: 1;
        }
        @keyframes particleFly { 0% { transform: translate(0, 0) scale(1); opacity: 1; } 100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; } }

        /* 汇聚灵气光点 */
        .spirit-particle {
            position: fixed; width: 6px; height: 6px; background: #fff; border-radius: 50%;
            box-shadow: 0 0 8px #fff, 0 0 16px var(--neon-blue), 0 0 32px var(--neon-blue);
            pointer-events: none; animation: spiritGather 1.5s ease-in forwards; z-index: 9999;
            will-change: transform, opacity, top, left;
        }
        @keyframes spiritGather {
            0% { top: var(--sy); left: var(--sx); opacity: 0; transform: scale(0.2); }
            10% { opacity: 1; transform: scale(1); }
            80% { opacity: 1; transform: scale(1); }
            100% { top: var(--ey); left: var(--ex); opacity: 0; transform: scale(0.5); }
        }

        #tribulation-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.96); z-index: 2000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .thunder-bolt {
            position: absolute; top: 0; left: 50%; width: 6px; height: 100%;
            background: #fff; box-shadow: 0 0 40px #fff, 0 0 100px #7b1fa2;
            transform: translateX(-50%) scaleY(0); transform-origin: top; opacity: 0;
        }
        .thunder-strike { animation: strike 0.08s; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-80px) scale(1.2); opacity: 0; } }
        @keyframes strike { 0% { transform: translateX(-50%) scaleY(0); opacity: 1; } 50% { transform: translateX(-50%) scaleY(1); opacity: 1; } 100% { transform: translateX(-50%) scaleY(1); opacity: 0; } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        .hidden { display: none !important; }
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85);
            display: flex; justify-content: center; align-items: center; z-index: 3000; backdrop-filter: blur(8px);
        }
        .modal-box {
            background: #1a1a1a; padding: 30px; border-radius: 16px; border: 1px solid var(--border-color);
            text-align: center; width: 85%; max-width: 360px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            position: relative; overflow: hidden;
        }
        input { background: #222; border: 1px solid #444; color: white; padding: 12px; margin: 20px 0; width: 100%; text-align: center; border-radius: 6px; font-size: 1.1rem;}

        /* 胜利相关 */
        .modal.victory-mode { background: radial-gradient(circle at center, rgba(255, 215, 0, 0.3) 0%, rgba(0,0,0,0.95) 70%); }
        .modal-box.victory-box {
            background: linear-gradient(135deg, #2a2a2a, #1a1a1a); border: 2px solid var(--primary-gold);
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.4), inset 0 0 20px rgba(255, 215, 0, 0.2);
            animation: victoryPop 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes victoryPop { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .victory-title {
            font-size: 2.5rem; color: var(--primary-gold); margin: 0 0 10px 0;
            background: linear-gradient(to bottom, #fff, #ffd700); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            animation: titleShine 3s infinite alternate;
        }
        @keyframes titleShine { from { filter: brightness(1); } to { filter: brightness(1.3); } }
        .victory-badge {
            display: inline-block; padding: 5px 20px; background: rgba(255, 215, 0, 0.1);
            border: 1px solid var(--primary-gold); border-radius: 30px;
            color: var(--primary-gold); font-weight: bold; font-size: 1.1rem; margin-bottom: 20px;
            animation: pulse 2s infinite;
        }
        .victory-desc { color: #ddd; font-size: 0.95rem; line-height: 1.6; margin-bottom: 30px; }
        .victory-btn { background: linear-gradient(90deg, #ffd700, #ffab00); color: #000; border: none; box-shadow: 0 5px 25px rgba(255, 215, 0, 0.5); }
        .victory-particle {
            position: absolute; width: 4px; height: 4px; background: var(--primary-gold); border-radius: 50%;
            box-shadow: 0 0 10px var(--primary-gold); pointer-events: none; bottom: 0; opacity: 0; animation: victoryRise 3s infinite ease-in;
        }
        @keyframes victoryRise {
            0% { transform: translateY(0) scale(1); opacity: 0; } 20% { opacity: 1; } 100% { transform: translateY(-400px) scale(0.5); opacity: 0; }
        }
    </style>
</head>
<body>

    <canvas id="bgCanvas" class="bg-canvas"></canvas>
    <div id="vfx-layer"></div>

    <div id="float-spirit">
        <div class="spirit-label-float">天地灵力</div>
        <div class="spirit-val-float" id="spirit-disp">0</div>
    </div>

    <div id="app">
        <div id="click-area">
            <div class="avatar-container" id="avatar">
                <div class="core-aura"></div>
                <div class="energy-core"></div>
                <div class="energy-ring ring-1"></div>
                <div class="energy-ring ring-2"></div>
                <div class="energy-ring ring-3"></div>
                <div class="realm-badge" id="realm-disp">炼气期 一层</div>
            </div>
            
            <div class="channel-container-wrapper">
                <div id="channel-container" class="channel-bar">
                    <div class="channel-fill" id="channel-fill"></div>
                </div>
                <div class="hint-text" id="channel-text">长按 <span style="color:var(--neon-blue)">汇聚灵气</span></div>
            </div>
        </div>

        <div id="panel-container">
            <div class="tabs">
                <button class="tab-btn active" onclick="ui.switchTab('skills')">功法秘籍</button>
                <button class="tab-btn" onclick="ui.switchTab('cultivate')">洞府修炼</button>
                <button class="tab-btn" onclick="ui.switchTab('log')">仙途日志</button>
            </div>

            <div id="tab-skills" class="tab-content show">
                <div class="dashboard-card">
                    <div class="dash-row">
                        <div><span style="color:#666">道号:</span> <span id="player-name" style="color:var(--primary-gold); font-weight:bold;">道友</span></div>
                        <div style="font-size:0.75rem; color:#666">第 <span id="reincarnate-count" style="color:#eee">0</span> 世轮回</div>
                    </div>
                    <div class="dash-item">
                        <span class="dash-label">灵根资质</span>
                        <div id="talent-disp" class="tag-badge">凡品</div>
                    </div>
                    <div class="dash-item" style="align-items: flex-end;">
                        <span class="dash-label">本命法宝</span>
                        <div id="weapon-disp" class="tag-badge">铁剑</div>
                    </div>
                </div>

                <div class="quick-actions">
                    <span style="font-size:0.75rem;color:#666;">至臻·功法可抵御天劫</span>
                    <button class="btn-onekey" onclick="game.upgradeAllSkills()">⚡ 一键升级</button>
                </div>
                <div id="skills-list"></div>
            </div>

            <div id="tab-cultivate" class="tab-content">
                <div class="cultivate-section">
                    <div class="cultivate-header">
                        <span>境界突破</span>
                        <span id="next-realm-name" style="color:var(--primary-gold)">炼气期 二层</span>
                    </div>
                    <div style="font-size:0.8rem; color:#666; margin-bottom:8px;">所需灵力: <span id="req-realm" style="color:#fff">100</span></div>
                    
                    <button id="btn-realm" class="cultivate-btn-lg" onclick="game.upgradeRealm()">突破瓶颈</button>
                    <button id="btn-trib" class="cultivate-btn-lg trib hidden" onclick="game.startTribulation()">逆天改命 (百雷天劫)</button>
                    
                    <div id="trib-warn" class="hidden" style="margin-top:10px; background:rgba(255,59,48,0.1); padding:8px; border-radius:4px; border:1px solid rgba(255,59,48,0.3);">
                        <div style="color:#ff3b30; font-size:0.75rem; font-weight:bold; margin-bottom:4px;">⚠️ 天劫预警</div>
                        <div style="color:#aaa; font-size:0.7rem; line-height:1.4;">
                            雷劫共100道，威力逐级递增。<br>
                            当前护体值: <span id="protect-val-preview" style="color:#fff; font-weight:bold;">0%</span> (功法+灵根+法宝)
                        </div>
                    </div>
                </div>

                <div class="cultivate-section">
                    <div class="cultivate-header">
                        <span>淬炼灵根</span>
                    </div>
                    <div style="font-size:0.8rem; color:#666; margin-bottom:5px; display:flex; justify-content:space-between;">
                        <span>下阶: <span id="next-root-name" style="color:var(--neon-blue)">下品灵根</span></span>
                        <span id="root-bonus" style="color:var(--primary-green)"></span>
                    </div>
                    <div style="font-size:0.8rem; color:#666;">消耗: <span id="req-root" style="color:#fff">500</span></div>
                    <button id="btn-root" class="cultivate-btn-lg" onclick="game.upgradeRoot()">洗髓伐骨</button>
                </div>

                <div class="cultivate-section" style="border:none;">
                    <div class="cultivate-header">
                        <span>祭炼法宝</span>
                    </div>
                    <div style="font-size:0.8rem; color:#666; margin-bottom:5px; display:flex; justify-content:space-between;">
                        <span>下阶: <span id="next-weapon-name" style="color:var(--rare-purple)">木剑</span></span>
                        <span id="weapon-bonus" style="color:var(--primary-green)"></span>
                    </div>
                    <div style="font-size:0.8rem; color:#666;">消耗: <span id="req-weapon" style="color:#fff">1,000</span></div>
                    <button id="btn-weapon" class="cultivate-btn-lg" onclick="game.upgradeWeapon()">祭炼法宝</button>
                </div>
            </div>

            <div id="tab-log" class="tab-content">
                <div id="gamelog" style="font-size: 0.75rem; line-height: 1.8; color: #888;"></div>
            </div>
        </div>
    </div>

    <div id="modal-start" class="modal">
        <div class="modal-box">
            <h2 style="color: var(--primary-gold); margin-top:0;">踏入仙途</h2>
            <p style="color:#888;font-size:0.85rem; margin-bottom:20px;">凡人修仙，逆天改命</p>
            <input type="text" id="inp-name" placeholder="请输入道号" maxlength="6">
            <button class="cultivate-btn-lg active" onclick="game.startGame()">开始修仙</button>
        </div>
    </div>

    <div id="tribulation-overlay" class="hidden">
        <div class="thunder-bolt" id="thunder-vfx"></div>
        <div style="z-index: 2002; text-align: center; width: 85%;">
            <h1 style="color: #ffeb3b; text-shadow: 0 0 20px red; font-size:2.5rem; margin:0 0 20px 0;">天劫降临</h1>
            <div style="display:flex; justify-content:space-between; width:100%; margin-bottom:5px; font-size:0.8rem; color:#aaa;">
                <span>护体灵光</span>
                <span id="trib-hp-text">100%</span>
            </div>
            <div style="width:100%; background:#333; height:8px; border-radius:4px; margin-bottom:20px; overflow:hidden;">
                <div id="trib-hp-bar" style="width:100%; height:100%; background:linear-gradient(90deg, #00e676, #69f0ae); transition: width 0.1s;"></div>
            </div>
            <h2 id="trib-step" style="color: white; font-family: monospace; font-size:1.5rem; margin-bottom:20px;">准备抗劫</h2>
            <div id="trib-console" style="height: 160px; overflow-y: scroll; background: rgba(0,0,0,0.5); border: 1px solid #444; padding: 15px; font-size: 0.75rem; text-align: left; border-radius:8px;"></div>
        </div>
    </div>

    <div id="modal-end" class="modal hidden">
        <div class="modal-box" id="modal-end-box">
            </div>
    </div>

<script>
// --- 核心数值配置重构 ---
// power: 代表每升一级增加的基础倍率。2代表第一级x2, 第二级x4(或累加)
// 需求：每级效能2倍，每升1级增加一倍 => 这里的 power 定义为 "单级提供的基础倍率增量"
// 线性插值生成 2 -> 100 的数值
const generateSkills = () => {
    const skills = [
        "基础吐纳", "清尘术", "水球术", "大水球术", "碧水心法", 
        "碧水剑法", "大衍龟息决", "烈火燎原诀", "厚土金钟罩", "青木长生功",
        "庚金白虎杀", "紫气东来", "太上感应篇", "北冥神功", "八九玄功",
        "袖里乾坤", "真·吃吃吃", "吞天魔功", "一念花开", "万剑归宗"
    ];
    return skills.map((name, i) => {
        // Power 线性增长：从 2 到 100
        const power = 2 + (98 * i / 19);
        const baseCost = 100 * Math.pow(5, i);
        return { 
            name, 
            cost: baseCost, 
            power: Math.round(power * 10) / 10, // 保留一位小数
            desc: `每级效能 +${Math.round(power)}倍` 
        };
    });
};

const CONFIG = {
    MAJOR_REALMS: [
        { name: "炼气期", baseReq: 100, exp: 1.5 },     
        { name: "筑基期", baseReq: 10000, exp: 1.6 },    
        { name: "金丹期", baseReq: 500000, exp: 1.7 },   
        { name: "元婴期", baseReq: 10000000, exp: 1.8 },  
        { name: "化神期", baseReq: 500000000, exp: 1.9 },
        { name: "炼虚期", baseReq: 20000000000, exp: 2.0 }, 
        { name: "合体期", baseReq: 500000000000, exp: 2.1 }, 
        { name: "大乘期", baseReq: 10000000000000, exp: 2.2 }, 
        { name: "渡劫期", baseReq: 500000000000000, exp: 2.3 }, 
        { name: "陆地真仙", baseReq: 0, exp: 1 }
    ],
    ROOTS: [
        { name: "凡品废灵根", mult: 1, cost: 0, tag: '凡品' },
        { name: "下品灵根", mult: 10, cost: 1000, tag: '下品' },
        { name: "中品灵根", mult: 100, cost: 50000, tag: '中品' },
        { name: "上品灵根", mult: 1000, cost: 1000000, tag: '上品' },
        { name: "地灵根", mult: 10000, cost: 20000000, tag: '地品' },
        { name: "天灵根", mult: 100000, cost: 500000000, tag: '天品' },
        { name: "极品天灵根", mult: 1000000, cost: 10000000000, tag: '极品' },
        { name: "变异雷灵根", mult: 10000000, cost: 500000000000, tag: '变异' },
        { name: "仙灵根", mult: 100000000, cost: 10000000000000, tag: '仙品' },
        { name: "绝世无双", mult: 1000000000, cost: 999999999999999, tag: '绝世' } 
    ],
    WEAPONS: [
        { name: "破树枝", mult: 1, cost: 0, tag: '凡铁' },
        { name: "生锈铁剑", mult: 10, cost: 5000, tag: '凡铁' },
        { name: "精钢剑", mult: 100, cost: 100000, tag: '凡铁' },
        { name: "寒铁剑", mult: 1000, cost: 2000000, tag: '灵器' },
        { name: "青锋剑", mult: 10000, cost: 50000000, tag: '灵器' },
        { name: "碧水剑", mult: 100000, cost: 1000000000, tag: '法宝' },
        { name: "真·碧水剑", mult: 1000000, cost: 50000000000, tag: '法宝' },
        { name: "碧水剑 (极)", mult: 10000000, cost: 2000000000000, tag: '古宝' },
        { name: "碧水剑 (臻)", mult: 100000000, cost: 100000000000000, tag: '灵宝' },
        { name: "轩辕剑", mult: 1000000000, cost: 9999999999999999, tag: '神器' }
    ],
    SKILLS: generateSkills()
};

const game = {
    data: {
        name: "无名",
        spirit: 0,
        realmIdx: 0, layer: 1, 
        rootIdx: 0, 
        weaponIdx: 0,
        skills: CONFIG.SKILLS.map(s => ({...s, level: 0})),
        reincarnationCount: 0,
        isTribulating: false,
        rootFails: 0,
        weaponFails: 0,
        realmFails: 0
    },
    
    // hold: 增加 critMult 用于存储暴击翻倍
    hold: { active: false, startTime: 0, timer: null, currentMult: 1, critMult: 1, lastCritTime: 0 },

    init() { ui.init(); this.loop(); },

    startGame() {
        const n = document.getElementById('inp-name').value.trim();
        if(n) this.data.name = n;
        document.getElementById('modal-start').classList.add('hidden');
        ui.log(`道友 <b>${this.data.name}</b> 踏入仙途。`);
        ui.render();
    },

    getClickPower() {
        const base = Math.pow(this.data.realmIdx + 1, 3) * this.data.layer;
        
        let skillMult = 1;
        this.data.skills.forEach(s => {
            if(s.level > 0) {
                // 新公式：基础倍率 * 等级。 例如 基础效能2，等级10 => x20
                // 叠加方式：不同功法之间通常是乘法
                // 但为了避免数值过早溢出，这里使用 (1 + Power*Level)
                skillMult *= (1 + s.power * s.level);
            }
        });

        const rootMult = CONFIG.ROOTS[this.data.rootIdx].mult;
        const weaponMult = CONFIG.WEAPONS[this.data.weaponIdx].mult;
        // 总长按倍率 = 时间倍率 * 暴击倍率
        const holdMult = this.hold.currentMult * this.hold.critMult;

        return base * skillMult * rootMult * weaponMult * holdMult;
    },

    processClick(e) {
        if(this.data.isTribulating) return;
        const gain = this.getClickPower();
        this.data.spirit += gain;
        
        const isAuto = !e; 
        if(!isAuto && e.isTrusted) {
            ui.showFloatText(e.clientX, e.clientY, gain);
            ui.bgParticle(e.clientX, e.clientY);
        } else if (isAuto) {
            if(Math.random() > 0.7) {
                const x = window.innerWidth / 2 + (Math.random()*60 - 30);
                const y = window.innerHeight * 0.3 + (Math.random()*40 - 20);
                ui.showFloatText(x, y, gain);
            }
        }
        ui.updateSpirit();
    },

    upgradeAllSkills() {
        let upgraded = false;
        let attempts = 0;
        while(attempts < 20) {
            let passUpgraded = false;
            this.data.skills.forEach(s => {
                const cost = s.cost * Math.pow(1.6, s.level);
                if(s.level < 100 && this.data.spirit >= cost) {
                    this.data.spirit -= cost;
                    s.level++;
                    passUpgraded = true;
                    upgraded = true;
                }
            });
            if(!passUpgraded) break;
            attempts++;
        }
        
        if(upgraded) {
            ui.log("一键升级完成", "var(--neon-blue)");
            ui.renderSkills();
            ui.renderCultivate();
            ui.updateSpirit();
        } else {
            ui.log("灵力不足，无法提升", "#666");
        }
    },

    upgradeSkill(idx) {
        const s = this.data.skills[idx];
        const cost = s.cost * Math.pow(1.6, s.level);
        if(this.data.spirit >= cost) {
            this.data.spirit -= cost;
            s.level++;
            return true;
        }
        return false;
    },

    upgradeRoot() {
        if(this.data.rootIdx >= CONFIG.ROOTS.length - 1) return;
        const next = CONFIG.ROOTS[this.data.rootIdx + 1];
        if(this.data.spirit >= next.cost) {
            this.data.spirit -= next.cost;
            const btn = document.getElementById('btn-root');
            const rect = btn.getBoundingClientRect();
            
            const success = (Math.random() < 0.3) || (this.data.rootFails >= 19);
            
            if(success) {
                this.data.rootIdx++;
                this.data.rootFails = 0;
                ui.createExplosion(rect.left + rect.width/2, rect.top + rect.height/2, '#00e676');
                ui.log(`洗髓成功！灵根进阶为 [${next.name}]！`, 'var(--primary-green)');
            } else {
                this.data.rootFails++;
                ui.createExplosion(rect.left + rect.width/2, rect.top + rect.height/2, '#ff3b30'); 
                ui.log(`洗髓失败，气血翻涌...`, '#ff3b30');
            }
            ui.render();
        }
    },

    upgradeWeapon() {
        if(this.data.weaponIdx >= CONFIG.WEAPONS.length - 1) return;
        const next = CONFIG.WEAPONS[this.data.weaponIdx + 1];
        if(this.data.spirit >= next.cost) {
            this.data.spirit -= next.cost;
            const btn = document.getElementById('btn-weapon');
            const rect = btn.getBoundingClientRect();

            const success = (Math.random() < 0.3) || (this.data.weaponFails >= 19);
            
            if(success) {
                this.data.weaponIdx++;
                this.data.weaponFails = 0;
                ui.createExplosion(rect.left + rect.width/2, rect.top + rect.height/2, '#e040fb');
                ui.log(`祭炼成功！法宝晋升为 [${next.name}]！`, 'var(--rare-purple)');
            } else {
                this.data.weaponFails++;
                ui.createExplosion(rect.left + rect.width/2, rect.top + rect.height/2, '#ff3b30');
                ui.log(`祭炼失败，灵材损毁...`, '#ff3b30');
            }
            ui.render();
        }
    },

    upgradeRealm() {
        const nextReq = this.getNextRealmReq();
        if(this.data.spirit >= nextReq) {
            this.data.spirit -= nextReq;
            const btn = document.getElementById('btn-realm');
            const rect = btn.getBoundingClientRect();
            
            const success = (Math.random() < 0.7) || (this.data.realmFails >= 4);
            
            if(success) {
                this.data.realmFails = 0;
                if(this.data.layer < 9) {
                    this.data.layer++;
                    ui.createExplosion(rect.left + rect.width/2, rect.top + rect.height/2, '#ffc107');
                    ui.log(`突破至 [${CONFIG.MAJOR_REALMS[this.data.realmIdx].name} ${this.data.layer}层]`, 'var(--primary-gold)');
                } else {
                    if(this.data.realmIdx === 8 && this.data.layer === 9) return; 
                    this.data.realmIdx++;
                    this.data.layer = 1;
                    ui.createExplosion(rect.left + rect.width/2, rect.top + rect.height/2, '#ff5722');
                    ui.log(`=== 晋升 [${CONFIG.MAJOR_REALMS[this.data.realmIdx].name}] ===`, 'var(--god-tier)');
                }
            } else {
                this.data.realmFails++;
                ui.createExplosion(rect.left + rect.width/2, rect.top + rect.height/2, '#ff3b30');
                if(this.data.layer > 1) {
                    this.data.layer--;
                    ui.log("突破失败，境界跌落至" + this.data.layer + "层!", "#ff3b30");
                } else {
                    ui.log("突破失败，根基不稳!", "#ff3b30");
                }
            }
            ui.render();
        }
    },

    getNextRealmReq() {
        const major = CONFIG.MAJOR_REALMS[this.data.realmIdx];
        if(!major) return 0;
        return major.baseReq * Math.pow(this.data.layer, major.exp);
    },

    getProtectionScore() {
        const totalSkills = this.data.skills.length;
        const maxedSkills = this.data.skills.filter(s => s.level >= 100).length;
        const skillScore = (maxedSkills / totalSkills) * 50;
        const rootProgress = this.data.rootIdx / (CONFIG.ROOTS.length - 1);
        const rootScore = rootProgress * 25;
        const weaponProgress = this.data.weaponIdx / (CONFIG.WEAPONS.length - 1);
        const weaponScore = weaponProgress * 25;
        return Math.min(100, skillScore + rootScore + weaponScore);
    },

    startTribulation() {
        this.data.isTribulating = true;
        document.getElementById('tribulation-overlay').classList.remove('hidden');
        document.getElementById('trib-console').innerHTML = '';
        document.getElementById('trib-hp-bar').style.width = '100%';
        document.getElementById('trib-hp-text').innerText = '100%';
        this.runTribulation();
    },

    async runTribulation() {
        const log = (m, c='#fff') => {
            const d = document.getElementById('trib-console');
            d.innerHTML += `<div style="color:${c}; margin-bottom:2px;">${m}</div>`;
            d.scrollTop = d.scrollHeight;
        };
        const thunder = document.getElementById('thunder-vfx');
        const countDisp = document.getElementById('trib-step');
        
        const playerProtection = this.getProtectionScore();
        log(`护体神光强度: ${playerProtection.toFixed(1)}/100`, "#00f2ff");

        let survived = true;
        let hp = 100;
        
        for(let i=1; i<=100; i++) {
            countDisp.innerText = `${i} / 100 道`;
            
            const difficulty = i - 1; 
            const baseChance = 100 - difficulty; 
            const finalChance = baseChance + playerProtection;
            
            const roll = Math.random() * 100;
            
            thunder.classList.add('thunder-strike');
            setTimeout(()=>thunder.classList.remove('thunder-strike'), 30);
            
            if (roll > finalChance) {
                log(`第 ${i} 道: 护体击穿!`, "#ff3b30");
                survived = false;
                break;
            } else {
                if(i % 20 === 0 || i === 1) log(`第 ${i} 道: 成功抵御`, "#888");
            }
            
            hp = 100 - i;
            document.getElementById('trib-hp-bar').style.width = hp + '%';
            document.getElementById('trib-hp-text').innerText = hp + '%';

            await this.sleep(40);
        }

        if(survived) {
            log("渡劫成功，肉身成圣！", "#4caf50");
            await this.sleep(1000);
            this.handleWin();
        } else {
            log("魂飞魄散...", "#ff0000");
            await this.sleep(1000);
            this.handleDeath();
        }
    },

    handleWin() {
        this.data.isTribulating = false;
        document.getElementById('tribulation-overlay').classList.add('hidden');
        this.data.realmIdx++; 
        this.data.layer = 1;
        
        const modal = document.getElementById('modal-end');
        const modalBox = document.getElementById('modal-end-box');
        modal.classList.remove('hidden');
        modal.classList.add('victory-mode'); 
        modalBox.classList.add('victory-box');

        modalBox.innerHTML = `
            <div style="position:absolute; top:0; left:0; width:100%; height:100%; overflow:hidden; pointer-events:none;" id="victory-particles"></div>
            <h1 class="victory-title">证道真仙</h1>
            <div class="victory-badge">绝世无双</div>
            <p class="victory-desc">恭喜道友 <b>${this.data.name}</b><br>渡过百雷天劫，肉身成圣，位列仙班！<br>修仙之路漫漫，此世已臻圆满。</p>
            <button class="cultivate-btn-lg active victory-btn" onclick="game.reincarnate()">再入轮回</button>
        `;
        
        ui.createVictoryParticles();
    },

    handleDeath() {
        this.data.isTribulating = false;
        document.getElementById('tribulation-overlay').classList.add('hidden');
        const modal = document.getElementById('modal-end');
        const modalBox = document.getElementById('modal-end-box');
        modal.classList.remove('hidden');
        modal.classList.remove('victory-mode');
        modalBox.classList.remove('victory-box');

        modalBox.innerHTML = `
            <h1 id="end-title" style="color: #ff3b30; margin-top:0;">陨落</h1>
            <p id="end-desc" style="color:#bbb; margin:20px 0;">天威难测，道友 ${this.data.name} 不幸陨落在天劫之下。<br>请重新来过。</p>
            <button class="cultivate-btn-lg active" onclick="game.reincarnate()">转世重修</button>
        `;
    },

    reincarnate() {
        this.data.reincarnationCount++;
        this.data.spirit = 0;
        this.data.realmIdx = 0;
        this.data.layer = 1;
        this.data.rootIdx = 0; this.data.rootFails = 0;
        this.data.weaponIdx = 0; this.data.weaponFails = 0;
        this.data.realmFails = 0;
        this.data.skills.forEach(s => s.level = Math.floor(s.level * 0.5)); 
        
        document.getElementById('modal-end').classList.add('hidden');
        ui.log(`轮回第 ${this.data.reincarnationCount} 世，重新踏上征程。`, 'rare-purple');
        ui.render();
    },

    sleep(ms) { return new Promise(r=>setTimeout(r,ms)); },
    loop() { requestAnimationFrame(()=>this.loop()); }
};

const ui = {
    skillHoldTimer: null,

    init() {
        const area = document.getElementById('click-area');
        const start = (e) => {
            if(e.cancelable) e.preventDefault();
            if(game.hold.active) return;
            game.hold.active = true;
            game.hold.startTime = Date.now();
            game.hold.lastCritTime = 0; 
            game.hold.critMult = 1; // 重置暴击倍率

            document.getElementById('avatar').classList.add('channeling');
            document.getElementById('channel-container').classList.add('active');
            document.getElementById('channel-text').classList.add('active');
            game.hold.timer = setInterval(() => { this.updateHoldStatus(); game.processClick(null); }, 100);
        };
        const end = () => {
            if(!game.hold.active) return;
            game.hold.active = false;
            clearInterval(game.hold.timer);
            game.hold.currentMult = 1; 
            game.hold.critMult = 1;
            
            const avatar = document.getElementById('avatar');
            avatar.classList.remove('channeling');
            
            const core = avatar.querySelector('.energy-core');
            core.style.transform = 'scale(1)';
            core.style.boxShadow = '';

            document.getElementById('channel-container').classList.remove('active');
            document.getElementById('channel-text').classList.remove('active');
            document.getElementById('channel-text').innerHTML = '长按 <span style="color:var(--neon-blue)">汇聚灵气</span>';
            document.getElementById('channel-fill').style.width = '0%';
        };

        area.addEventListener('mousedown', start);
        area.addEventListener('touchstart', start, {passive:false});
        document.addEventListener('mouseup', end);
        document.addEventListener('touchend', end);
        
        // 拖拽逻辑同前
        const ball = document.getElementById('float-spirit');
        let isDragging = false;
        let startX, startY, initialLeft, initialTop;

        const onDragStart = (e) => { isDragging = true; ball.style.transition = 'none'; const touch = e.touches ? e.touches[0] : e; startX = touch.clientX; startY = touch.clientY; initialLeft = ball.getBoundingClientRect().left; initialTop = ball.getBoundingClientRect().top; e.preventDefault(); };
        const onDragMove = (e) => { if (!isDragging) return; const touch = e.touches ? e.touches[0] : e; ball.style.left = `${initialLeft + touch.clientX - startX}px`; ball.style.top = `${initialTop + touch.clientY - startY}px`; ball.style.right = 'auto'; };
        const onDragEnd = () => { if (!isDragging) return; isDragging = false; ball.style.transition = 'all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1)'; const rect = ball.getBoundingClientRect(); if (rect.left + rect.width / 2 < window.innerWidth / 2) { ball.style.left = '0px'; ball.classList.add('dock-left'); ball.style.borderRadius = "0 20px 20px 0"; ball.style.borderLeft = "none"; ball.style.borderRight = "1px solid var(--primary-green)"; ball.style.alignItems = "flex-start"; } else { ball.style.left = (window.innerWidth - rect.width) + 'px'; ball.classList.remove('dock-left'); ball.style.borderRadius = "20px 0 0 20px"; ball.style.borderRight = "none"; ball.style.borderLeft = "1px solid var(--primary-green)"; ball.style.alignItems = "flex-end"; } let newTop = parseInt(ball.style.top); if (newTop < 50) newTop = 50; if (newTop > window.innerHeight - 100) newTop = window.innerHeight - 100; ball.style.top = newTop + 'px'; };

        ball.addEventListener('mousedown', onDragStart); ball.addEventListener('touchstart', onDragStart, {passive:false});
        window.addEventListener('mousemove', onDragMove); window.addEventListener('touchmove', onDragMove, {passive:false});
        window.addEventListener('mouseup', onDragEnd); window.addEventListener('touchend', onDragEnd);

        this.render();
    },

    updateHoldStatus() {
        const now = Date.now();
        const diff = (now - game.hold.startTime) / 1000; 
        
        // --- 核心逻辑1：极致亮度 ---
        const core = document.querySelector('.energy-core');
        const maxScaleTime = 5.0; 
        const progress = Math.min(diff, maxScaleTime) / maxScaleTime;
        const currentScale = 1 + (progress * 1.5); 
        // 阴影范围扩大到 200px 模拟超级亮
        const currentGlow = 20 + (progress * 180); 
        
        if(core) {
            core.style.transform = `scale(${currentScale})`;
            // 多重阴影叠加：白核 -> 亮蓝 -> 深蓝
            core.style.boxShadow = `
                0 0 ${currentGlow * 0.5}px #fff,
                0 0 ${currentGlow}px var(--neon-blue),
                0 0 ${currentGlow * 2}px var(--neon-blue)
            `;
        }

        // --- 核心逻辑2：5秒判定暴击 ---
        // 检查是否跨过了 5s, 10s, 15s 的门槛
        const checkPoint = Math.floor(diff / 5);
        if (checkPoint > game.hold.lastCritTime && diff >= 5) {
            game.hold.lastCritTime = checkPoint;
            // 90% 概率触发 5倍暴击
            if (Math.random() < 0.9) {
                game.hold.critMult *= 5;
                this.showCritText();
            }
        }

        // --- 基础倍率逻辑 ---
        const index = Math.floor(diff / 5);
        game.hold.currentMult = (index + 1) * 10;
        
        // 总倍率
        const totalMult = game.hold.currentMult * game.hold.critMult;

        const percent = ((diff % 5) / 5) * 100;
        document.getElementById('channel-fill').style.width = percent + '%';
        
        const channelText = document.getElementById('channel-text');
        if(channelText) {
             channelText.innerHTML = `吟唱 ${diff.toFixed(1)}s <span style="color:#ffeb3b; margin-left:10px;">x${this.fmt(totalMult)}倍</span>`;
        }

        // --- 生成粒子 ---
        if(Math.random() > 0.4) this.spawnGatherParticle();
    },

    showCritText() {
        const avatar = document.getElementById('avatar');
        if(!avatar) return;
        const rect = avatar.getBoundingClientRect();
        const el = document.createElement('div');
        el.className = 'crit-text';
        el.innerText = "灵力暴走 x5 !!!";
        el.style.left = (rect.left + rect.width/2 - 80) + 'px';
        el.style.top = (rect.top - 50) + 'px';
        document.body.appendChild(el);
        setTimeout(()=>el.remove(), 1000);
    },

    spawnGatherParticle() {
        const avatar = document.getElementById('avatar');
        if(!avatar) return;
        const rect = avatar.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        const angle = Math.random() * Math.PI * 2;
        const radius = Math.max(window.innerWidth, window.innerHeight) * 0.6;
        const startX = window.innerWidth/2 + Math.cos(angle) * radius;
        const startY = window.innerHeight/2 + Math.sin(angle) * radius;

        const p = document.createElement('div');
        p.className = 'spirit-particle';
        p.style.setProperty('--sx', startX + 'px');
        p.style.setProperty('--sy', startY + 'px');
        p.style.setProperty('--ex', centerX + 'px');
        p.style.setProperty('--ey', centerY + 'px');
        document.body.appendChild(p);
        setTimeout(() => p.remove(), 1500); 
    },

    createVictoryParticles() {
        const container = document.getElementById('victory-particles');
        if(!container) return;
        container.innerHTML = ''; 
        for (let i = 0; i < 50; i++) { 
            const p = document.createElement('div');
            p.className = 'victory-particle';
            p.style.left = Math.random() * 100 + '%';
            const size = Math.random() * 6 + 2 + 'px';
            p.style.width = size; p.style.height = size;
            p.style.animationDelay = Math.random() * 2 + 's';
            p.style.animationDuration = Math.random() * 3 + 2 + 's';
            container.appendChild(p);
        }
    },

    startSkillHold(idx) {
        if(this.skillHoldTimer) clearInterval(this.skillHoldTimer);
        game.upgradeSkill(idx);
        this.renderSkills(); 
        this.renderCultivate(); 
        this.updateSpirit();
        this.skillHoldTimer = setInterval(() => {
            const success = game.upgradeSkill(idx);
            if(success) {
                this.renderSkills(); 
                this.updateSpirit();
            } else {
                clearInterval(this.skillHoldTimer);
            }
        }, 80);
    },
    endSkillHold() {
        if(this.skillHoldTimer) { clearInterval(this.skillHoldTimer); this.skillHoldTimer = null; }
    },

    fmt(num) {
        if(num < 10000) return Math.floor(num);
        if(num < 100000000) return (num/10000).toFixed(2) + '万';
        if(num < 1000000000000) return (num/100000000).toFixed(2) + '亿';
        if(num < 10000000000000000) return (num/1000000000000).toFixed(2) + '兆';
        if(num < 100000000000000000000) return (num/10000000000000000).toFixed(2) + '京';
        return "∞";
    },

    switchTab(t) {
        document.querySelectorAll('.tab-content').forEach(d=>d.classList.remove('show'));
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        document.getElementById('tab-'+t).classList.add('show');
        event.target.classList.add('active');
    },

    log(msg, c='#aaa') {
        const d = document.getElementById('gamelog');
        d.innerHTML = `<div style="color:${c}; margin-bottom:6px; border-bottom:1px solid rgba(255,255,255,0.05); padding-bottom:2px;">[${new Date().toLocaleTimeString().split(' ')[0]}] ${msg}</div>` + d.innerHTML;
    },

    showFloatText(x, y, num) {
        const el = document.createElement('div');
        el.className = 'float-text';
        el.style.left = (x - 20) + 'px';
        el.style.top = (y - 50) + 'px';
        el.innerText = '+' + this.fmt(num);
        document.body.appendChild(el);
        setTimeout(()=>el.remove(), 800);
    },
    
    bgParticle(x, y) {
        const canvas = document.getElementById('bgCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        ctx.fillStyle = 'rgba(0, 242, 255, 0.3)';
        ctx.beginPath();
        ctx.arc(x, y, 6, 0, Math.PI*2);
        ctx.fill();
        setTimeout(()=> ctx.clearRect(0,0,canvas.width,canvas.height), 150);
    },

    createExplosion(x, y, color) {
        const container = document.getElementById('vfx-layer');
        for (let i = 0; i < 20; i++) {
            const p = document.createElement('div');
            p.className = 'particle';
            p.style.backgroundColor = color;
            p.style.left = x + 'px';
            p.style.top = y + 'px';
            const angle = Math.random() * Math.PI * 2;
            const velocity = Math.random() * 80 + 20;
            const tx = Math.cos(angle) * velocity + 'px';
            const ty = Math.sin(angle) * velocity + 'px';
            p.style.setProperty('--tx', tx);
            p.style.setProperty('--ty', ty);
            p.style.animation = 'particleFly 0.6s ease-out forwards';
            container.appendChild(p);
            setTimeout(() => p.remove(), 600);
        }
    },

    render() {
        document.getElementById('player-name').innerText = game.data.name;
        document.getElementById('reincarnate-count').innerText = game.data.reincarnationCount;
        
        const root = CONFIG.ROOTS[game.data.rootIdx];
        const weapon = CONFIG.WEAPONS[game.data.weaponIdx];
        
        const tDisp = document.getElementById('talent-disp');
        tDisp.innerText = root.tag; 
        tDisp.className = 'tag-badge ' + (game.data.rootIdx >= 9 ? 'god' : (game.data.rootIdx >= 6 ? 'rare' : ''));
        
        const wDisp = document.getElementById('weapon-disp');
        wDisp.innerText = weapon.tag;
        wDisp.className = 'tag-badge ' + (game.data.weaponIdx >= 9 ? 'god' : (game.data.weaponIdx >= 6 ? 'rare' : ''));

        const rName = CONFIG.MAJOR_REALMS[game.data.realmIdx].name;
        const lName = game.data.realmIdx < 9 ? ` ${game.data.layer}层` : "";
        document.getElementById('realm-disp').innerText = rName + lName;
        
        this.updateSpirit();
        this.renderSkills();
        this.renderCultivate();
    },

    updateSpirit() {
        document.getElementById('spirit-disp').innerText = this.fmt(game.data.spirit);
    },

    renderSkills() {
        const div = document.getElementById('skills-list');
        div.innerHTML = '';
        game.data.skills.forEach((s,i) => {
            const cost = s.cost * Math.pow(1.6, s.level);
            const canBuy = game.data.spirit >= cost;
            const isMax = s.level >= 100;
            
            let displayName = s.name;
            if(isMax) displayName = `<span style="color:var(--rare-purple);font-weight:bold;text-shadow:0 0 5px var(--rare-purple)">至臻·${s.name}</span>`;

            // 显示数值时也保留小数位
            const powerDisp = s.power;

            div.innerHTML += `
                <div class="list-item">
                    <div style="flex:1; padding-right:10px;">
                        <div style="font-weight:bold; color:${isMax?'var(--primary-gold)':'#eee'}; font-size:0.9rem;">
                            ${displayName} <span style="font-size:0.75rem; color:#666; margin-left:5px;">Lv.${s.level}</span>
                        </div>
                        <div style="font-size:0.7rem; color:#555; margin-top:2px;">
                            效能: <span style="color:${isMax?'var(--primary-gold)':'var(--neon-blue)'}">基础+${powerDisp.toFixed(1)}</span> / 级
                        </div>
                    </div>
                    <button class="btn-upgrade ${isMax?'maxed':''}" ${canBuy?'':'disabled'} 
                        onmousedown="ui.startSkillHold(${i})" onmouseup="ui.endSkillHold()" onmouseleave="ui.endSkillHold()"
                        ontouchstart="ui.startSkillHold(${i})" ontouchend="ui.endSkillHold()">
                        ${isMax ? '突破' : '升级'} <br><span style="font-size:0.6rem">${this.fmt(cost)}</span>
                    </button>
                </div>
            `;
        });
    },

    renderCultivate() {
        const idx = game.data.realmIdx;
        const layer = game.data.layer;
        const nextReq = game.getNextRealmReq();
        const btnU = document.getElementById('btn-realm');
        const btnT = document.getElementById('btn-trib');
        const tribWarn = document.getElementById('trib-warn');
        
        if(idx >= 9) {
            document.getElementById('next-realm-name').innerText = "已臻化境";
            document.getElementById('req-realm').innerText = "-";
            btnU.classList.add('hidden');
            btnT.classList.add('hidden');
            tribWarn.classList.add('hidden');
        } else {
            let nextNameStr = layer < 9 ? `${CONFIG.MAJOR_REALMS[idx].name} ${layer+1}层` : `${CONFIG.MAJOR_REALMS[idx+1].name} 一层`;
            document.getElementById('next-realm-name').innerText = nextNameStr;
            document.getElementById('req-realm').innerText = this.fmt(nextReq);

            if(idx === 8 && layer === 9) {
                btnU.classList.add('hidden');
                btnT.classList.remove('hidden');
                tribWarn.classList.remove('hidden');
                document.getElementById('protect-val-preview').innerText = game.getProtectionScore().toFixed(1) + "%";

                btnT.disabled = game.data.spirit < nextReq;
                if(game.data.spirit < nextReq) { btnT.style.opacity = 0.5; btnT.innerText = "灵力不足"; }
                else { btnT.style.opacity = 1; btnT.innerText = "逆天改命 (百雷天劫)"; }
            } else {
                btnU.classList.remove('hidden');
                btnT.classList.add('hidden');
                tribWarn.classList.add('hidden');
                if(game.data.spirit >= nextReq) {
                    btnU.className = "cultivate-btn-lg active risk"; 
                    btnU.innerText = "突破瓶颈"; 
                } else {
                    btnU.className = "cultivate-btn-lg";
                    btnU.innerText = "积攒灵力中...";
                }
            }
        }

        const rIdx = game.data.rootIdx;
        const btnRoot = document.getElementById('btn-root');
        
        if(rIdx >= CONFIG.ROOTS.length - 1) {
            document.getElementById('next-root-name').innerText = "已达极限";
            document.getElementById('root-bonus').innerText = "MAX";
            document.getElementById('req-root').innerText = "-";
            btnRoot.disabled = true;
            btnRoot.innerText = "圆满";
            btnRoot.className = "cultivate-btn-lg";
        } else {
            const nextR = CONFIG.ROOTS[rIdx + 1];
            document.getElementById('next-root-name').innerText = nextR.name;
            document.getElementById('root-bonus').innerText = `x${nextR.mult}`;
            document.getElementById('req-root').innerText = this.fmt(nextR.cost);
            if(game.data.spirit >= nextR.cost) {
                btnRoot.className = "cultivate-btn-lg active risk"; 
                btnRoot.innerText = "洗髓伐骨"; 
            } else {
                btnRoot.className = "cultivate-btn-lg";
                btnRoot.innerText = "灵力不足";
            }
        }

        const wIdx = game.data.weaponIdx;
        const btnW = document.getElementById('btn-weapon');

        if(wIdx >= CONFIG.WEAPONS.length - 1) {
            document.getElementById('next-weapon-name').innerText = "神器已成";
            document.getElementById('weapon-bonus').innerText = "MAX";
            document.getElementById('req-weapon').innerText = "-";
            btnW.disabled = true;
            btnW.innerText = "圆满";
            btnW.className = "cultivate-btn-lg";
        } else {
            const nextW = CONFIG.WEAPONS[wIdx + 1];
            document.getElementById('next-weapon-name').innerText = nextW.name;
            document.getElementById('weapon-bonus').innerText = `x${nextW.mult}`;
            document.getElementById('req-weapon').innerText = this.fmt(nextW.cost);
            if(game.data.spirit >= nextW.cost) {
                btnW.className = "cultivate-btn-lg active risk";
                btnW.innerText = "祭炼法宝"; 
            } else {
                btnW.className = "cultivate-btn-lg";
                btnW.innerText = "灵力不足";
            }
        }
    }
};

window.onload = game.init.bind(game);
</script>
</body>
</html>
