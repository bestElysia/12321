<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ— å°½ä¿®ä»™ï¼šè‡³è‡»å¢ƒ</title>
    <style>
        /* =========================================
           CSS æ ·å¼è¡¨
           ========================================= */
        :root {
            --bg-color: #050505;
            --panel-bg: rgba(20, 20, 30, 0.98);
            --primary-gold: #ffc107;
            --primary-green: #4caf50;
            --danger-red: #ff3b30;
            --neon-blue: #00f2ff;
            --rare-purple: #e040fb;
            --text-main: #e0e0e0;
            --text-dim: #757575;
            --border-color: #333;
        }

        /* ç¦æ­¢ iOS é•¿æŒ‰é€‰ä¸­ã€ç¦æ­¢ç³»ç»Ÿé»˜è®¤è§¦æ‘¸è¡Œä¸º */
        * { 
            box-sizing: border-box; 
            user-select: none; 
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent; 
        }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            display: flex;
            justify-content: center;
            background: #000;
            /* ç¦æ­¢æ‰‹åŠ¿ç¼©æ”¾ */
            touch-action: none;
        }

        .bg-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }

        #app {
            position: relative; z-index: 10; width: 100%; max-width: 600px; height: 100%;
            display: flex; flex-direction: column;
            background: radial-gradient(circle at center, rgba(30,30,40,0.3) 0%, rgba(0,0,0,1) 100%);
        }

        /* --- é¡¶éƒ¨ä¿¡æ¯ --- */
        header {
            padding-top: max(15px, env(safe-area-inset-top));
            padding-bottom: 10px; padding-left: 20px; padding-right: 20px;
            border-bottom: 1px solid var(--border-color);
            background: rgba(10, 10, 15, 0.95);
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            min-height: 80px;
        }
        .spirit-box { text-align: right; }
        .spirit-val { font-family: 'Courier New', monospace; font-size: 1.5rem; color: var(--primary-green); font-weight: bold; }
        
        /* --- æ ¸å¿ƒç‚¹å‡»åŒº --- */
        #click-area {
            flex: 1; position: relative; display: flex; flex-direction: column;
            justify-content: center; align-items: center; cursor: pointer;
            transition: background 0.2s;
            touch-action: manipulation;
        }
        #click-area:active { background: rgba(255, 255, 255, 0.02); }

        .avatar-container {
            width: 200px; height: 200px; border-radius: 50%;
            border: 3px solid #333;
            display: flex; justify-content: center; align-items: center;
            position: relative; transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            background: radial-gradient(circle, #2a2a2a, #000);
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            z-index: 20;
        }
        .avatar-container.channeling {
            border-color: var(--neon-blue);
            box-shadow: 0 0 50px var(--neon-blue);
            transform: scale(1.05);
        }
        .meditate-icon { font-size: 5rem; transition: transform 0.1s; }

        .realm-tag {
            position: absolute; bottom: -15px;
            background: #000; border: 1px solid var(--primary-gold); color: var(--primary-gold);
            padding: 4px 15px; border-radius: 15px; font-size: 0.9rem; font-weight: bold;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3); white-space: nowrap;
        }

        /* é•¿æŒ‰æç¤ºæ¡ */
        .channel-bar {
            margin-top: 40px; width: 80%; height: 8px; background: #222; border-radius: 4px; position: relative; opacity: 0; transition: opacity 0.3s;
        }
        .channel-bar.active { opacity: 1; }
        .channel-fill {
            height: 100%; background: var(--neon-blue); width: 0%; border-radius: 4px;
            box-shadow: 0 0 10px var(--neon-blue); transition: width 0.1s linear;
        }
        .channel-text {
            text-align: center; margin-top: 10px; font-size: 1rem; color: var(--neon-blue); height: 24px; text-shadow: 0 0 5px var(--neon-blue);
        }

        /* --- åº•éƒ¨é¢æ¿ --- */
        #panel-container { 
            height: 50%; background: var(--panel-bg); border-top: 1px solid var(--border-color); display: flex; flex-direction: column;
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .tabs { display: flex; background: rgba(0,0,0,0.5); }
        .tab-btn {
            flex: 1; padding: 15px; background: transparent; border: none; color: var(--text-dim);
            border-bottom: 2px solid transparent; font-size: 1rem; cursor: pointer;
            touch-action: manipulation;
        }
        .tab-btn.active { color: var(--primary-gold); border-bottom-color: var(--primary-gold); background: rgba(255, 215, 0, 0.05); }

        .tab-content { flex: 1; overflow-y: auto; padding: 15px; display: none; -webkit-overflow-scrolling: touch; }
        .tab-content.show { display: block; }

        .list-item {
            background: rgba(255,255,255,0.03); border: 1px solid var(--border-color);
            padding: 12px; margin-bottom: 8px; border-radius: 6px;
            display: flex; justify-content: space-between; align-items: center;
        }
        
        /* åŠŸæ³•æŒ‰é’®æ ·å¼ */
        .upgrade-btn {
            background: transparent; color: var(--primary-green); border: 1px solid var(--primary-green);
            padding: 8px 16px; border-radius: 4px; font-size: 0.85rem;
            /* å…³é”®ï¼šå…è®¸æ“ä½œä½†ç¦æ­¢æµè§ˆå™¨ç¼©æ”¾ */
            touch-action: manipulation; 
            cursor: pointer;
            user-select: none;
        }
        .upgrade-btn:active { background: rgba(76, 175, 80, 0.2); transform: scale(0.95); }
        .upgrade-btn:disabled { border-color: #444; color: #444; transform: none; }
        .upgrade-btn.maxed { border-color: var(--primary-gold); color: var(--primary-gold); background: rgba(255,215,0,0.1); }

        #breakthrough-area { text-align: center; margin-top: 20px; }
        .btn-main {
            width: 100%; padding: 15px; border: none; font-size: 1.1rem; font-weight: bold; border-radius: 8px; margin-top: 15px; cursor: pointer;
            touch-action: manipulation;
        }
        .btn-upgrade { background: var(--primary-green); color: #000; }
        .btn-tribulation { 
            background: linear-gradient(45deg, #d32f2f, #b71c1c); color: #fff; 
            box-shadow: 0 0 20px rgba(211, 47, 47, 0.6); animation: pulse 1.5s infinite;
        }

        .float-text {
            position: absolute; color: #fff; font-weight: bold; pointer-events: none;
            animation: floatUp 0.8s forwards; font-size: 1.2rem; text-shadow: 1px 1px 2px black; z-index: 100;
        }

        /* --- æ¸¡åŠ«ç‰¹æ•ˆ --- */
        #tribulation-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 2000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .xinmo-mode { background: radial-gradient(circle, #300000, #000); }
        .thunder-bolt {
            position: absolute; top: 0; left: 50%; width: 10px; height: 100%;
            background: #fff; box-shadow: 0 0 30px #fff, 0 0 80px #9c27b0;
            transform: translateX(-50%) scaleY(0); transform-origin: top; opacity: 0;
        }
        .thunder-strike { animation: strike 0.08s; } /* æé€Ÿé›·åŠˆ */

        @keyframes floatUp { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-60px); opacity: 0; } }
        @keyframes strike { 0% { transform: translateX(-50%) scaleY(0); opacity: 1; } 50% { transform: translateX(-50%) scaleY(1); opacity: 1; } 100% { transform: translateX(-50%) scaleY(1); opacity: 0; } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        .hidden { display: none !important; }
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85);
            display: flex; justify-content: center; align-items: center; z-index: 3000; backdrop-filter: blur(5px);
        }
        .modal-box {
            background: #1a1a1a; padding: 30px; border-radius: 10px; border: 1px solid var(--primary-gold);
            text-align: center; width: 80%; max-width: 400px;
        }
        input { background: #333; border: 1px solid #555; color: white; padding: 10px; margin: 15px 0; width: 80%; text-align: center; }
    </style>
</head>
<body>

    <canvas id="bgCanvas" class="bg-canvas"></canvas>

    <div id="app">
        <header>
            <div>
                <div style="font-size: 1.1rem; color: var(--primary-gold);" id="player-name">é“å‹</div>
                <div style="font-size: 0.7rem; color: #888;">å·²è½®å› <span id="reincarnate-count">0</span> ä¸–</div>
            </div>
            <div class="spirit-box">
                <div class="spirit-val" id="spirit-disp">0</div>
                <div style="font-size: 0.7rem; color: #666;">å¤©åœ°çµåŠ›</div>
            </div>
        </header>

        <div id="click-area">
            <div class="avatar-container" id="avatar">
                <div class="meditate-icon">ğŸ§˜â€â™‚ï¸</div>
                <div class="realm-tag" id="realm-disp">ç‚¼æ°”æœŸ ä¸€å±‚</div>
            </div>
            
            <div id="channel-container" class="channel-bar">
                <div class="channel-fill" id="channel-fill"></div>
            </div>
            <div class="channel-text" id="channel-text"></div>
            
            <p style="margin-top: 15px; color: #555; font-size: 0.8rem;">
                æŒ‰ä½å±å¹• <span style="color:var(--neon-blue)">æ±‡èšçµæ°”</span> (æ¯5ç§’å€ç‡+10)
            </p>
        </div>

        <div id="panel-container">
            <div class="tabs">
                <button class="tab-btn active" onclick="ui.switchTab('skills')">åŠŸæ³•é˜</button>
                <button class="tab-btn" onclick="ui.switchTab('realm')">å¢ƒç•Œçªç ´</button>
                <button class="tab-btn" onclick="ui.switchTab('log')">æ—¥å¿—</button>
            </div>

            <div id="tab-skills" class="tab-content show">
                <div style="font-size:0.75rem;color:#666;text-align:center;margin-bottom:10px;">é•¿æŒ‰æŒ‰é’®å¯å¿«é€Ÿå‡çº§ Â· <span style="color:#e91e63">è‡³è‡»</span>éœ€Lv.100</div>
                <div id="skills-list"></div>
            </div>

            <div id="tab-realm" class="tab-content">
                <div id="breakthrough-area">
                    <h2 style="color: var(--primary-gold); margin: 0 0 5px 0;" id="next-realm-name">ä¸‹ä¸€é‡ï¼šç‚¼æ°”æœŸ äºŒå±‚</h2>
                    <p style="color: #888; font-size: 0.9rem;" id="req-text">æ‰€éœ€çµåŠ›: 100</p>
                    
                    <button id="btn-upgrade" class="btn-main btn-upgrade" onclick="game.upgradeRealm()">
                        çªç ´ç“¶é¢ˆ
                    </button>
                    <button id="btn-tribulation" class="btn-main btn-tribulation hidden" onclick="game.startTribulation()">
                        é€†å¤©æ”¹å‘½ (å¼€å§‹æ¸¡åŠ«)
                    </button>
                    
                    <p id="tribulation-hint" class="hidden" style="margin-top: 15px; font-size: 0.8rem; color: #ff5252;">
                        è­¦å‘Šï¼šç™¾é›·å¤©åŠ«ï¼Œä¹æ­»ä¸€ç”Ÿã€‚<br>
                        åŸºç¡€æˆåŠŸç‡ 50%ã€‚<br>
                        <span style="color:var(--primary-gold)">å”¯æœ‰å…¨åŠŸæ³•è‡³è‡»åœ†æ»¡(Lv.100)ï¼Œæ–¹å¯ç™¾åˆ†ç™¾æ¸¡åŠ«ã€‚</span>
                    </p>
                </div>
            </div>

            <div id="tab-log" class="tab-content">
                <div id="gamelog" style="font-size: 0.8rem; line-height: 1.6; color: #aaa;"></div>
            </div>
        </div>
    </div>

    <div id="modal-start" class="modal">
        <div class="modal-box">
            <h2 style="color: var(--primary-gold)">è¸å…¥ä»™é€”</h2>
            <input type="text" id="inp-name" placeholder="è¯·è¾“å…¥é“å·" maxlength="6">
            <button class="btn-main btn-upgrade" onclick="game.startGame()">å¼€å§‹ä¿®ä»™</button>
        </div>
    </div>

    <div id="tribulation-overlay" class="hidden">
        <div class="thunder-bolt" id="thunder-vfx"></div>
        <div style="z-index: 2002; text-align: center; width: 85%;">
            <h1 id="trib-title" style="color: #ffeb3b; text-shadow: 0 0 20px red;">å¤©åŠ«é™ä¸´</h1>
            <h2 id="trib-step" style="color: white; font-family: monospace;">0 / 100</h2>
            <div id="trib-console" style="height: 120px; overflow-y: scroll; background: rgba(0,0,0,0.6); border: 1px solid #444; padding: 10px; font-size: 0.8rem; text-align: left; margin-top: 20px;"></div>
        </div>
    </div>

    <div id="modal-end" class="modal hidden">
        <div class="modal-box">
            <h1 id="end-title" style="color: #ff3b30">é™¨è½</h1>
            <p id="end-desc">ä½ åœ¨å¤©åŠ«ä¸‹ç°é£çƒŸç­...</p>
            <button class="btn-main btn-upgrade" onclick="game.reincarnate()">è½¬ä¸–é‡ä¿®</button>
        </div>
    </div>

<script>
const CONFIG = {
    MAJOR_REALMS: [
        { name: "ç‚¼æ°”æœŸ", baseReq: 100, exp: 1.5 },     
        { name: "ç­‘åŸºæœŸ", baseReq: 5000, exp: 1.6 },    
        { name: "é‡‘ä¸¹æœŸ", baseReq: 50000, exp: 1.7 },   
        { name: "å…ƒå©´æœŸ", baseReq: 500000, exp: 1.8 },  
        { name: "åŒ–ç¥æœŸ", baseReq: 10000000, exp: 1.9 },
        { name: "ç‚¼è™šæœŸ", baseReq: 500000000, exp: 2.0 }, 
        { name: "åˆä½“æœŸ", baseReq: 20000000000, exp: 2.1 }, 
        { name: "å¤§ä¹˜æœŸ", baseReq: 100000000000, exp: 2.2 }, 
        { name: "æ¸¡åŠ«æœŸ", baseReq: 1000000000000, exp: 2.3 }, 
        { name: "é™†åœ°çœŸä»™", baseReq: 0, exp: 1 }
    ],
    SKILLS: [
        { id: 0, name: "åŸºç¡€åçº³", cost: 50, costMult: 1.5, power: 1.1, desc: "å…¥é—¨å¿ƒæ³•" },
        { id: 1, name: "äº”è¡Œçµè¯€", cost: 1000, costMult: 1.6, power: 1.15, desc: "äº”è¡Œè½®è½¬" },
        { id: 2, name: "ç´«æ°”ä¸œæ¥", cost: 20000, costMult: 1.7, power: 1.2, desc: "å¸å–æœé˜³ç´«æ°”" },
        { id: 3, name: "å¤ªä¸Šå¿˜æƒ…", cost: 500000, costMult: 1.8, power: 1.25, desc: "å¤©é“æ— äº²" },
        { id: 4, name: "å…«ä¹ç„åŠŸ", cost: 10000000, costMult: 1.9, power: 1.3, desc: "è‚‰èº«æˆåœ£" },
        { id: 5, name: "ä¸€å¿µèŠ±å¼€", cost: 500000000, costMult: 2.0, power: 1.4, desc: "å›ä¸´å¤©ä¸‹" }
    ]
};

const game = {
    data: {
        name: "æ— å",
        spirit: 0,
        realmIdx: 0,   
        layer: 1,      
        skills: CONFIG.SKILLS.map(s => ({...s, level: 0})),
        reincarnationCount: 0,
        isTribulating: false
    },
    
    // çµåŠ›é•¿æŒ‰
    hold: {
        active: false,
        startTime: 0,
        timer: null,
        currentMult: 1
    },

    init() {
        ui.init();
        this.loop();
    },

    startGame() {
        const n = document.getElementById('inp-name').value.trim();
        if(n) this.data.name = n;
        document.getElementById('modal-start').classList.add('hidden');
        ui.log(`é“å‹ <b>${this.data.name}</b> å¼€å§‹äº†ä¿®ä»™ä¹‹æ—…ã€‚`);
        ui.render();
    },

    getClickPower() {
        const realmPower = Math.pow(this.data.realmIdx + 1, 3) * this.data.layer;
        let skillMult = 1;
        this.data.skills.forEach(s => {
            if(s.level > 0) skillMult *= Math.pow(s.power, s.level);
        });
        return 1 * realmPower * skillMult * this.hold.currentMult;
    },

    processClick(e) {
        if(this.data.isTribulating) return;

        const gain = this.getClickPower();
        this.data.spirit += gain;
        
        // è§†è§‰æ•ˆæœ
        const isAuto = !e; 
        if(!isAuto && e.isTrusted) {
            ui.showFloatText(e.clientX, e.clientY, gain);
            ui.bgParticle(e.clientX, e.clientY);
        } else if (isAuto) {
            const x = window.innerWidth / 2 + (Math.random()*60 - 30);
            const y = window.innerHeight / 2 - 50 + (Math.random()*40 - 20);
            ui.showFloatText(x, y, gain);
        }

        ui.updateSpirit();
        ui.checkRedDots();
    },

    upgradeSkill(idx) {
        const s = this.data.skills[idx];
        const cost = s.cost * Math.pow(s.costMult, s.level);
        // ä¸è®¾ä¸Šé™ï¼Œæˆ–è€…ä¸Šé™å¾ˆé«˜ï¼Œä½†è‡³è‡»åˆ¤å®šæ˜¯100
        if(this.data.spirit >= cost) {
            this.data.spirit -= cost;
            s.level++;
            // ä¸éœ€è¦é‡æ–°æ¸²æŸ“æ•´ä¸ªåˆ—è¡¨ï¼Œåªåœ¨å¾ªç¯æˆ–å›è°ƒé‡Œåˆ·æ–°
            return true; // è¿”å›æˆåŠŸ
        }
        return false;
    },

    upgradeRealm() {
        const nextReq = this.getNextRealmReq();
        if(this.data.spirit >= nextReq) {
            this.data.spirit -= nextReq;
            if(this.data.layer < 9) {
                this.data.layer++;
                ui.log(`çªç ´è‡³ [${CONFIG.MAJOR_REALMS[this.data.realmIdx].name} ${this.data.layer}å±‚]`, 'green');
            } else {
                if(this.data.realmIdx === 8 && this.data.layer === 9) return; 
                this.data.realmIdx++;
                this.data.layer = 1;
                ui.log(`=== æ™‹å‡ [${CONFIG.MAJOR_REALMS[this.data.realmIdx].name}] ===`, 'gold');
            }
            ui.render();
        }
    },

    getNextRealmReq() {
        const major = CONFIG.MAJOR_REALMS[this.data.realmIdx];
        if(!major) return 0;
        return major.baseReq * Math.pow(this.data.layer, major.exp);
    },

    startTribulation() {
        this.data.isTribulating = true;
        document.getElementById('tribulation-overlay').classList.remove('hidden');
        document.getElementById('tribulation-overlay').classList.remove('xinmo-mode');
        document.getElementById('trib-console').innerHTML = '';
        this.runTribulation();
    },

    async runTribulation() {
        const log = (m, c='#fff') => {
            const d = document.getElementById('trib-console');
            d.innerHTML += `<div style="color:${c}">${m}</div>`;
            d.scrollTop = d.scrollHeight;
        };

        const thunder = document.getElementById('thunder-vfx');
        const countDisp = document.getElementById('trib-step');
        
        // æ ¸å¿ƒæ”¹åŠ¨ï¼šåˆ¤å®šé€»è¾‘
        // åªæœ‰æ‰€æœ‰åŠŸæ³•éƒ½ >= 100ï¼Œæ¦‚ç‡æ‰ä¸º1ï¼Œå¦åˆ™ 0.5
        const totalSkills = this.data.skills.length;
        const maxedSkills = this.data.skills.filter(s => s.level >= 100).length;
        let rate = 0.5;
        
        if (maxedSkills === totalSkills) {
            rate = 1.1; // å¿…è¿‡
            log("æ£€æµ‹åˆ°é“å‹åŠŸå¾·åœ†æ»¡(å…¨è‡³è‡»)ï¼Œå¤©é“æŠ¤ä½‘ï¼", "#ffd700");
        } else {
            log(`åŠŸæ³•æœªè‡»åœ†æ»¡ (${maxedSkills}/${totalSkills})ï¼Œç”Ÿæ­»å¤©å®š(50%)...`, "#ff9800");
        }

        // æ ¸å¿ƒæ”¹åŠ¨ï¼š100é“å¤©é›·
        for(let i=1; i<=100; i++) {
            countDisp.innerText = `${i} / 100 é“`;
            
            // æé€Ÿé›·åŠˆï¼šæ¯30msä¸€é“
            await this.sleep(40);
            
            thunder.classList.add('thunder-strike');
            // è¿™é‡Œä¸ç§»é™¤classäº†ï¼Œå› ä¸ºå¤ªå¿«äº†ï¼Œç›´æ¥è®©å®ƒé—ª
            setTimeout(()=>thunder.classList.remove('thunder-strike'), 20);

            if(i % 10 === 0) {
                log(`å·²æŠ—ä¸‹ç¬¬ ${i} é“ç´«éœ„ç¥é›·ï¼`, '#00bcd4');
            }
        }

        await this.sleep(500);
        document.getElementById('tribulation-overlay').classList.add('xinmo-mode');
        document.getElementById('trib-title').innerText = "ç™¾ç‚¼å¿ƒé­”";
        log("æœ€åçš„å¿ƒé­”åŠ«é™ä¸´...", "#ff3b30");
        await this.sleep(1500);

        if(Math.random() < rate) {
            log("é“å¿ƒé€šæ˜ï¼Œå¿ƒé­”æ¶ˆæ•£ï¼", "#4caf50");
            await this.sleep(1000);
            this.handleWin();
        } else {
            log("é“å¿ƒå¤±å®ˆï¼Œä¸‡åŠ«ä¸å¤ï¼", "#ff0000");
            await this.sleep(1000);
            this.handleDeath();
        }
    },

    handleWin() {
        this.data.isTribulating = false;
        document.getElementById('tribulation-overlay').classList.add('hidden');
        this.data.realmIdx++; 
        this.data.layer = 1;
        
        const m = document.getElementById('modal-end');
        m.classList.remove('hidden');
        document.getElementById('end-title').innerText = "é£å‡è¯é“";
        document.getElementById('end-title').style.color = "#ffd700";
        document.getElementById('end-desc').innerText = `æ­å–œé“å‹ ${this.data.name} æˆå°±é™†åœ°çœŸä»™ï¼`;
    },

    handleDeath() {
        this.data.isTribulating = false;
        document.getElementById('tribulation-overlay').classList.add('hidden');
        document.getElementById('modal-end').classList.remove('hidden');
        document.getElementById('end-title').innerText = "é“æ¶ˆèº«æ­»";
        document.getElementById('end-title').style.color = "#ff3b30";
        document.getElementById('end-desc').innerText = "ä¿®ä»™è·¯æ¼«æ¼«ï¼Œå¤§ä¾ è¯·é‡æ–°æ¥è¿‡ã€‚";
    },

    reincarnate() {
        this.data.reincarnationCount++;
        this.data.spirit = 0;
        this.data.realmIdx = 0;
        this.data.layer = 1;
        // è½®å›ä¿ç•™éƒ¨åˆ†ç­‰çº§ï¼Œé¼“åŠ±ç»§ç»­è‚
        this.data.skills.forEach(s => s.level = Math.floor(s.level * 0.5)); 
        
        document.getElementById('modal-end').classList.add('hidden');
        ui.log(`è½®å›ç¬¬ ${this.data.reincarnationCount} ä¸–ï¼Œé‡æ–°è¸ä¸Šå¾ç¨‹ã€‚`, 'rare-purple');
        ui.render();
    },

    sleep(ms) { return new Promise(r=>setTimeout(r,ms)); },
    loop() { requestAnimationFrame(()=>this.loop()); }
};

const ui = {
    skillHoldTimer: null,

    init() {
        const area = document.getElementById('click-area');
        
        const start = (e) => {
            if(e.cancelable) e.preventDefault();
            if(game.hold.active) return;
            
            game.hold.active = true;
            game.hold.startTime = Date.now();
            document.getElementById('avatar').classList.add('channeling');
            document.getElementById('channel-container').classList.add('active');

            game.hold.timer = setInterval(() => {
                this.updateHoldStatus(); 
                game.processClick(null); 
            }, 100);
        };

        const end = () => {
            if(!game.hold.active) return;
            game.hold.active = false;
            clearInterval(game.hold.timer);
            game.hold.currentMult = 1; 
            
            document.getElementById('avatar').classList.remove('channeling');
            document.getElementById('channel-container').classList.remove('active');
            document.getElementById('channel-text').innerText = '';
        };

        area.addEventListener('mousedown', start);
        area.addEventListener('touchstart', start, {passive:false});
        
        document.addEventListener('mouseup', end);
        document.addEventListener('touchend', end);
        
        this.render();
    },

    // æ ¸å¿ƒä¿®æ”¹ï¼š5ç§’ä¸€æ¡£ï¼Œæ¯æ¡£10å€
    updateHoldStatus() {
        const now = Date.now();
        const diff = (now - game.hold.startTime) / 1000; 
        
        // 0-5s  -> idx 0 -> (0+1)*10 = x10
        // 5-10s -> idx 1 -> (1+1)*10 = x20
        const index = Math.floor(diff / 5);
        game.hold.currentMult = (index + 1) * 10;
        
        // è¿›åº¦æ¡æ˜¾ç¤º (æ¯5ç§’å¾ªç¯ä¸€æ¬¡)
        const percent = ((diff % 5) / 5) * 100;
        document.getElementById('channel-fill').style.width = percent + '%';
        
        let text = `åŸå”± ${diff.toFixed(1)}ç§’`;
        text += ` | <span style="color:#ffeb3b; font-weight:bold; font-size:1.2rem">x${game.hold.currentMult} å€é€Ÿ</span>`;
        
        document.getElementById('channel-text').innerHTML = text;
        
        if(index >= 1) {
            const shake = Math.random() * (index * 1.5);
            document.getElementById('avatar').style.transform = `scale(1.05) translate(${shake}px, ${shake}px)`;
        } else {
             document.getElementById('avatar').style.transform = `scale(1.05)`;
        }
    },

    // --- åŠŸæ³•é•¿æŒ‰é€»è¾‘ ---
    startSkillHold(idx) {
        if(this.skillHoldTimer) clearInterval(this.skillHoldTimer);
        // ç«‹å³è§¦å‘ä¸€æ¬¡
        game.upgradeSkill(idx);
        this.renderSkills(); // éœ€è¦åˆ·æ–°UIæ˜¾ç¤º
        this.renderRealm();

        // å¼€å¯è¿ç‚¹å®šæ—¶å™¨ (80msä¸€æ¬¡ï¼Œé£å¿«)
        this.skillHoldTimer = setInterval(() => {
            const success = game.upgradeSkill(idx);
            if(success) {
                // å±€éƒ¨ä¼˜åŒ–ï¼šå¦‚æœåªæ˜¯ä¸ºäº†æ›´æ–°é’±ï¼Œä¸éœ€è¦å…¨é‡åˆ·æ–°DOMï¼Œä½†è¿™é‡Œä¸ºäº†â€œè‡³è‡»â€å˜è‰²ç®€å•èµ·è§ï¼Œè¿˜æ˜¯åˆ·ä¸€ä¸‹
                // ä¸ºäº†æ€§èƒ½ï¼Œè¿™é‡Œå¯ä»¥ä¼˜åŒ–ï¼Œä½†ç°ä»£æ‰‹æœºè·‘è¿™ä¸ªæ²¡é—®é¢˜
                this.renderSkills(); 
                this.updateSpirit();
            } else {
                // é’±ä¸å¤Ÿäº†
                clearInterval(this.skillHoldTimer);
            }
        }, 80);
    },

    endSkillHold() {
        if(this.skillHoldTimer) {
            clearInterval(this.skillHoldTimer);
            this.skillHoldTimer = null;
        }
    },

    fmt(num) {
        if(num < 10000) return Math.floor(num);
        if(num < 100000000) return (num/10000).toFixed(2) + 'ä¸‡';
        if(num < 1000000000000) return (num/100000000).toFixed(2) + 'äº¿';
        if(num < 10000000000000000) return (num/1000000000000).toFixed(2) + 'å…†';
        return (num/10000000000000000).toFixed(2) + 'äº¬';
    },

    switchTab(t) {
        document.querySelectorAll('.tab-content').forEach(d=>d.classList.remove('show'));
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        document.getElementById('tab-'+t).classList.add('show');
        event.target.classList.add('active');
    },

    log(msg, c='#aaa') {
        const d = document.getElementById('gamelog');
        d.innerHTML = `<div style="color:${c}; margin-bottom:4px;">[${new Date().toLocaleTimeString()}] ${msg}</div>` + d.innerHTML;
    },

    showFloatText(x, y, num) {
        const el = document.createElement('div');
        el.className = 'float-text';
        el.style.left = (x - 20) + 'px';
        el.style.top = (y - 50) + 'px';
        el.innerText = '+' + this.fmt(num);
        document.body.appendChild(el);
        setTimeout(()=>el.remove(), 800);
    },
    
    bgParticle(x, y) {
        const canvas = document.getElementById('bgCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        ctx.fillStyle = 'rgba(0, 242, 255, 0.4)';
        ctx.beginPath();
        ctx.arc(x, y, 4, 0, Math.PI*2);
        ctx.fill();
        setTimeout(()=> ctx.clearRect(0,0,canvas.width,canvas.height), 150);
    },

    render() {
        document.getElementById('player-name').innerText = game.data.name;
        document.getElementById('reincarnate-count').innerText = game.data.reincarnationCount;
        
        const rName = CONFIG.MAJOR_REALMS[game.data.realmIdx].name;
        const lName = game.data.realmIdx < 9 ? ` ${game.data.layer}å±‚` : "";
        document.getElementById('realm-disp').innerText = rName + lName;

        this.updateSpirit();
        this.renderSkills();
        this.renderRealm();
    },

    updateSpirit() {
        document.getElementById('spirit-disp').innerText = this.fmt(game.data.spirit);
    },

    renderSkills() {
        const div = document.getElementById('skills-list');
        div.innerHTML = '';
        game.data.skills.forEach((s,i) => {
            const cost = s.cost * Math.pow(s.costMult, s.level);
            const canBuy = game.data.spirit >= cost;
            const isMax = s.level >= 100;
            
            // æ ¸å¿ƒä¿®æ”¹ï¼šè‡³è‡»å‰ç¼€
            let displayName = s.name;
            if(isMax) {
                displayName = `<span style="color:var(--rare-purple);font-weight:bold;text-shadow:0 0 5px var(--rare-purple)">è‡³è‡»Â·${s.name}</span>`;
            }

            // æ·»åŠ é•¿æŒ‰äº‹ä»¶ touchstart/mousedown
            div.innerHTML += `
                <div class="list-item">
                    <div>
                        <div style="font-weight:bold; color:${isMax?'var(--primary-gold)':'#eee'}">
                            ${displayName} <span style="font-size:0.8rem; color:#666">Lv.${s.level}</span>
                        </div>
                        <div style="font-size:0.75rem; color:#666">${s.desc}</div>
                    </div>
                    <button class="upgrade-btn ${isMax?'maxed':''}" 
                        ${canBuy?'':'disabled'} 
                        onmousedown="ui.startSkillHold(${i})" 
                        onmouseup="ui.endSkillHold()" 
                        onmouseleave="ui.endSkillHold()"
                        ontouchstart="ui.startSkillHold(${i})" 
                        ontouchend="ui.endSkillHold()"
                    >
                        ${isMax ? 'çªç ´' : 'å‡çº§'} <br><span style="font-size:0.7rem">${this.fmt(cost)}</span>
                    </button>
                </div>
            `;
        });
    },

    renderRealm() {
        const idx = game.data.realmIdx;
        const layer = game.data.layer;
        const major = CONFIG.MAJOR_REALMS[idx];
        const nextReq = game.getNextRealmReq();
        
        const btnU = document.getElementById('btn-upgrade');
        const btnT = document.getElementById('btn-tribulation');
        const hint = document.getElementById('tribulation-hint');
        const title = document.getElementById('next-realm-name');
        const reqT = document.getElementById('req-text');

        if(idx >= 9) {
            title.innerText = "å·²è‡»åŒ–å¢ƒ";
            reqT.innerText = "";
            btnU.classList.add('hidden');
            btnT.classList.add('hidden');
            hint.classList.add('hidden');
            return;
        }

        let nextNameStr = "";
        if(layer < 9) {
            nextNameStr = `${major.name} ${layer+1}å±‚`;
        } else {
            nextNameStr = CONFIG.MAJOR_REALMS[idx+1].name + " ä¸€å±‚";
        }

        title.innerText = `ä¸‹ä¸€é‡ï¼š${nextNameStr}`;
        reqT.innerText = `æ‰€éœ€çµåŠ›ï¼š${this.fmt(nextReq)}`;

        if(idx === 8 && layer === 9) {
            btnU.classList.add('hidden');
            btnT.classList.remove('hidden');
            hint.classList.remove('hidden');
            
            if(game.data.spirit >= nextReq) {
                btnT.disabled = false;
                btnT.style.opacity = 1;
                btnT.innerText = "é€†å¤©æ”¹å‘½ (å¼€å§‹æ¸¡åŠ«)";
            } else {
                btnT.disabled = true;
                btnT.style.opacity = 0.5;
                btnT.innerText = "çµåŠ›ä¸è¶³";
            }
        } else {
            btnU.classList.remove('hidden');
            btnT.classList.add('hidden');
            hint.classList.add('hidden');

            if(game.data.spirit >= nextReq) {
                btnU.disabled = false;
                btnU.innerText = layer === 9 ? "çªç ´ç“¶é¢ˆ (å¤§å¢ƒç•Œ)" : "çªç ´";
            } else {
                btnU.disabled = true;
                btnU.innerText = "ç§¯æ”’çµåŠ›ä¸­";
            }
        }
    }
    
    checkRedDots() {
        // ç®€åŒ–ï¼šè¿™é‡Œä¸éœ€è¦å®æ—¶é‡ç»˜åˆ—è¡¨ï¼Œåªåœ¨ç‚¹å‡»å‡çº§æ—¶é‡ç»˜
        // ä½†éœ€è¦æ›´æ–°æŒ‰é’®æ˜¯å¦å¯ç‚¹çš„çŠ¶æ€ã€‚ä¸ºäº†ä»£ç ç®€æ´ï¼Œè¿™é‡Œæš‚ä¸å®æ—¶æ“ä½œDOM class
        // ä¸‹æ¬¡ç‚¹å‡»é¢æ¿æˆ–è€…å‡çº§æ—¶ä¼šè‡ªåŠ¨åˆ·æ–°
    }
};

window.onload = game.init.bind(game);
</script>
</body>
</html>
