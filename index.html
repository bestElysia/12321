<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç‰ç’ƒä»™é€”ï¼šæ¶²æ€ä¿®ä»™ v2.0</title>
    <style>
        /* =========================================
           CSS æ ·å¼è¡¨
           ========================================= */
        :root {
            --bg-gradient: linear-gradient(135deg, #1a2a6c 0%, #b21f1f 50%, #fdbb2d 100%);
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.15);
            --text-main: #ffffff;
            --primary-accent: #00d2ff;
            --danger: #ff416c;
            --gold: #f6d365;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            background: var(--bg-gradient);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: var(--text-main);
            font-family: 'PingFang SC', 'Heiti SC', sans-serif;
            overflow: hidden;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* åŠ¨æ€æµåŠ¨èƒŒæ™¯çƒ */
        .blobs { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: 0; pointer-events: none; }
        .blob { position: absolute; border-radius: 50%; filter: blur(60px); opacity: 0.5; animation: float 10s infinite ease-in-out alternate; }
        .blob:nth-child(1) { width: 300px; height: 300px; background: #ff416c; top: -50px; left: -50px; }
        .blob:nth-child(2) { width: 400px; height: 400px; background: #00d2ff; bottom: -100px; right: -50px; animation-duration: 15s; }

        @keyframes float {
            0% { transform: translate(0, 0) scale(1); }
            100% { transform: translate(30px, 50px) scale(1.1); }
        }

        /* ä¸»å®¹å™¨ - ç£¨ç ‚ç»ç’ƒ */
        #app {
            position: relative;
            z-index: 10;
            width: 100%;
            max-width: 500px;
            height: 95vh;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* é¡¶éƒ¨æ  */
        header { padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .player-card h1 { margin: 0; font-size: 1.2rem; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .player-card p { margin: 5px 0 0; font-size: 0.8rem; color: #ccc; }
        .spirit-box { text-align: right; }
        .spirit-val { font-size: 1.5rem; font-weight: bold; font-family: 'Courier New', monospace; color: var(--primary-accent); }

        /* ä¸­é—´ç‚¹å‡»/é•¿æŒ‰åŒº */
        #meditate-area {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }
        
        /* æ¶²æ€çƒ (å¤´åƒ) */
        .liquid-avatar {
            width: 180px; height: 180px;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.9), rgba(255,255,255,0.2));
            box-shadow: inset 0 0 20px rgba(255,255,255,0.6), 0 10px 30px rgba(0,0,0,0.3);
            border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 4rem;
            position: relative;
            animation: morph 6s linear infinite;
            border: 2px solid rgba(255,255,255,0.4);
            transition: transform 0.1s, box-shadow 0.2s;
            z-index: 5;
        }
        
        .liquid-avatar.holding {
            transform: scale(1.15);
            box-shadow: 0 0 60px var(--primary-accent), inset 0 0 30px var(--primary-accent);
            background: radial-gradient(circle at 30% 30%, #fff, #00d2ff);
            animation-duration: 0.5s;
        }

        @keyframes morph {
            0%, 100% { border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%; }
            34% { border-radius: 70% 30% 50% 50% / 30% 30% 70% 70%; }
            67% { border-radius: 100% 60% 60% 100% / 100% 100% 60% 60%; }
        }

        .realm-badge {
            margin-top: 30px;
            padding: 8px 20px;
            background: rgba(0,0,0,0.4);
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.2);
            font-size: 0.9rem;
            letter-spacing: 1px;
            z-index: 5;
        }

        /* é•¿æŒ‰åé¦ˆæ–‡å­— */
        #hold-feedback {
            position: absolute;
            top: 15%; /* åœ¨çƒä¸Šæ–¹ */
            font-size: 2rem;
            font-weight: bold;
            color: var(--gold);
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 6;
            pointer-events: none;
        }
        #hold-feedback.show { opacity: 1; transform: translateY(-10px); }

        /* åº•éƒ¨é¢æ¿ */
        #control-panel {
            height: 45%;
            background: rgba(20, 20, 30, 0.6);
            backdrop-filter: blur(30px);
            border-top: 1px solid rgba(255,255,255,0.15);
            display: flex;
            flex-direction: column;
        }

        .tabs { display: flex; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .tab {
            flex: 1; padding: 15px; text-align: center;
            color: rgba(255,255,255,0.5);
            cursor: pointer; transition: 0.3s;
            font-size: 1rem;
        }
        .tab.active { color: #fff; background: rgba(255,255,255,0.1); font-weight: bold; border-bottom: 2px solid var(--primary-accent); }

        .content-area { flex: 1; overflow-y: auto; padding: 15px; display: none; }
        .content-area.show { display: block; animation: slideUp 0.3s; }
        @keyframes slideUp { from {opacity:0; transform:translateY(10px)} to {opacity:1; transform:translateY(0)} }

        /* åˆ—è¡¨é¡¹ */
        .skill-item {
            background: rgba(255,255,255,0.08);
            margin-bottom: 10px;
            padding: 12px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid transparent;
        }
        .skill-item.maxed {
            border-color: var(--gold);
            background: linear-gradient(90deg, rgba(246, 211, 101, 0.2), rgba(253, 160, 133, 0.2));
        }

        .btn-glass {
            padding: 8px 16px;
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 20px;
            color: #fff;
            cursor: pointer;
            backdrop-filter: blur(4px);
            transition: 0.2s;
        }
        .btn-glass:active { background: rgba(255,255,255,0.4); transform: scale(0.95); }
        .btn-glass:disabled { opacity: 0.4; cursor: not-allowed; }

        /* æ¸¡åŠ«æŒ‰é’® */
        #breakthrough-btn {
            width: 100%; padding: 15px;
            margin-top: 10px;
            background: linear-gradient(90deg, #ff416c, #ff4b2b);
            border: none; border-radius: 12px;
            color: white; font-weight: bold; font-size: 1.1rem;
            box-shadow: 0 4px 15px rgba(255, 65, 108, 0.4);
            display: none;
            animation: pulse 2s infinite;
        }

        /* æ—¥å¿—åŒºåŸŸä¿®å¤ */
        #game-logs {
            font-size: 0.85rem;
            color: #ddd;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            animation: fadeIn 0.3s forwards;
        }
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }

        /* æ¨¡æ€æ¡†é€šç”¨ */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 999;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(15px);
        }
        .modal-box {
            background: rgba(30, 30, 40, 0.95);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
            width: 85%;
            max-width: 400px;
            box-shadow: 0 0 50px rgba(0,0,0,0.6);
        }
        .hidden { display: none !important; }

        /* æ¸¡åŠ«åœºæ™¯ */
        #tribulation-overlay { flex-direction: column; background: radial-gradient(circle, #20002c 0%, #000 100%); }
        .thunder {
            position: absolute; top:0; left:50%; width: 6px; height: 0;
            background: #fff;
            box-shadow: 0 0 30px #fff, 0 0 60px #bd00ff;
            transform: translateX(-50%);
            transition: height 0.05s;
        }
        .log-box {
            width: 90%; height: 250px;
            background: rgba(0,0,0,0.7);
            border-radius: 10px;
            padding: 15px;
            overflow-y: auto;
            text-align: left;
            font-family: monospace;
            font-size: 0.9rem;
            margin-top: 20px;
            border: 1px solid #444;
        }
        .log-line { margin-bottom: 8px; }

        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-2px, 0, 0); } 20%, 80% { transform: translate3d(4px, 0, 0); } }

        /* æµ®åŠ¨æ•°å­— */
        .float-text {
            position: absolute; pointer-events: none;
            color: #fff; font-weight: bold;
            animation: floatUp 0.8s forwards;
            text-shadow: 0 0 5px rgba(0,0,0,0.8);
            font-size: 1.2rem;
            z-index: 100;
        }
        @keyframes floatUp { to { transform: translateY(-100px) scale(1.2); opacity: 0; } }
        .jp-title { color: #f6d365; font-weight: bold; text-shadow: 0 0 5px rgba(246, 211, 101, 0.5); }

    </style>
</head>
<body>

    <div class="blobs">
        <div class="blob"></div>
        <div class="blob"></div>
    </div>

    <div id="app">
        <header>
            <div class="player-card">
                <h1 id="ui-name">é“å‹</h1>
                <p id="ui-title">å‡¡äºº</p>
            </div>
            <div class="spirit-box">
                <div class="spirit-val" id="ui-spirit">0</div>
                <div style="font-size:0.75rem; opacity:0.7">çµæ°”å€¼ (Spirit)</div>
            </div>
        </header>

        <div id="meditate-area">
            <div id="hold-feedback">+0</div>
            <div class="liquid-avatar" id="avatar">ğŸ§˜</div>
            <div class="realm-badge" id="ui-realm">ç‚¼æ°”æœŸ ä¸€å±‚</div>
            <div style="margin-top:10px; font-size:0.8rem; opacity:0.6; animation:pulse 2s infinite">é•¿æŒ‰å±å¹• é²¸åçµæ°”</div>
        </div>

        <div id="control-panel">
            <div class="tabs">
                <div class="tab active" onclick="ui.switchTab('skills')">åŠŸæ³•</div>
                <div class="tab" onclick="ui.switchTab('realm')">å¢ƒç•Œ</div>
                <div class="tab" onclick="ui.switchTab('logs')">æ—¥å¿—</div>
            </div>

            <div id="tab-skills" class="content-area show">
                <div id="skills-list"></div>
            </div>

            <div id="tab-realm" class="content-area" style="text-align: center;">
                <h2 style="margin: 0 0 10px 0; color: var(--gold)">å¢ƒç•Œç“¶é¢ˆ</h2>
                <div id="realm-req-box">
                    <p id="realm-req" style="margin-bottom: 5px; font-size: 1rem; color: #fff;">
                        è·ç¦» [ç»ƒæ°”æœŸ 2å±‚] è¿˜éœ€: 100
                    </p>
                    <div style="width:100%; background:#333; height:6px; border-radius:3px; margin:10px 0; overflow:hidden;">
                        <div id="realm-bar" style="width:0%; height:100%; background:var(--primary-accent); transition:width 0.3s;"></div>
                    </div>
                </div>
                
                <button id="breakthrough-btn" onclick="game.startTribulation()">
                    é€†å¤©æ”¹å‘½ (å¼€å§‹æ¸¡åŠ«)
                </button>
                <div id="trib-info" style="font-size:0.85rem; margin-top:15px; text-align:left; color:#ccc; display:none; background:rgba(0,0,0,0.3); padding:10px; border-radius:8px;">
                    <p style="color:var(--gold)">âš¡ <b>å¤©åŠ«è­¦ç¤ºï¼š</b></p>
                    <p>1. éœ€æ‰¿å— <b style="color:#fff">ä¹é“ç´«å®µç¥é›·</b>ã€‚</p>
                    <p>2. éœ€æ–©ç­ <b style="color:#fff">ä¸€é“åŸŸå¤–å¿ƒé­”</b>ã€‚</p>
                    <p>3. æ»¡çº§åŠŸæ³•è¶Šå¤šï¼ŒæˆåŠŸç‡è¶Šé«˜ (å½“å‰: <span id="success-chance-text">??</span>%)ã€‚</p>
                    <p style="margin-top:5px; color:var(--danger)">âš ï¸ å¤±è´¥åˆ™ä¿®ä¸ºå°½å¤±ï¼Œåªèƒ½è½¬ä¸–ï¼</p>
                </div>
            </div>

            <div id="tab-logs" class="content-area">
                <div id="game-logs"></div>
            </div>
        </div>
    </div>

    <div id="modal-start" class="modal">
        <div class="modal-box">
            <h2 style="color: var(--primary-accent)">è¸å…¥ä»™é€”</h2>
            <p style="color:#aaa; font-size:0.9rem;">å‰ä¸–å°˜ç¼˜å·²æ–­ï¼Œä»Šç”Ÿå¤§é“é‡ä¿®</p>
            <input type="text" id="input-name" placeholder="è¯·è¾“å…¥æ‚¨çš„é“å·" style="padding:12px; border-radius:8px; border:none; width:80%; margin:20px 0; text-align:center; font-size:1.1rem; outline:none;">
            <button class="btn-glass" style="background:var(--primary-accent); width:80%; font-size:1.1rem;" onclick="game.initPlayer()">å¼€å§‹ä¿®ä»™</button>
        </div>
    </div>

    <div id="modal-tribulation" class="modal hidden" style="background: rgba(0,0,0,0.98);">
        <div class="thunder" id="thunder-beam"></div>
        <h1 style="color: #fff; text-shadow: 0 0 20px #bd00ff; font-size:2.5rem;" id="trib-title">å¤©åŠ«é™ä¸´</h1>
        <div class="log-box" id="trib-logs"></div>
    </div>

    <div id="modal-death" class="modal hidden">
        <div class="modal-box" style="border-color: var(--danger);">
            <h1 style="color: var(--danger); font-size:2.5rem;">é™¨ è½</h1>
            <p id="death-msg" style="color:#ddd; margin: 20px 0;">...</p>
            <p style="font-size:0.8rem; color:#888;">ä¿ç•™ 10% çµæ°”ä¸éƒ¨åˆ†åŠŸæ³•æ„Ÿæ‚Ÿ</p>
            <button class="btn-glass" style="margin-top:20px; width:100%; background:var(--danger);" onclick="game.reincarnate()">è½¬ä¸–é‡ä¿®</button>
        </div>
    </div>

<script>
/**
 * ================= é…ç½®æ•°æ® =================
 */
const CONFIG = {
    // å¢ƒç•Œåˆ’åˆ†
    REALMS: [
        { name: "ç‚¼æ°”æœŸ", baseReq: 100 },       // 0
        { name: "ç­‘åŸºæœŸ", baseReq: 5000 },      // 1 
        { name: "é‡‘ä¸¹æœŸ", baseReq: 50000 },     // 2
        { name: "å…ƒå©´æœŸ", baseReq: 500000 },    // 3
        { name: "åŒ–ç¥æœŸ", baseReq: 5000000 },   // 4
        { name: "ç‚¼è™šæœŸ", baseReq: 50000000 },  // 5
        { name: "åˆä½“æœŸ", baseReq: 200000000 }, // 6
        { name: "å¤§ä¹˜æœŸ", baseReq: 1000000000 },// 7
        { name: "æ¸¡åŠ«æœŸ", baseReq: 5000000000 } // 8
    ],
    // åŠŸæ³•åº“
    SKILLS: [
        { id: 1, name: "åŸºç¡€åçº³", cost: 10, bonus: 1, desc: "å‘¼å¸æ³•é—¨" },
        { id: 2, name: "å¼•æ°”è¯€", cost: 100, bonus: 5, desc: "ç‰µå¼•çµæ°”" },
        { id: 3, name: "åšåœŸèº«", cost: 500, bonus: 15, desc: "å¢å¼ºè‚‰èº«" },
        { id: 4, name: "å¾¡é£æœ¯", cost: 2000, bonus: 40, desc: "é‡‡é›†åŠ é€Ÿ" },
        { id: 5, name: "äº”è¡Œéæ³•", cost: 8000, bonus: 100, desc: "æ„Ÿæ‚Ÿå¤©åœ°" },
        { id: 6, name: "ç´«éœ„ç¥é›·", cost: 30000, bonus: 250, desc: "é›·ç”µæ·¬ä½“" },
        { id: 7, name: "å¤ªä¸Šå¿˜æƒ…", cost: 100000, bonus: 600, desc: "å¿ƒå¦‚æ­¢æ°´" },
        { id: 8, name: "æ³•å¤©è±¡åœ°", cost: 500000, bonus: 1500, desc: "åå™¬å¤©åœ°" },
        { id: 9, name: "ä¸€æ°”åŒ–ä¸‰æ¸…", cost: 2000000, bonus: 5000, desc: "åˆ†èº«ä¿®ç‚¼" },
        { id: 10, name: "è¢–é‡Œä¹¾å¤", cost: 10000000, bonus: 12000, desc: "è‡ªæˆä¸–ç•Œ" },
        { id: 11, name: "è¨€å‡ºæ³•éš", cost: 50000000, bonus: 30000, desc: "ä¿®æ”¹æ³•åˆ™" },
        { id: 12, name: "çœŸÂ·åƒåƒåƒ", cost: 100000000, bonus: 80000, desc: "åå™¬å¤§é“" }
    ]
};

/**
 * ================= æ¸¸æˆé€»è¾‘ =================
 */
const game = {
    data: {
        name: "",
        spirit: 0,
        realmIdx: 0,    // å¤§å¢ƒç•Œç´¢å¼•
        subRealm: 1,    // å°å¢ƒç•Œ (1-10å±‚)
        skills: []
    },
    
    // é•¿æŒ‰é€»è¾‘å˜é‡
    isHolding: false,
    holdSessionStart: 0, // æœ¬æ¬¡é•¿æŒ‰å¼€å§‹æ—¶é—´
    holdSessionTotal: 0, // æœ¬æ¬¡é•¿æŒ‰ç´¯è®¡è·å¾—
    animationFrameId: null,

    init() {
        // åˆå§‹åŒ–åŠŸæ³•æ•°æ®
        this.data.skills = CONFIG.SKILLS.map(s => ({...s, level: 0}));
        
        // ç»‘å®šäº‹ä»¶ï¼šå…¼å®¹ç§»åŠ¨ç«¯å’ŒPCç«¯
        const area = document.getElementById('meditate-area');
        
        // å¼€å§‹é•¿æŒ‰
        const startHold = (e) => {
            if(e.cancelable) e.preventDefault();
            if(this.isTribulation) return;
            
            if (!this.isHolding) {
                this.isHolding = true;
                this.holdSessionStart = Date.now();
                this.holdSessionTotal = 0;
                document.getElementById('avatar').classList.add('holding');
                document.getElementById('hold-feedback').classList.add('show');
                this.holdLoop(); // å¯åŠ¨å¾ªç¯
                
                // ç‚¹å‡»ç‰¹æ•ˆ
                this.spawnClickEffect(e);
            }
        };

        // ç»“æŸé•¿æŒ‰ (ç»‘å®šåœ¨ Window ä¸Šé˜²æ­¢æ‹–æ‹½å‡ºåŒºåŸŸåä¸æ¾æ‰‹)
        const endHold = () => {
            if (this.isHolding) {
                this.isHolding = false;
                document.getElementById('avatar').classList.remove('holding');
                document.getElementById('hold-feedback').classList.remove('show');
                cancelAnimationFrame(this.animationFrameId);
            }
        };

        area.addEventListener('mousedown', startHold);
        area.addEventListener('touchstart', startHold, {passive: false});
        
        window.addEventListener('mouseup', endHold);
        window.addEventListener('touchend', endHold);
        
        ui.update();
    },

    initPlayer() {
        const name = document.getElementById('input-name').value.trim();
        if(!name) return alert("è¯·è¾“å…¥åå­—");
        this.data.name = name;
        document.getElementById('modal-start').classList.add('hidden');
        ui.log(`<b>${name}</b> è¸å…¥ä¿®ä»™ç•Œï¼Œå¤§é“äº‰é”‹ï¼Œå§‹äºè¶³ä¸‹ã€‚`, '#f6d365');
        ui.update();
    },

    // æ ¸å¿ƒå¾ªç¯ï¼šå¤„ç†é•¿æŒ‰æ”¶ç›Š
    holdLoop() {
        if (!this.isHolding) return;

        // è®¡ç®—å½“å‰å¸§çš„æ”¶ç›Š
        const now = Date.now();
        const durationSeconds = (now - this.holdSessionStart) / 1000;
        
        // åŸºç¡€äº§å‡º
        const basePower = this.calculateClickPower();
        
        // æŒ‡æ•°å€ç‡ï¼šæ¯ç§’å¢åŠ å€ç‡ï¼Œä¸Šé™ 50 å€
        // Math.max(1, ...) ä¿è¯è‡³å°‘æœ‰1å€
        let multiplier = 1 + Math.pow(durationSeconds, 1.5); 
        if(multiplier > 50) multiplier = 50;

        // æ¯å¸§æ”¶ç›Š (å‡è®¾60FPSï¼Œæ‰€ä»¥é™¤ä»¥60)
        let gain = (basePower * multiplier) / 60;
        
        // ç¡®ä¿æœ€å°æ”¶ç›Šï¼Œé˜²æ­¢æµ®ç‚¹æ•°å¤ªå°ä¸æ˜¾ç¤º
        if (gain < 0.1) gain = 0.1;

        // å¢åŠ çµæ°”
        this.data.spirit += gain;
        this.holdSessionTotal += gain;

        // æ›´æ–° UI
        ui.updateSpirit();
        ui.updateHoldFeedback(this.holdSessionTotal);

        // éšæœºäº§ç”Ÿæµ®åŠ¨æ–‡å­— (é™ä½é¢‘ç‡ï¼Œé¿å…å¡é¡¿)
        if (Math.random() > 0.92) {
            this.spawnFloatingText(Math.floor(gain * 10)); // æ˜¾ç¤ºå¤§æ¦‚çš„ç¬é—´å€¼
        }

        this.animationFrameId = requestAnimationFrame(() => this.holdLoop());
    },

    // è®¡ç®—å•æ¬¡ç‚¹å‡»/åŸºç¡€äº§å‡º
    calculateClickPower() {
        let base = 1;
        // å¢ƒç•ŒåŠ æˆ (2^(å¤§å¢ƒç•Œ + å°å¢ƒç•Œ/10))
        base = base * Math.pow(2, this.data.realmIdx + (this.data.subRealm/10));
        
        // åŠŸæ³•åŠ æˆ
        this.data.skills.forEach(s => {
            let sBonus = s.level * s.bonus;
            if(s.level >= 100) sBonus *= 2; // æ»¡çº§æ•ˆæœç¿»å€
            base += sBonus;
        });
        return base;
    },

    // ç”Ÿæˆç‚¹å‡»ç‰¹æ•ˆ
    spawnClickEffect(e) {
        let x, y;
        if(e.type === 'touchstart' && e.touches[0]) {
            x = e.touches[0].clientX;
            y = e.touches[0].clientY;
        } else {
            x = e.clientX;
            y = e.clientY;
        }
        
        // å¦‚æœä½ç½®è·å–å¤±è´¥ï¼ˆå¦‚å…¨å±€mouseupï¼‰ï¼Œç”¨ä¸­å¿ƒç‚¹
        if (!x || !y) {
            const rect = document.getElementById('avatar').getBoundingClientRect();
            x = rect.left + rect.width / 2;
            y = rect.top;
        }
        
        this.spawnFloatingText(this.calculateClickPower(), x, y);
    },

    spawnFloatingText(num, x, y) {
        if (!x || !y) {
            const rect = document.getElementById('avatar').getBoundingClientRect();
            x = rect.left + rect.width / 2 + (Math.random()*40-20);
            y = rect.top + (Math.random()*40-20);
        }
        
        const el = document.createElement('div');
        el.className = 'float-text';
        el.style.left = x + 'px';
        el.style.top = y + 'px';
        el.innerText = '+' + ui.formatNum(num);
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 800);
    },

    upgradeSkill(id) {
        const skill = this.data.skills.find(s => s.id === id);
        if(!skill || skill.level >= 100) return;
        
        const cost = Math.floor(skill.cost * Math.pow(1.15, skill.level));
        
        if(this.data.spirit >= cost) {
            this.data.spirit -= cost;
            skill.level++;
            ui.update();
            if(skill.level === 100) {
                ui.log(`åŠŸæ³• [${skill.name}] å·²è‡³åœ†æ»¡ï¼`, '#f6d365');
            }
        }
    },

    // æ£€æŸ¥å‡çº§çŠ¶æ€
    checkUpgrade() {
        const realmCfg = CONFIG.REALMS[this.data.realmIdx];
        // æ¯ä¸€å±‚éœ€è¦çš„çµæ°”æŒ‡æ•°å¢é•¿
        const nextReq = realmCfg.baseReq * Math.pow(2.2, this.data.subRealm);
        
        // æ˜¯å¦åˆ°è¾¾å¤§åœ†æ»¡ (ç¬¬10å±‚)
        const isBottleneck = this.data.subRealm >= 10;

        return {
            canUpgrade: this.data.spirit >= nextReq,
            req: nextReq,
            isBottleneck: isBottleneck,
            nextRealmName: isBottleneck ? "???" : `${realmCfg.name} ${this.data.subRealm + 1}å±‚`
        };
    },

    // æ¸¡åŠ«é€»è¾‘
    isTribulation: false,
    async startTribulation() {
        const status = this.checkUpgrade();
        if(!status.canUpgrade || !status.isBottleneck) return;

        this.data.spirit -= status.req;
        this.isTribulation = true;

        const modal = document.getElementById('modal-tribulation');
        const logBox = document.getElementById('trib-logs');
        const thunder = document.getElementById('thunder-beam');
        
        modal.classList.remove('hidden');
        logBox.innerHTML = '';
        
        // æˆåŠŸç‡è®¡ç®—ï¼šåŸºç¡€ 70% + (æ»¡çº§åŠŸæ³•æ•° * 2.5%)
        const maxedCount = this.data.skills.filter(s => s.level >= 100).length;
        let successRate = 0.7 + (maxedCount * 0.025);
        if(successRate > 1) successRate = 1;

        let survive = true;

        // 10è½®åˆ¤å®š
        for(let i=1; i<=10; i++) {
            await this.wait(1200);
            
            let isHeartDemon = (i === 10);
            let msg = "";
            let color = "";

            if(!isHeartDemon) {
                // å¤©é›·ç‰¹æ•ˆ
                thunder.style.height = "100%";
                thunder.style.opacity = "1";
                document.body.classList.add('shake');
                setTimeout(() => {
                    thunder.style.height = "0";
                    document.body.classList.remove('shake');
                }, 100);

                if(Math.random() > successRate) {
                    survive = false;
                    msg = `âŒ ç¬¬ ${i} é“å¤©é›·å‡»ç©¿äº†ä½ çš„æŠ¤ç›¾ï¼`;
                    color = "#ff416c";
                } else {
                    msg = `ğŸ›¡ï¸ ç¬¬ ${i} é“å¤©é›·è½ä¸‹ï¼Œä½ å®‰ç„¶æ— æ™ã€‚`;
                    color = "#00d2ff";
                }
            } else {
                // å¿ƒé­”
                msg = "ğŸ‘¹ åŸŸå¤–å¿ƒé­”è¢­æ¥...";
                this.appendTribLog(msg, "#f6d365");
                await this.wait(1500);
                
                if(survive && Math.random() <= successRate) {
                    msg = "âœ¨ ä½ é“å¿ƒç¨³å›ºï¼Œä¸€å‰‘æ–©ç­å¿ƒé­”ï¼";
                    color = "#00d2ff";
                } else {
                    survive = false;
                    msg = "â˜ ï¸ ä½ è¢«å¿ƒé­”åå™¬ï¼Œèµ°ç«å…¥é­”...";
                    color = "#ff416c";
                }
            }

            this.appendTribLog(msg, color);
            if(!survive) break;
        }

        await this.wait(2000);
        modal.classList.add('hidden');
        this.isTribulation = false;

        if(survive) {
            this.successBreakthrough();
        } else {
            this.failBreakthrough();
        }
    },

    appendTribLog(text, color) {
        const div = document.createElement('div');
        div.style.color = color;
        div.style.marginBottom = '8px';
        div.innerText = text;
        const box = document.getElementById('trib-logs');
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    },

    successBreakthrough() {
        this.data.realmIdx++;
        this.data.subRealm = 1;
        const newRealmName = CONFIG.REALMS[this.data.realmIdx].name;
        alert(`æ¸¡åŠ«æˆåŠŸï¼æ™‹å‡ ${newRealmName}ï¼`);
        ui.log(`=================`, '#f6d365');
        ui.log(`é€†å¤©æ”¹å‘½æˆåŠŸï¼æ™‹å‡ [${newRealmName}]`, '#f6d365');
        ui.update();
    },

    failBreakthrough() {
        document.getElementById('modal-death').classList.remove('hidden');
        document.getElementById('death-msg').innerText = `ä¿®ä¸ºæ­¢æ­¥äº ${CONFIG.REALMS[this.data.realmIdx].name} åœ†æ»¡`;
    },

    reincarnate() {
        this.data.spirit = Math.floor(this.data.spirit * 0.1);
        this.data.realmIdx = 0;
        this.data.subRealm = 1;
        this.data.skills.forEach(s => s.level = Math.floor(s.level / 2));
        
        document.getElementById('modal-death').classList.add('hidden');
        ui.log("è½®å›è½¬ä¸–ï¼Œå†è¸ä»™é€”...", "#bd00ff");
        ui.update();
    },

    wait(ms) { return new Promise(r => setTimeout(r, ms)); }
};

/**
 * ================= ç•Œé¢æ§åˆ¶ =================
 */
const ui = {
    update() {
        this.updateSpirit();
        document.getElementById('ui-name').innerText = game.data.name || "é“å‹";
        
        // å¢ƒç•Œæ˜¾ç¤º
        const rCfg = CONFIG.REALMS[game.data.realmIdx];
        const rName = `${rCfg.name} ${game.data.subRealm}å±‚${game.data.subRealm>=10 ? '(åœ†æ»¡)' : ''}`;
        document.getElementById('ui-realm').innerText = rName;
        document.getElementById('ui-title').innerText = rCfg.name + "ä¿®å£«";

        // å¢ƒç•Œçªç ´é€»è¾‘ä¼˜åŒ–
        const status = game.checkUpgrade();
        const btn = document.getElementById('breakthrough-btn');
        const reqText = document.getElementById('realm-req');
        const info = document.getElementById('trib-info');
        const bar = document.getElementById('realm-bar');

        // è¿›åº¦æ¡è®¡ç®—
        let progress = Math.min(100, (game.data.spirit / status.req) * 100);
        bar.style.width = progress + "%";

        if (status.isBottleneck) {
            // åˆ°è¾¾ç“¶é¢ˆ (åœ†æ»¡)
            reqText.innerText = `å¢ƒç•Œåœ†æ»¡ï¼Œéœ€æ¸¡åŠ«çªç ´ï¼`;
            reqText.style.color = '#f6d365';
            
            // æ˜¾ç¤ºæˆåŠŸç‡æç¤º
            const maxedCount = game.data.skills.filter(s => s.level >= 100).length;
            const successRate = Math.min(100, Math.floor((0.7 + (maxedCount * 0.025)) * 100));
            document.getElementById('success-chance-text').innerText = successRate > 70 ? successRate : "??";

            if (status.canUpgrade) {
                btn.style.display = 'block';
                info.style.display = 'block';
            } else {
                btn.style.display = 'none';
                info.style.display = 'none';
                reqText.innerText += ` (çµæ°”ä¸è¶³ ${this.formatNum(status.req)})`;
            }
        } else {
            // è‡ªåŠ¨å‡çº§é€»è¾‘ (éç“¶é¢ˆ)
            if (status.canUpgrade) {
                game.data.spirit -= status.req;
                game.data.subRealm++;
                this.log(`çªç ´è‡³ ${rCfg.name} ${game.data.subRealm}å±‚`, '#00d2ff');
                this.update(); // é€’å½’æ›´æ–°
                return;
            }
            // æ˜¾ç¤ºä¸‹ä¸€å±‚è·ç¦»
            btn.style.display = 'none';
            info.style.display = 'none';
            reqText.innerHTML = `è·ç¦» [<span style="color:#00d2ff">${status.nextRealmName}</span>] è¿˜éœ€: ${this.formatNum(status.req - game.data.spirit)}`;
            reqText.style.color = '#fff';
        }

        this.renderSkills();
    },

    updateSpirit() {
        document.getElementById('ui-spirit').innerText = this.formatNum(game.data.spirit);
    },

    updateHoldFeedback(num) {
        document.getElementById('hold-feedback').innerText = '+' + this.formatNum(num);
    },

    renderSkills() {
        const list = document.getElementById('skills-list');
        list.innerHTML = "";
        
        game.data.skills.forEach(s => {
            const cost = Math.floor(s.cost * Math.pow(1.15, s.level));
            const isMax = s.level >= 100;
            const canBuy = game.data.spirit >= cost && !isMax;
            
            let nameHtml = s.name;
            if(isMax) nameHtml = `<span class="jp-title">æå“Â·${s.name}</span> <span style="font-size:0.6rem; background:#f6d365; color:black; padding:1px 3px; border-radius:3px;">MAX</span>`;

            const div = document.createElement('div');
            div.className = `skill-item ${isMax ? 'maxed' : ''}`;
            div.innerHTML = `
                <div style="flex:1">
                    <div style="font-weight:bold; color:${isMax?'#f6d365':'#fff'}">${nameHtml}</div>
                    <div style="font-size:0.75rem; color:#aaa; margin-top:3px;">Lv.${s.level} | ${s.desc}</div>
                </div>
                <button class="btn-glass" ${canBuy ? '' : 'disabled'} onclick="game.upgradeSkill(${s.id})">
                    ${isMax ? 'åœ†æ»¡' : 'å‡ ' + this.formatNum(cost)}
                </button>
            `;
            list.appendChild(div);
        });
    },

    log(msg, color) {
        const box = document.getElementById('game-logs');
        const p = document.createElement('div');
        p.className = 'log-entry';
        p.style.color = color || '#ccc';
        p.innerHTML = `<span style="opacity:0.5">[${new Date().toLocaleTimeString()}]</span> ${msg}`;
        
        // æ’å…¥åˆ°æœ€å‰é¢
        box.prepend(p);
        
        // é™åˆ¶æ—¥å¿—æ•°é‡
        if(box.children.length > 30) box.lastChild.remove();
    },

    switchTab(t) {
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.content-area').forEach(el => el.classList.remove('show'));
        
        // Find the clicked element or default to the correct tab logic
        // This relies on the onclick passing the ID string
        const clickedTab = Array.from(document.querySelectorAll('.tab')).find(el => el.getAttribute('onclick').includes(t));
        if(clickedTab) clickedTab.classList.add('active');
        
        document.getElementById('tab-'+t).classList.add('show');
    },

    formatNum(n) {
        if(n < 10000) return Math.floor(n);
        if(n < 100000000) return (n/10000).toFixed(1) + 'ä¸‡';
        return (n/100000000).toFixed(2) + 'äº¿';
    }
};

// å¯åŠ¨
window.onload = () => game.init();

</script>
</body>
</html>
